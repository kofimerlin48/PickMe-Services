<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fashion Boutiques - PickMe Services</title>

  <!-- Optional: micro-optimizations for faster connections (no UI impact) -->
  <link rel="preconnect" href="https://script.google.com" />
  <link rel="preconnect" href="https://googleusercontent.com" />
  <link rel="dns-prefetch" href="https://script.google.com" />
  <link rel="dns-prefetch" href="https://googleusercontent.com" />

  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background-color: #f9f9f9;
      padding-top: 100px;
    }
    .page-header { text-align: center; margin-bottom: 20px; }
    .page-header h1 { color: #c12872; margin: 0; font-size: 28px; }
    .page-header p { color: #000; margin-top: 5px; font-size: 16px; font-weight: bold; }
    .search-bar { display: flex; justify-content: center; margin-bottom: 20px; }
    .search-bar input {
      width: 80%; max-width: 400px; padding: 10px 15px; border-radius: 8px;
      border: 1px solid #ccc; font-size: 16px; transition: border-color 0.3s;
    }
    .search-bar input:focus { border-color: #c12872; outline: none; }

    .cards-container {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 70px; padding: 0 20px 50px 20px;
    }
    .card {
      position: relative; border-radius: 15px; overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1); background-size: cover;
      background-position: center; height: 250px; display: flex;
      align-items: flex-end; transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }
    .card::before {
      content: ""; position: absolute; inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
    }
    .card-content {
      position: relative; color: white; padding: 15px; width: 100%;
      display: flex; flex-direction: column; justify-content: space-between; z-index: 1;
    }
    .card-title { font-weight: bold; font-size: 24px; margin-bottom: 10px; }
    .card-description { font-size: 14px; margin-bottom: 10px; flex-grow: 1; }
    .btn-order {
      background-color: #c12872; color: white; border: none; padding: 8px 12px;
      border-radius: 8px; cursor: pointer; font-size: 14px; text-align: center;
      align-self: flex-end; transition: background 0.2s, transform 0.2s;
    }
    .btn-order:hover,
    .btn-order:focus,
    .btn-order:active { transform: scale(1.05); outline: none !important; }

    .skeleton {
      background: #ddd; border-radius: 15px; height: 250px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { background-color: #eee; }
      50% { background-color: #ddd; }
      100% { background-color: #eee; }
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <div class="page-header">
    <h1></h1>
    <p>Discover the latest trends from top boutiques near you</p>
  </div>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search boutiques...">
  </div>
  <div class="cards-container" id="cardsContainer">
    <div class="skeleton"></div>
    <div class="skeleton"></div>
    <div class="skeleton"></div>
  </div>
  <div style="position:fixed; bottom:0; width:100%; z-index:9999;">
    <iframe src="footer.html" style="width:100%; height:60px; border:none; overflow:hidden;" scrolling="no"></iframe>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw2mUaCeMBmigDcy7mPnIzpjTq4Ck6qrI7vfp9vsWetfsPT_jsjXuO6vsoe_Ty1mhWQ/exec";

    // Caching + live update config
    const CACHE_KEY = "boutiquesCache:v2";
    const CACHE_TIME_KEY = "boutiquesCacheTime:v2";
    const CACHE_TTL = 60 * 60 * 1000; // 1 hour
    const POLL_INTERVAL_MS = 15000;    // 15s live updates while on page

    // In-memory state for diffing/patching
    const cardsContainer = document.getElementById("cardsContainer");
    const searchInput = document.getElementById("searchInput");
    const boutiqueMap = new Map(); // id -> boutique object
    const domMap = new Map();      // id -> {el, hash}

    // Helper: stable hash to know if a card needs updating
    function hashBoutique(b) {
      // Hash only fields that affect the card UI
      const s = JSON.stringify({
        id: b.id, name: b.name, slogan: b.slogan,
        themeColor: b.themeColor, backgroundImage: b.backgroundImage,
        expiry: b.expiry
      });
      // djb2 hash
      let h = 5381;
      for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i);
      return (h >>> 0).toString(36);
    }

    function isActive(b) {
      if (!b || !b.expiry) return true; // if no expiry, show
      const d = new Date(b.expiry + "T23:59:59");
      return isFinite(d.getTime()) ? (d > new Date()) : true;
    }

    function applySearchFilter() {
      const q = (searchInput.value || "").toLowerCase();
      domMap.forEach(({el}) => {
        const nm = (el.getAttribute("data-name") || "").toLowerCase();
        el.style.display = nm.includes(q) ? "flex" : "none";
      });
    }

    // Create/Update a single card in place
    function upsertCard(b) {
      if (!isActive(b)) {
        // If expired and exists in DOM, remove
        const prev = domMap.get(b.id);
        if (prev) {
          prev.el.remove();
          domMap.delete(b.id);
          boutiqueMap.delete(b.id);
        }
        return;
      }

      const newHash = hashBoutique(b);
      const prev = domMap.get(b.id);

      if (prev && prev.hash === newHash) {
        // No visual changes needed
        boutiqueMap.set(b.id, b);
        return;
      }

      // Build or update DOM
      let card = prev?.el;
      if (!card) {
        card = document.createElement("div");
        card.className = "card";
        card.setAttribute("data-id", b.id);
        card.addEventListener("click", (e) => {
          // Clicks inside button should navigate; card itself does nothing special
        });
        cardsContainer.appendChild(card);
      }

      card.setAttribute("data-name", b.name || "");
      card.style.backgroundImage = `url('${b.backgroundImage || ""}')`;
      card.innerHTML = `
        <div class="card-content">
          <div>
            <div class="card-title">${b.name || ""}</div>
            <div class="card-description">${b.slogan || ""}</div>
          </div>
          <button class="btn-order" style="background-color:${b.themeColor || "#c12872"}">Shop from Us</button>
        </div>
      `;

      // Button navigation (unchanged)
      const btn = card.querySelector(".btn-order");
      btn.onclick = (e) => {
        e.stopPropagation();
        window.location.href = \`template.html?id=\${b.id}\`;
      };

      // Save mapping
      domMap.set(b.id, { el: card, hash: newHash });
      boutiqueMap.set(b.id, b);
    }

    function removeCardsNotIn(newIdsSet) {
      // Remove any DOM cards whose id is not in latest data
      const toDelete = [];
      domMap.forEach((_v, id) => { if (!newIdsSet.has(id)) toDelete.push(id); });
      toDelete.forEach(id => {
        const entry = domMap.get(id);
        if (entry) entry.el.remove();
        domMap.delete(id);
        boutiqueMap.delete(id);
      });
    }

    // Full render/patch from a list
    function patchCards(boutiques) {
      if (!Array.isArray(boutiques)) return;
      const idSet = new Set();
      const frag = document.createDocumentFragment();

      // Build/update in memory, append new ones to a fragment (reflow minimal)
      boutiques.forEach(b => {
        if (!b || !b.id) return;
        idSet.add(b.id);

        const existed = domMap.get(b.id);
        upsertCard(b);

        // If it's brand new (didn't exist before), move it under a fragment
        if (!existed) {
          const { el } = domMap.get(b.id);
          frag.appendChild(el);
        }
      });

      // Append new cards in batch
      if (frag.childNodes.length) {
        cardsContainer.appendChild(frag);
      }

      // Remove cards that disappeared
      removeCardsNotIn(idSet);

      // Keep current search filter
      applySearchFilter();
    }

    // Cache helpers
    function saveCache(payload) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
        localStorage.setItem(CACHE_TIME_KEY, String(Date.now()));
      } catch(e) {}
    }

    function loadCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e) {
        return null;
      }
    }

    function cacheIsFresh() {
      const t = parseInt(localStorage.getItem(CACHE_TIME_KEY) || "0", 10);
      return (Date.now() - t) < CACHE_TTL;
    }

    async function fetchFresh() {
      const res = await fetch(`${WEB_APP_URL}?action=getBoutiques&ts=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) throw new Error("Network error");
      return res.json();
    }

    async function initialLoad() {
      const cached = loadCache();
      let usedCache = false;

      if (cached && cached.boutiques && cached.boutiques.length) {
        // Show cached instantly if not too old
        if (cacheIsFresh()) {
          cardsContainer.innerHTML = ""; // clear skeletons
          patchCards(cached.boutiques);
          usedCache = true;
        }
      }

      if (!usedCache) {
        // Keep skeletons until fresh arrives
        try {
          const data = await fetchFresh();
          cardsContainer.innerHTML = "";
          patchCards(data.boutiques || []);
          saveCache(data);
        } catch (err) {
          console.error("Fetch failed:", err);
          if (cached && cached.boutiques) {
            cardsContainer.innerHTML = "";
            patchCards(cached.boutiques);
          } else {
            cardsContainer.innerHTML = "<p>Failed to load boutiques.</p>";
          }
        }
      } else {
        // We used cache — now update in background
        try {
          const data = await fetchFresh();
          patchCards(data.boutiques || []);
          saveCache(data);
        } catch (err) {
          console.warn("Background refresh failed:", err);
        }
      }
    }

    async function pollUpdates() {
      try {
        const data = await fetchFresh(); // fetch full list; patch only diffs
        patchCards(data.boutiques || []);
        saveCache(data);
      } catch (err) {
        // Don’t spam errors; quiet fail is fine for polling
      }
    }

    // Search (debounced)
    function debounce(fn, ms) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    // Init
    initialLoad().then(() => {
      // Live updates while staying on the page
      setInterval(pollUpdates, POLL_INTERVAL_MS);
      window.addEventListener("focus", pollUpdates);
    });

    searchInput.addEventListener("input", debounce(applySearchFilter, 200));
  </script>
</body>
</html>

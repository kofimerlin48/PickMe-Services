<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fashion</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="/PickMe-Services/manifest.json">
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background-color: #f9f9f9;
      padding-top: 100px;
    }
    .page-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .page-header h1 {
      color: #c12872;
      margin: 0;
      font-size: 28px;
    }
    .page-header p {
      color: #000;
      margin-top: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .search-bar input {
      width: 80%;
      max-width: 400px;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .search-bar input:focus {
      border-color: #c12872;
      outline: none;
    }
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 70px;
      padding: 0 20px 80px;
    }
    .card {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      background-size: cover;
      background-position: center;
      height: 250px;
      display: flex;
      align-items: flex-end;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
    }
    .card-content {
      position: relative;
      color: white;
      padding: 15px;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      z-index: 1;
    }
    .card-title {
      font-weight: bold;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .card-description {
      font-size: 14px;
      margin-bottom: 10px;
      flex-grow: 1;
    }
    .btn-order {
      background-color: #c12872;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      align-self: flex-end;
      transition: background 0.2s, transform 0.2s;
    }
    .btn-order:hover,
    .btn-order:focus,
    .btn-order:active {
      transform: scale(1.05);
      outline: none !important;
    }
    .like-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.8);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      z-index: 2;
    }
    .like-btn.liked {
      color: #c12872;
    }
    .error-message {
      text-align: center;
      color: red;
      font-size: 16px;
      margin: 20px;
    }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  <div class="page-header">
    <h1>Fashion</h1>
    <p>Discover the latest trends from top boutiques near you</p>
  </div>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search boutiques...">
  </div>
  <div class="cards-container" id="cardsContainer"></div>
  <div style="position:fixed; bottom:0; width:100%; z-index:9999;">
    <iframe src="/PickMe-Services/footer.html" style="width:100%; height:60px; border:none; overflow:hidden;" scrolling="no"></iframe>
  </div>
  <script>
    (async () => {
      try {
        const response = await fetch('/PickMe-Services/header.html');
        if (!response.ok) throw new Error(`Failed to load header: ${response.status}`);
        let html = await response.text();
        const pageTitle = "Fashion";
        html = html.replace(/<h1[^>]*>.*?</h1>/i, `<h1 style="margin:0; font-weight:bold; color:#c12872; font-size:24px; position:absolute; left:50%; transform:translateX(-50%);">${pageTitle}</h1>`);
        document.getElementById('header-placeholder').innerHTML = html;
        document.querySelectorAll('#header-placeholder script').forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          document.body.appendChild(newScript);
        });
      } catch (err) {
        console.error('Error loading header:', err);
        document.getElementById('header-placeholder').innerHTML = '<div class="error-message">Failed to load header</div>';
      }
    })();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/PickMe-Services/sw.js')
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.error('Service Worker Error:', err));
      });
    }

    const API_KEY = 'AIzaSyA5_R3XwY4Ve5B-XVApdFKdugRgiSrvlGI';
    const SHEET_ID = '1ayxN99SBYkFP7SByEmNK8MSwYAE9teWIHFtK_dAKiwU';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby-fRmSlH2V7LDXWXX_D_yr8x-ASpSSO2MQoBYH_n098uUmmIWdwdOWw0Ewi63a-Jnc3w/exec';
    let boutiques = [];
    let likedBoutiques = JSON.parse(localStorage.getItem('likedBoutiques')) || [];

    async function fetchBoutiques() {
      try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Boutiques!A2:J?key=${API_KEY}`);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        if (!data.values || !Array.isArray(data.values)) {
          throw new Error('No valid data found in the Google Sheet');
        }
        boutiques = data.values
          .map(row => ({
            id: row[0] || '',
            name: row[1] || 'Unnamed Boutique',
            slogan: row[2] || 'No slogan provided',
            whatsapp: row[3] || '',
            themeColor: row[4] || '#c12872',
            backgroundImage: row[5] || 'https://via.placeholder.com/300x250',
            expiry: row[7] || '2099-12-31',
            likes: parseInt(row[9]) || 0
          }))
          .filter(b => b.id && b.expiry && new Date(b.expiry + 'T23:59:59') > new Date());
        if (boutiques.length === 0) {
          document.getElementById('cardsContainer').innerHTML = '<p class="error-message">No boutiques available at this time.</p>';
        }
        boutiques.sort((a, b) => b.likes - a.likes);
        console.log('Fetched boutiques:', boutiques);
        renderCards();
      } catch (err) {
        console.error('Error fetching boutiques:', err);
        document.getElementById('cardsContainer').innerHTML = '<p class="error-message">Failed to load boutiques. Please try again later.</p>';
      }
    }

    function renderCards() {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      boutiques.forEach(boutique => {
        const card = document.createElement('div');
        card.classList.add('card');
        card.setAttribute('data-category', 'boutiques');
        card.setAttribute('data-name', boutique.name);
        card.setAttribute('data-expiry', boutique.expiry);
        card.setAttribute('data-link', `/PickMe-Services/template.html?id=${boutique.id}`);
        card.setAttribute('data-theme-color', boutique.themeColor);
        card.style.backgroundImage = `url('${boutique.backgroundImage}')`;
        card.innerHTML = `
          <button class="like-btn${likedBoutiques.includes(boutique.id) ? ' liked' : ''}" data-id="${boutique.id}">
            ${likedBoutiques.includes(boutique.id) ? 'ü©∑' : 'ü§ç'}
          </button>
          <div class="card-content">
            <div>
              <div class="card-title">${boutique.name}</div>
              <div class="card-description">${boutique.slogan}</div>
            </div>
            <button class="btn-order" style="background-color:${boutique.themeColor}">Shop from Us</button>
          </div>
        `;
        container.appendChild(card);
      });
      addCardEventListeners();
    }

    function addCardEventListeners() {
      document.querySelectorAll('.btn-order').forEach(btn => {
        btn.addEventListener('click', () => {
          const card = btn.closest('.card');
          const link = card.getAttribute('data-link');
          if (link) {
            console.log('Navigating to:', link);
            window.location.href = link;
          }
        });
      });
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const isLiked = likedBoutiques.includes(id);
          const delta = isLiked ? -1 : 1;
          likedBoutiques = isLiked ? likedBoutiques.filter(lid => lid !== id) : [...likedBoutiques, id];
          localStorage.setItem('likedBoutiques', JSON.stringify(likedBoutiques));
          btn.classList.toggle('liked');
          btn.innerHTML = isLiked ? 'ü§ç' : 'ü©∑';
          try {
            const response = await fetch(WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ boutiqueId: id, delta })
            });
            if (!response.ok) throw new Error(`Failed to update likes: ${response.status}`);
            const boutique = boutiques.find(b => b.id === id);
            if (boutique) {
              boutique.likes += delta;
              boutiques.sort((a, b) => b.likes - a.likes);
              renderCards();
            }
          } catch (err) {
            console.error('Error updating likes:', err);
            likedBoutiques = isLiked ? [...likedBoutiques, id] : likedBoutiques.filter(lid => lid !== id);
            localStorage.setItem('likedBoutiques', JSON.stringify(likedBoutiques));
            btn.classList.toggle('liked', !isLiked);
            btn.innerHTML = isLiked ? 'ü©∑' : 'ü§ç';
            alert('Failed to update likes. Please try again.');
          }
        });
      });
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', () => {
        const searchValue = searchInput.value.toLowerCase().trim();
        document.querySelectorAll('.cards-container .card').forEach(card => {
          const name = card.getAttribute('data-name').toLowerCase();
          card.style.display = name.includes(searchValue) ? 'flex' : 'none';
        });
      });
    }

    window.addEventListener('load', () => {
      console.log('Page loaded, fetching boutiques...');
      fetchBoutiques();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fashion Boutiques - PickMe Services</title>

  <!-- ========= HEADER CODE STARTS HERE ================== -->
  <div id="header-placeholder"></div>
  <script>
  (async () => {
    try {
      const response = await fetch('header.html');
      let html = await response.text();
      const pageTitle = "Fashion";
      html = html.replace(/<h1[^>]*>.*?<\/h1>/i,
        `<h1 style="margin:0; font-weight:bold; color:#c12872; font-size:24px; position:absolute; left:50%; transform:translateX(-50%);">${pageTitle}</h1>`);
      document.getElementById('header-placeholder').innerHTML = html;
      document.querySelectorAll('#header-placeholder script').forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
      });
    } catch (err) { console.error('Failed to load header:', err); }
  })();
  </script>
  <!-- ========= HEADER CODE ENDS HERE ================== -->

  <style>
    body { margin:0; font-family:'Montserrat',Arial,sans-serif; background:#f9f9f9; padding-top:100px; }
    .page-header { text-align:center; margin-bottom:20px; }
    .page-header h1 { color:#c12872; font-size:28px; margin:0; }
    .page-header p { color:#000; font-size:16px; font-weight:bold; margin-top:5px; }
    .search-bar { display:flex; justify-content:center; margin-bottom:20px; }
    .search-bar input { width:80%; max-width:400px; padding:10px 15px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
    .cards-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:70px; padding:0 20px 50px; }
    .card { position:relative; border-radius:15px; overflow:hidden; height:250px; display:flex; align-items:flex-end; 
            background-size:cover; background-position:center; box-shadow:0 3px 8px rgba(0,0,0,0.1); transition:transform .2s; }
    .card:hover { transform:translateY(-5px); }
    .card::before { content:""; position:absolute; inset:0; background:linear-gradient(to top,rgba(0,0,0,0.8),rgba(0,0,0,0)); }
    .card-content { position:relative; color:#fff; padding:15px; width:100%; display:flex; flex-direction:column; justify-content:space-between; z-index:1; }
    .card-title { font-weight:bold; font-size:24px; margin-bottom:10px; }
    .card-description { font-size:14px; margin-bottom:10px; flex-grow:1; }
    .btn-order { background:#c12872; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; align-self:flex-end; }
    .btn-order:hover { transform:scale(1.05); }
  </style>
</head>
<body>
  <div class="page-header">
    <h1></h1>
    <p>Discover the latest trends from top boutiques near you</p>
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search boutiques...">
  </div>

  <div class="cards-container" id="cardsContainer"></div>

  <div style="position:fixed; bottom:0; width:100%; z-index:9999;">
    <iframe src="footer.html" style="width:100%; height:60px; border:none;" scrolling="no"></iframe>
  </div>

  <!-- ========= FIREBASE + FIRESTORE ========= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7GXJKraVNfXSHG7RDoUDccD98u5JF7F8",
      authDomain: "pickmeservicesonline.firebaseapp.com",
      projectId: "pickmeservicesonline",
      storageBucket: "pickmeservicesonline.firebasestorage.app",
      messagingSenderId: "265031616239",
      appId: "1:265031616239:web:e2ef418704af5595aa7d1a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const container = document.getElementById("cardsContainer");
    const searchInput = document.getElementById("searchInput");

    const CACHE_KEY = "boutiquesCacheBase64";
    const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

    function saveCache(data) {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data }));
    }
    function loadCache() {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (Date.now() - parsed.time > CACHE_TTL) return null;
      return parsed.data;
    }

    async function toDataURL(url) {
      try {
        const res = await fetch(url);
        const blob = await res.blob();
        return await new Promise(resolve => {
          const fr = new FileReader();
          fr.onloadend = () => resolve(fr.result);
          fr.readAsDataURL(blob);
        });
      } catch {
        return url;
      }
    }

    function createCard(b) {
      const card = document.createElement("div");
      card.className = "card";
      card.style.backgroundImage = `url('${b.cachedImage || b.backgroundImage || ""}')`;
      card.setAttribute("data-name", b.name?.toLowerCase() || "");
      card.innerHTML = `
        <div class="card-content">
          <div>
            <div class="card-title">${b.name||""}</div>
            <div class="card-description">${b.slogan||""}</div>
          </div>
          <button class="btn-order" style="background-color:${b.themeColor||"#c12872"}">Shop from Us</button>
        </div>`;
      card.querySelector(".btn-order").onclick = () => {
        window.location.href = \`template.html?id=\${encodeURIComponent(b.id)}\`;
      };
      return card;
    }

    async function renderBoutiques(list) {
      container.innerHTML = "";
      list.forEach(b => container.appendChild(createCard(b)));
    }

    async function fetchAndUpdate() {
      const snap = await getDocs(collection(db, "Boutiques"));
      const list = [];
      for (const doc of snap.docs) {
        const d = doc.data();
        let cachedImage = d.backgroundImage;
        // Convert to base64 in background
        if (d.backgroundImage) {
          toDataURL(d.backgroundImage).then(base64 => {
            d.cachedImage = base64;
            // Save updated cache silently
            const current = loadCache() || [];
            const updated = current.map(x => x.id === doc.id ? { ...x, cachedImage: base64 } : x);
            saveCache(updated);
          });
        }
        list.push({ id: doc.id, ...d, cachedImage });
      }
      saveCache(list);
      renderBoutiques(list);
    }

    async function loadBoutiques() {
      const cached = loadCache();
      if (cached) {
        renderBoutiques(cached); // show instantly
      }
      // always fetch fresh in background
      fetchAndUpdate().catch(err => console.error("Fetch failed:", err));
    }

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      Array.from(container.children).forEach(card => {
        const n = card.getAttribute("data-name") || "";
        card.style.display = n.includes(q) ? "flex" : "none";
      });
    });

    window.addEventListener("DOMContentLoaded", loadBoutiques);
  </script>
</body>
</html>

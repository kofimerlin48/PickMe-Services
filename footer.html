<!-- fota.html (footer.html) - corrected -->
<div id="announcementBar" style="  
  position:sticky;  
  top:0;  
  z-index:9999;  
  width:100%;  
  height:60px;  
  background:transparent;  
  color:#000;  
  font-size:18px;  
  font-weight:600;  
  font-family:'Segoe UI', Roboto, sans-serif;  
  text-align:center;  
  line-height:60px;  
  overflow:hidden;  
  white-space:nowrap;  
  cursor:grab;  
">  
  <div id="announcementWrapper" style="  
    display:inline-block;  
    white-space:nowrap;  
    will-change:transform;  
  ">  
    <span id="announcementContent"></span>  
    <span id="announcementContentClone"></span>  
  </div>  
</div>  

<style>   
.flash-here {  
  color: red;  
  font-weight: bold;  
  text-decoration: underline;  
  animation: flash 1s infinite;  
}  
@keyframes flash {  
  0%, 100% { color: red; }  
  50% { color: blue; }  
}  

#announcementBar,
#announcementBar * {
  -webkit-tap-highlight-color: transparent;
  outline: none !important;
  user-select: none;
}
</style>  

<script>
/* === YOUR ORIGINAL ANNOUNCEMENTS (unchanged) === */
const announcements = [  
  { owner: "PickMe Services", content: "🚖 PickMe Services is now available in Agogo!", phone: "+233534742142", plan: "Monthly", added: "2025-09-01" },  
  { owner: "PickMe Services", content: "🛍️ Shop from your favorite vendors — Fast & Easy!", phone: "+233534742142", plan: "Quarterly", added: "2025-08-15" },  
  { owner: "PickMe Services", content: "🏨 Book hotels, Guesthouses, Airbnb, Hostel rent, Store rent & House rent directly on PickMe Services!", phone: "+233534742142", plan: "Semi-Annual", added: "2025-07-01" },  
  { owner: "WOO ENTERTAINMENT", content: "✨ WOO ENTERTAINMENT is bringing to you the AGOGO NA ME FRI Season 26. Watch Out!!!", phone: "+233534742142", expiry: "2025-09-20" },  
  { owner: "Manko Pub", content: "🎤 KWAKU FLICK is repping live at Manko Pub on 5th September, 2025. Don't miss it.", phone: "+233534742142", plan: "Annual", added: "2025-01-01" },  
  { owner: "New Promo", content: "🔥 Big promo ongoing, don’t miss out!", phone: "+233534742142", plan: "Monthly", added: "2025-08-10" },  
  { owner: "Extra 1", content: "📢 This is a test announcement number 7", phone: "+233534742142" },  
  { owner: "Extra 2", content: "📢 Another message number 8", phone: "+233534742142" }  
];

/* expiry logic & shuffle (unchanged) */
function getExpiryDate(item) {  
  if (item.expiry) return new Date(item.expiry);  
  if (!item.plan || !item.added) return null;  
  const addedDate = new Date(item.added);  
  switch (item.plan.toLowerCase()) {  
    case "monthly": addedDate.setMonth(addedDate.getMonth() + 1); break;  
    case "quarterly": addedDate.setMonth(addedDate.getMonth() + 3); break;  
    case "semi-annual":  
    case "semi-annually": addedDate.setMonth(addedDate.getMonth() + 6); break;  
    case "annual":  
    case "annually": addedDate.setFullYear(addedDate.getFullYear() + 1); break;  
  }  
  return addedDate;  
}

const today = new Date();  
let activeAnnouncements = announcements.filter(a => {  
  const expiryDate = getExpiryDate(a);  
  return !expiryDate || today <= expiryDate;  
});

activeAnnouncements = activeAnnouncements  
  .map(a => ({ a, r: Math.random() }))  
  .sort((x, y) => x.r - y.r)  
  .map(({ a }) => a);

function buildFinalList(arr) {  
  const result = [];  
  let count = 0;  
  for (let i = 0; i < arr.length; i++) {  
    result.push({ text: arr[i].content, owner: arr[i].owner, phone: arr[i].phone });  
    count++;  
    if (count === 5) {  
      result.push({ text: "📢 Want to advertise? Click HERE to add your announcement", href: "homepage.html", isFlash: true });  
      count = 0;  
    }  
  }  
  if (count > 0) {  
    result.push({ text: "📢 Want to advertise? Click HERE to add your announcement", href: "homepage.html", isFlash: true });  
  }  
  return result;  
}

const finalList = buildFinalList(activeAnnouncements);  
const contentEl = document.getElementById("announcementContent");  
const cloneEl = document.getElementById("announcementContentClone");  
const separator = " &nbsp;&nbsp; • &nbsp;&nbsp; ";

/* Render: keep phone announcements as clickable spans (open WhatsApp), but
   render the "isFlash/href" item as a real <a target="_top"> link (strong fallback). */
function renderAnnouncements(list, el) {  
  el.innerHTML = list.map(item => {  
    if (item.isFlash) {
      // Render as an anchor with target _top. This is the most reliable default behavior
      // for breaking out of iframes in normal cases.
      return `<a class="clickable-announcement flash-here" href="${item.href}" target="_top" rel="noopener noreferrer" style="cursor:pointer;">${item.text}</a>`;
    } else if (item.owner && item.phone) {  
      // keep as span so we can open WhatsApp in a new tab (preserve existing behavior)
      return `<span class="clickable-announcement" data-owner="${item.owner}" data-content="${item.text}" data-phone="${item.phone}" style="cursor:pointer;">${item.text}</span>`;  
    } else {  
      return item.text;  
    }  
  }).join(separator) + separator;  
}

renderAnnouncements(finalList, contentEl);  
renderAnnouncements(finalList, cloneEl);

/* animation / slider (unchanged) */
const wrapper = document.getElementById("announcementWrapper");  
let posX = 0;  
let speed = 1;  
let isDragging = false, startX = 0;  
let contentWidth = contentEl.offsetWidth || 1;

/* recompute width on resize (helpful when loaded in iframe) */
window.addEventListener('resize', () => {
  contentWidth = contentEl.offsetWidth || 1;
});

let dragThreshold = 5; 
let pointerDownX = 0;
let moved = false;

function animate() {  
  if (!isDragging) posX -= speed;  
  if (Math.abs(posX) >= contentWidth) posX = 0;  
  wrapper.style.transform = `translateX(${posX}px)`;  
  requestAnimationFrame(animate);  
}
animate();

/* Drag Support (with tap vs drag detection) */
wrapper.addEventListener("mousedown", e => {
  isDragging = true;
  pointerDownX = e.pageX;
  startX = e.pageX - posX;
  moved = false;
});
wrapper.addEventListener("mousemove", e => {
  if (!isDragging) return;
  posX = e.pageX - startX;
  if (Math.abs(e.pageX - pointerDownX) > dragThreshold) moved = true;
});
wrapper.addEventListener("mouseup", e => isDragging = false);
wrapper.addEventListener("mouseleave", e => isDragging = false);

wrapper.addEventListener("touchstart", e => {
  isDragging = true;
  pointerDownX = e.touches[0].pageX;
  startX = e.touches[0].pageX - posX;
  moved = false;
});
wrapper.addEventListener("touchmove", e => {
  if (!isDragging) return;
  posX = e.touches[0].pageX - startX;
  if (Math.abs(e.touches[0].pageX - pointerDownX) > dragThreshold) moved = true;
});
wrapper.addEventListener("touchend", e => isDragging = false);

/* === Robust navigation helper ===
   Tries several fallbacks (top -> parent -> window.open _top -> anchor trick -> location).
   Logs errors to console for diagnostics if navigation is blocked (e.g. by sandbox).
*/
function breakOutTo(url) {
  // 1) try top
  try {
    if (window.top && window.top !== window) {
      window.top.location.href = url;
      console.info('Navigation: used window.top.location.href');
      return;
    }
  } catch (err) {
    console.warn('Navigation to top blocked:', err);
  }

  // 2) try parent
  try {
    if (window.parent && window.parent !== window) {
      window.parent.location.href = url;
      console.info('Navigation: used window.parent.location.href');
      return;
    }
  } catch (err) {
    console.warn('Navigation to parent blocked:', err);
  }

  // 3) try window.open with _top
  try {
    window.open(url, '_top');
    console.info('Navigation: used window.open(_, "_top")');
    return;
  } catch (err) {
    console.warn('window.open(_top) blocked:', err);
  }

  // 4) fallback: create anchor with target _top and click it (may be blocked by sandbox)
  try {
    const a = document.createElement('a');
    a.href = url;
    a.target = '_top';
    a.rel = 'noopener noreferrer';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    a.remove();
    console.info('Navigation: used anchor target _top fallback');
    return;
  } catch (err) {
    console.warn('anchor _top fallback blocked:', err);
  }

  // 5) last resort: change current location (may load inside iframe)
  try {
    window.location.href = url;
    console.info('Navigation: used window.location.href (inside iframe)');
  } catch (err) {
    console.error('All navigation attempts failed:', err);
  }
}

/* Click Handlers with drag detection */
document.addEventListener("click", e => {  
  // If click originates from an <a href target=_top> we let browser handle it.
  // But we still capture clicks on spans (WhatsApp) and span-based hrefs.
  if (moved) return; // ignore clicks if it was a drag

  const el = e.target;
  if (!el.classList.contains("clickable-announcement")) return;

  // If element is an anchor with an href and target=_top, let it go (browser handles)
  if (el.tagName === 'A' && el.href) {
    // anchor with target should naturally break out; do nothing here
    return;
  }

  if (el.dataset && el.dataset.href) {
    // Try to force breakout to full window using the robust helper
    breakOutTo(el.dataset.href);
    return;
  }

  // Otherwise treat as phone announcement -> open WhatsApp in new tab
  const phone = el.dataset.phone;  
  const content = el.dataset.content || '';
  if (phone) {
    const msg = `Hi, I saw your announcement: *${content}* on PickMe Services and I want to make enquiry on it.`;
    window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, "_blank");
  }
});
</script>

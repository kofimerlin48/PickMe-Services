<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tech & Gadgets - PickMe Services</title>

<!-- ========= HEADER ========= -->
<div id="header-placeholder"></div>
<script>
(async () => {
  try {
    const res = await fetch('header.html');
    if (!res.ok) throw new Error('Failed to load header');
    let html = await res.text();
    const pageTitle = "Tech & Gadgets";
    html = html.replace(/<h1[^>]*>.*?<\/h1>/i,
      `<h1 style="margin:0; font-weight:bold; color:#c12872; font-size:24px; position:absolute; left:50%; transform:translateX(-50%);">${pageTitle}</h1>`
    );
    document.getElementById('header-placeholder').innerHTML = html;
    document.querySelectorAll('#header-placeholder script').forEach(s => {
      const n = document.createElement('script');
      if (s.src) n.src = s.src; else n.textContent = s.textContent;
      document.body.appendChild(n);
    });
  } catch (e) { console.error(e); }
})();
</script>

<style>
:root{ --theme-color:#c12872; }

*{box-sizing:border-box}
* { -webkit-tap-highlight-color: transparent; }
:focus, :focus-visible, button:focus, input:focus { outline: none !important; box-shadow: none !important; }
body{ margin:0; font-family:Arial, sans-serif; background:#f9f9f9; padding-top:100px; overflow-x:hidden; }

/* Page header + search */
.page-header{text-align:center;margin-bottom:10px;}
.page-header h1{color:var(--theme-color);margin:0;font-size:28px;}
.page-header p{color:#000;margin-top:5px;font-size:16px;font-weight:bold;}
.search-bar{display:flex;justify-content:center;margin:10px 16px 6px;}
.search-bar input{width:100%;max-width:520px;padding:10px 14px;border:1px solid #ccc;border-radius:10px;font-size:16px;}

/* Main tabs: Categories | Shops */
.main-tabs{display:flex;gap:8px;overflow-x:auto;padding:8px 16px;border-bottom:2px solid #eee;}
.main-tab{flex:1;text-align:center;padding:12px 14px;border-radius:999px;background:#fff;border:1px solid #eee;cursor:pointer;white-space:nowrap;font-size:14px;font-weight:700;}
.main-tab.active{color:#fff;background:var(--theme-color);border-color:var(--theme-color);}

/* Containers */
.view{display:none;}
.view.show{display:block;}
.container{padding:16px 16px 120px;}

/* Categories small rectangular cards (with > chevron) */
.categories-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;
}
.cat-card{
  display:flex;align-items:center;gap:12px;background:#fff;border:1px solid #eee;border-radius:12px;
  padding:10px 12px; box-shadow:0 2px 6px rgba(0,0,0,.06); cursor:pointer;
}
.cat-thumb{width:42px;height:42px;border-radius:10px;background:#f2f2f2;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.cat-thumb img{width:100%;height:100%;object-fit:cover;}
.cat-info{flex:1;min-width:0}
.cat-title{font-weight:700;font-size:14px;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cat-sub{font-size:12px;color:#666}
.cat-arrow{font-size:18px;color:#999;}

/* Item grid for a category / shop */
.items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;}
.item-card{
  background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);cursor:pointer;border:1px solid #eee;
  display:flex;flex-direction:column;min-height:240px;
}
.item-img{position:relative;width:100%;padding-top:66%;background:#f2f2f2;overflow:hidden}
.item-img img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.item-body{padding:10px;display:flex;flex-direction:column;gap:6px}
.item-price{font-weight:800;color:#111}
.item-desc{font-size:12px;color:#444;line-height:1.3;max-height:30px;overflow:hidden}
.item-shop{font-size:11px;color:#777}

/* Shop cards (like groceries but with Items count) */
.cards-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:70px;padding:10px 0 0;
}
.shop-card{
  position:relative;border-radius:15px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.1);
  background-size:cover;background-position:center;height:250px;display:flex;align-items:flex-end;transition:transform .2s;
}
.shop-card:hover{transform:translateY(-5px)}
.shop-card::before{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.75), rgba(0,0,0,0))}
.shop-card .content{position:relative;color:#fff;padding:15px;width:100%;display:flex;flex-direction:column;justify-content:space-between;z-index:1}
.shop-title{font-weight:bold;font-size:22px;margin-bottom:4px}
.shop-slogan{font-size:13px;opacity:.95;margin-bottom:4px}
.shop-lower{display:flex; justify-content:space-between; align-items:center; margin-top:8px;}
.shop-meta{font-size:12px; opacity:0.9; margin:0;}
.btn-enter{background:var(--theme-color);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;align-self:flex-end}

/* Details drawer (for item or shop) */
#drawer{
  position:fixed;top:0;right:-100%;width:100%;max-width:1100px;height:100%;
  background:#fff;z-index:9999;overflow-y:auto;transition:right .5s ease;box-shadow:-5px 0 15px rgba(0,0,0,.2);
  padding-bottom:140px;
}
#drawer.show{right:0;}
#drawerClose{
  position:fixed;top:15px;right:-60px;width:40px;height:40px;background:#000;color:#fff;border:none;border-radius:50%;
  font-size:24px;cursor:pointer;z-index:10000;display:flex;align-items:center;justify-content:center;transition:right .5s ease;
}
#drawer.show #drawerClose{right:15px;}
.banner{
  position:relative;width:100%;height:35vh;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;
  background:#333 center/cover no-repeat;
}
.banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,.22), rgba(0,0,0,.70), rgba(0,0,0,.80))}
.banner-text{position:relative;z-index:2}
.banner-text h2{font-size:16px;margin:0 0 6px}
.banner-text h1{font-size:26px;margin:0 0 8px}
.banner-text p{font-size:13px;margin:0;opacity:.95}
.drawer-content{padding:18px;max-width:1100px;margin:0 auto}
.section-title{font-weight:bold;margin:8px 0 12px;color:#333}

/* Slider (infinite) */
.slider{position:relative;width:100%;height:260px;overflow:hidden;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);background:#f2f2f2}
.slide{position:absolute;top:0;left:100%;width:100%;height:100%;object-fit:cover;opacity:0;transition:left .45s ease, opacity .45s ease;}
.slide.active{left:0;opacity:1}
.slider .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:24px;color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:50%;cursor:pointer;user-select:none}
.slider .nav.left{left:10px}
.slider .nav.right{right:10px}
.dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.dot{width:8px;height:8px;border-radius:50%;background:#ddd}
.dot.active{background:var(--theme-color)}

/* Item detail text + actions */
.item-detail{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.detail-title{font-weight:800;font-size:18px}
.detail-price{font-weight:800;color:#111;font-size:16px}
.detail-desc{font-size:14px;color:#333;white-space:pre-wrap}
.detail-meta{font-size:12px;color:#666}
.actions-row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.btn-primary{background:var(--theme-color);color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-size:15px}
.btn-secondary{background:#3a3a3a;color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-size:15px}

/* Admin modal(s) generic */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10001;}
.modal.show{display:flex}
.modal-card{width:95%;max-width:620px;background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden;max-height:90vh;display:flex;flex-direction:column;}
.modal-header{padding:14px 16px;border-bottom:1px solid #eee;font-weight:bold;display:flex;align-items:center;justify-content:space-between;gap:8px}
.modal-body{padding:16px;overflow-y:auto;max-height:calc(90vh - 120px)}
.modal-footer{padding:14px 16px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end}
.mopt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.mopt-card{border:1px solid #eee;border-radius:12px;padding:14px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:6px}
.mopt-card h4{margin:0;font-size:14px}
.mopt-card p{margin:0;font-size:12px;color:#555}
.close-x{background:#000;color:#fff;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
.input:focus{border-color:var(--theme-color);box-shadow:0 0 0 3px rgba(193,40,114,.08)}
.row{display:flex;gap:10px;flex-wrap:wrap}
.lbl{font-size:12px;color:#555;margin:6px 0 4px}

/* Thumb list with delete overlay */
.thumb-row{display:flex;gap:8px;overflow-x:auto}
.thumb{position:relative;width:90px;height:90px;border-radius:10px;background:#f2f2f2;overflow:hidden;flex-shrink:0}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .trash{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}

/* Shop top bar (hamburger on left, close on right) */
.shop-top-actions{
  position:fixed;top:12px;left:12px;z-index:10002;display:flex;gap:8px
}
.action-round{background:#000;color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px}

/* Footer iframe pinned */
.footer-wrap{position:fixed;bottom:0;width:100%;z-index:9999}
</style>
</head>
<body>
<style>
  body.hide-initial * { visibility: hidden !important; }
  body.ready * { visibility: visible !important; }
</style>
<script>
  document.documentElement.style.background = "#fff";
  document.body.classList.add("hide-initial");
</script>

<!-- ===== Header text & search ===== -->
<div class="page-header">
  <h1></h1>
  <p>Find tech & gadget shops around you, browse categories, and contact sellers directly</p>
</div>
<div class="search-bar">
  <input type="text" id="globalSearch" placeholder="Search items, shops, models, keywords...">
</div>

<!-- ===== Main tabs ===== -->
<div class="main-tabs">
  <div class="main-tab active" data-view="categoriesView">Categories</div>
  <div class="main-tab" data-view="shopsView">Shops</div>
</div>

<!-- ===== CATEGORIES VIEW ===== -->
<div id="categoriesView" class="view show">
  <div class="container">
    <div id="categoriesGrid" class="categories-grid"></div>
    <!-- category items canvas -->
    <div id="categoryItemsWrap" style="display:none; margin-top:14px;">
      <div class="section-title" id="categoryItemsTitle"></div>
      <div class="search-bar" style="margin:6px 0 12px;">
        <input type="text" id="categorySearch" placeholder="Search within this category...">
      </div>
      <div id="categoryItemsGrid" class="items-grid"></div>
    </div>
  </div>
</div>

<!-- ===== SHOPS VIEW ===== -->
<div id="shopsView" class="view">
  <div class="container">
    <div id="shopsGrid" class="cards-grid"></div>
  </div>
</div>

<!-- ===== Drawer (item or shop) ===== -->
<div id="drawer">
  <button id="drawerClose">&times;</button>
  <!-- banner for shop mode -->
  <section class="banner" id="shopBanner" style="display:none;">
    <div class="banner-text">
      <h2>Welcome to</h2>
      <h1 id="shopName"></h1>
      <p id="shopSlogan"></p>
    </div>
  </section>

  <!-- Shop actions (hamburger & close are fixed; hamburger here is a backup for non-banner contexts) -->
  <div class="shop-top-actions" id="shopTopActions" style="display:none;">
    <button class="action-round" id="hamburgerBtn">&#9776;</button>
  </div>

  <div class="drawer-content">
    <!-- Item detail -->
    <div id="itemDetail" style="display:none;">
      <div id="itemSlider" class="slider"></div>
      <div class="dots" id="itemDots"></div>
      <div class="item-detail">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-price" id="detailPrice"></div>
        <div class="detail-meta" id="detailPostedBy"></div>
        <div class="detail-desc" id="detailDesc"></div>
        <div class="actions-row">
          <button class="btn-primary" id="callBtn">Call</button>
          <button class="btn-secondary" id="waBtn">WhatsApp</button>
          <button class="btn-primary" id="viewShopBtn">View Shop</button>
        </div>
      </div>
    </div>

    <!-- Shop gallery -->
    <div id="shopGallery" style="display:none;">
      <div class="section-title">Items</div>
      <div id="shopTabs" class="main-tabs" style="margin:0 0 10px 0;"></div>
      <div id="shopItemsGrid" class="items-grid"></div>
    </div>
  </div>
</div>

<!-- ===== Modals (Admin) ===== -->
<!-- Access code prompt (per shop) -->
<div class="modal" id="codeModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Enter Access Code</span>
      <button class="close-x" id="codeClose">&times;</button>
    </div>
    <div class="modal-body">
      <input class="input" id="codeInput" placeholder="Access code"/>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="codeCancel">Cancel</button>
      <button class="btn-primary" id="codeOk">OK</button>
    </div>
  </div>
</div>

<!-- Admin options -->
<div class="modal" id="adminOptionsModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Admin</span>
      <button class="close-x" id="adminOptClose">&times;</button>
    </div>
    <div class="modal-body">
      <div class="mopt-grid">
        <div class="mopt-card" id="optAdd">
          <h4>Add item</h4><p>Create a new advert</p>
        </div>
        <div class="mopt-card" id="optDelete">
          <h4>Delete item</h4><p>Remove an existing advert</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="adminOptCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Choose category -->
<div class="modal" id="catChooseModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Choose Category</span>
      <button class="close-x" id="catChooseClose">&times;</button>
    </div>
    <div class="modal-body">
      <div id="catChooseGrid" class="mopt-grid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="catChooseCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Draft editor (add items) -->
<div class="modal" id="draftModal">
  <div class="modal-card">
    <div class="modal-header">
      <span id="draftTitle">Add items</span>
      <button class="close-x" id="draftClose">&times;</button>
    </div>
    <div class="modal-body">
      <div id="draftList"></div>
      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
      <div class="lbl">Images (1–5)</div>
      <div class="row">
        <input type="file" id="imgInput" accept="image/*" capture="environment" multiple class="input">
      </div>
      <div class="thumb-row" id="imgThumbs"></div>

      <div class="lbl">Name</div>
      <input class="input" id="nameInput" placeholder="e.g., iPhone 13 Pro Max 128GB (NIB)">
      <div class="lbl">Price (GH₵)</div>
      <input class="input" id="priceInput" type="number" min="0" step="1" placeholder="e.g., 4500">
      <div class="lbl">Description / Specs</div>
      <textarea class="input" id="descInput" rows="4" placeholder="Key specs, condition, warranty..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="addMoreBtn">Add more</button>
      <button class="btn-primary" id="submitDraftsBtn">Submit</button>
    </div>
  </div>
</div>

<!-- Delete picker -->
<div class="modal" id="deleteModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Delete item</span>
      <button class="close-x" id="deleteClose">&times;</button>
    </div>
    <div class="modal-body">
      <div id="deleteList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="deleteCancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Number capture (before call/whatsapp) -->
<div class="modal" id="numberModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Your WhatsApp number</span>
      <button class="close-x" id="numberClose">&times;</button>
    </div>
    <div class="modal-body">
      <input class="input" id="waNumberInput" placeholder="+233... or 0..." inputmode="tel">
      <div id="numberError" style="margin-top:6px;color:#b00020;font-size:13px;display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="numberCancel">Cancel</button>
      <button class="btn-primary" id="numberOk">Continue</button>
    </div>
  </div>
</div>

<!-- Review (PickMe) global admin -->
<div class="modal" id="reviewCodeModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>PickMe Admin Access</span>
      <button class="close-x" id="reviewCodeClose">&times;</button>
    </div>
    <div class="modal-body">
      <input class="input" id="reviewCodeInput" placeholder="Enter admin code">
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="reviewCodeCancel">Cancel</button>
      <button class="btn-primary" id="reviewCodeOk">OK</button>
    </div>
  </div>
</div>

<!-- ========= FIREBASE + PAGE LOGIC ========= -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore,
  collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, serverTimestamp,
  query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll, deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2L649fIs0CS-fGDC0ybFeAO5Im5BEP_c",
  authDomain: "pickmeservicesonline.firebaseapp.com",
  projectId: "pickmeservicesonline",
  storageBucket: "pickmeservicesonline.firebasestorage.app",
  messagingSenderId: "265031616239",
  appId: "1:265031616239:web:e2ef418704af5595aa7d1a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const st  = getStorage(app);

/* ======== Constants ======== */
const PAGE_KEY = "Tek&gaget"; // exact spelling with '&'
const PICKME_WHATSAPP = "233534742142";
const GLOBAL_ADMIN_CODE = "999888"; // PickMe global review code (change as needed)
const SHOP_ADMIN_DEFAULT_CODE = "123456"; // per-shop default if not set in hardcode
const MAX_IMAGES = 5;

/* ======== Hardcoded Shops (example seed) ======== */
const SHOPS = [
  {
    name: "Trick Eye Store",
    slogan: "Phones, laptops & accessories",
    heroImage: "https://via.placeholder.com/1200x700?text=Trick+Eye+Store",
    phone: "233530477395",
    accessCode: "123456",
    expiry: "2026-12-31",
    categories: ["Phones", "Computers & Laptops", "Accessories", "Gaming", "Networking"]
  },
  {
    name: "DigiHub",
    slogan: "All things electronics",
    heroImage: "https://via.placeholder.com/1200x700?text=DigiHub",
    phone: "233540576548",
    accessCode: "123456",
    expiry: "2026-10-31",
    categories: ["Printers & Scanners", "Cameras & Photo", "Software", "Security & Surveillance"]
  }
];

/* ======== Category list (global) ======== */
const CATEGORIES = [
  { id:"Phones",                icon:"📱", img:"https://via.placeholder.com/200?text=Phones" },
  { id:"Computers & Laptops",   icon:"💻", img:"https://via.placeholder.com/200?text=Laptops" },
  { id:"Printers & Scanners",   icon:"🖨️", img:"https://via.placeholder.com/200?text=Printers" },
  { id:"Accessories",           icon:"🔌", img:"https://via.placeholder.com/200?text=Accessories" },
  { id:"Security & Surveillance", icon:"🎦", img:"https://via.placeholder.com/200?text=Security" },
  { id:"Networking",            icon:"🌐", img:"https://via.placeholder.com/200?text=Networking" },
  { id:"Gaming",                icon:"🎮", img:"https://via.placeholder.com/200?text=Gaming" },
  { id:"Software",              icon:"💿", img:"https://via.placeholder.com/200?text=Software" },
  { id:"Cameras & Photo",       icon:"📷", img:"https://via.placeholder.com/200?text=Cameras" }
];

/* ========= Firestore Paths =========
  Tek&gaget
    - Links/items/{id} -> { payload, createdAt }
    - ShopsMeta/items/{shopName} -> { meta }
    - Shops/{shopName}/items/{adId} -> { ad }
    - Shops/{shopName}/customers/{phoneE164} -> { whatsapp, ts }
    - Numbers/items/{phoneE164} -> { whatsapp, ts }   (dedup within Tek&gaget only)
*/
const linksCol   = collection(db, PAGE_KEY, "Links", "items");
const shopsMeta  = collection(db, PAGE_KEY, "ShopsMeta", "items");
const globalNums = collection(db, PAGE_KEY, "Numbers", "items");

/* ======== DOM ======== */
const tabButtons = document.querySelectorAll(".main-tab");
const categoriesView = document.getElementById("categoriesView");
const shopsView = document.getElementById("shopsView");
const categoriesGrid = document.getElementById("categoriesGrid");
const categoryItemsWrap = document.getElementById("categoryItemsWrap");
const categoryItemsTitle= document.getElementById("categoryItemsTitle");
const categoryItemsGrid = document.getElementById("categoryItemsGrid");
const categorySearch    = document.getElementById("categorySearch");
const shopsGrid = document.getElementById("shopsGrid");
const globalSearch = document.getElementById("globalSearch");

/* Drawer */
const drawer = document.getElementById("drawer");
const drawerClose = document.getElementById("drawerClose");
const shopBanner = document.getElementById("shopBanner");
const shopNameEl = document.getElementById("shopName");
const shopSloganEl = document.getElementById("shopSlogan");
const shopTopActions = document.getElementById("shopTopActions");
const hamburgerBtn = document.getElementById("hamburgerBtn");
const shopGallery = document.getElementById("shopGallery");
const shopTabs = document.getElementById("shopTabs");
const shopItemsGrid = document.getElementById("shopItemsGrid");

const itemDetail = document.getElementById("itemDetail");
const itemSlider = document.getElementById("itemSlider");
const itemDots = document.getElementById("itemDots");
const detailTitle = document.getElementById("detailTitle");
const detailPrice = document.getElementById("detailPrice");
const detailDesc = document.getElementById("detailDesc");
const detailPostedBy = document.getElementById("detailPostedBy");
const callBtn = document.getElementById("callBtn");
const waBtn = document.getElementById("waBtn");
const viewShopBtn = document.getElementById("viewShopBtn");

/* Modals */
const codeModal = document.getElementById("codeModal");
const codeInput = document.getElementById("codeInput");
const codeOk = document.getElementById("codeOk");
const codeCancel = document.getElementById("codeCancel");
const codeClose = document.getElementById("codeClose");

const adminOptionsModal = document.getElementById("adminOptionsModal");
const optAdd = document.getElementById("optAdd");
const optDelete = document.getElementById("optDelete");
const adminOptClose = document.getElementById("adminOptClose");
const adminOptCancel = document.getElementById("adminOptCancel");

const catChooseModal = document.getElementById("catChooseModal");
const catChooseGrid = document.getElementById("catChooseGrid");
const catChooseClose = document.getElementById("catChooseClose");
const catChooseCancel = document.getElementById("catChooseCancel");

const draftModal = document.getElementById("draftModal");
const draftClose = document.getElementById("draftClose");
const draftTitle = document.getElementById("draftTitle");
const imgInput = document.getElementById("imgInput");
const imgThumbs = document.getElementById("imgThumbs");
const nameInput = document.getElementById("nameInput");
const priceInput = document.getElementById("priceInput");
const descInput = document.getElementById("descInput");
const addMoreBtn = document.getElementById("addMoreBtn");
const submitDraftsBtn = document.getElementById("submitDraftsBtn");
const draftList = document.getElementById("draftList");

const deleteModal = document.getElementById("deleteModal");
const deleteClose = document.getElementById("deleteClose");
const deleteCancel = document.getElementById("deleteCancel");
const deleteList = document.getElementById("deleteList");

const numberModal = document.getElementById("numberModal");
const waNumberInput = document.getElementById("waNumberInput");
const numberOk = document.getElementById("numberOk");
const numberCancel = document.getElementById("numberCancel");
const numberClose = document.getElementById("numberClose");
const numberError = document.getElementById("numberError");

const reviewCodeModal = document.getElementById("reviewCodeModal");
const reviewCodeInput = document.getElementById("reviewCodeInput");
const reviewCodeOk = document.getElementById("reviewCodeOk");
const reviewCodeClose = document.getElementById("reviewCodeClose");
const reviewCodeCancel = document.getElementById("reviewCodeCancel");

/* ======== State ======== */
let currentShop = null;       // shop object
let currentShopName = null;
let jumpToAdId = null;        // used when coming from an item “View Shop”
let currentCategory = null;
let pendingAction = null;     // "call" | "wa"
let pendingContactFor = null; // {shopName, phone, itemTitle}
let drafts = [];              // [{id, cat, name, price, desc, files:[File], urls:[...temp]}]
let userPhoneCache = null;

/* ======== Helpers ======== */
function show(el){ el.style.display = ''; }
function hide(el){ el.style.display = 'none'; }
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function money(n){ n = Number(n||0); return isNaN(n)?0:n; }
function isExpired(iso){ if(!iso) return false; return new Date()>new Date(iso+"T23:59:59"); }
function fmtPrice(ghc){ const v = Number(ghc||0); return `GH₵ ${v.toFixed(2).replace(/\.00$/,'')}`; }
function makeId(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)).toLowerCase(); }

/* phone normalize (Ghana) */
function normalizeGhanaNumber(input){
  let s=String(input||'').trim().replace(/[\s\-]/g,'');
  if (s.startsWith('+233')) return { e164:s, wa:s.slice(1) };
  if (s.startsWith('233'))  return { e164:'+'+s, wa:s };
  if (/^0\d{9}$/.test(s))   return { e164:'+233'+s.slice(1), wa:'233'+s.slice(1) };
  if (/^\d{9}$/.test(s))    return { e164:'+233'+s, wa:'233'+s };
  const d=s.replace(/\D/g,'');
  if (d.startsWith('233')) return { e164:'+'+d, wa:d };
  if (d.length===10 && d.startsWith('0')) return { e164:'+233'+d.slice(1), wa:'233'+d.slice(1) };
  return null;
}

/* ======== Firestore upserts for ShopsMeta ======== */
async function upsertShopsMeta(){
  try{
    await Promise.all(SHOPS.map(async shop=>{
      const id = shop.name;
      await setDoc(doc(shopsMeta, id), {
        name: shop.name,
        slogan: shop.slogan||"",
        heroImage: shop.heroImage||"",
        phone: shop.phone||"",
        expiry: shop.expiry||null,
        categories: shop.categories||[],
        updatedAt: serverTimestamp()
      }, { merge: true });
    }));
  }catch(e){ console.warn("Shops meta upsert failed:", e); }
}

/* ======== Caching ======== */
const CACHE = {
  cats: "tk_cats_counts",
  shops: "tk_shops_counts",
  shopItems: (shop)=>`tk_shop_${shop}_items`,
  catItems: (cat)=>`tk_cat_${cat}_items`
};
function saveCache(key, data){ try{ localStorage.setItem(key, JSON.stringify(data)); }catch{} }
function loadCache(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch{ return null; } }

/* ======== Build Categories grid ======== */
async function countByCategory(){
  // Count approved items globally per category
  // We’ll read per shop items and aggregate quickly (best-effort)
  const cached = loadCache(CACHE.cats);
  if (cached) return cached;

  const out = {};
  await Promise.all(SHOPS.map(async sh=>{
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d=>{
      const it = d.data();
      const cat = it.category || "Other";
      out[cat] = (out[cat]||0)+1;
    });
  }));
  saveCache(CACHE.cats, out);
  return out;
}
function renderCategoriesGrid(counts){
  categoriesGrid.innerHTML = "";
  CATEGORIES.forEach(c=>{
    const card = document.createElement('div');
    card.className = "cat-card";
    card.innerHTML = `
      <div class="cat-thumb">${c.img ? `<img src="${c.img}" alt="${c.id}">` : c.icon}</div>
      <div class="cat-info">
        <div class="cat-title">${escapeHtml(c.id)}</div>
        <div class="cat-sub">${counts[c.id]||0} adverts</div>
      </div>
      <div class="cat-arrow">&gt;</div>
    `;
    card.addEventListener('click', ()=> openCategory(c.id));
    categoriesGrid.appendChild(card);
  });
}

/* ======== Category view (items) ======== */
async function fetchAllItemsInCategory(cat){
  const cacheKey = CACHE.catItems(cat);
  const cached = loadCache(cacheKey);
  if (cached) return cached;

  const items = [];
  await Promise.all(SHOPS.map(async sh=>{
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d=>{
      const it = d.data();
      if (it.category===cat) items.push(it);
    });
  }));
  // sort newest first
  items.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  saveCache(cacheKey, items);
  return items;
}
function renderItemCard(container, ad){
  const card = document.createElement('div');
  card.className = "item-card";
  const firstImg = (ad.images && ad.images[0]) || "https://via.placeholder.com/600x400?text=Image";
  card.innerHTML = `
    <div class="item-img"><img src="${firstImg}" alt="${escapeHtml(ad.name||'Item')}"></div>
    <div class="item-body">
      <div class="item-price">${fmtPrice(ad.price)}</div>
      <div class="item-desc">${escapeHtml(ad.desc||'')}</div>
      <div class="item-shop">Posted by ${escapeHtml(ad.shop||'')}</div>
    </div>
  `;
  card.addEventListener('click', ()=> openItemDetail(ad));
  container.appendChild(card);
}
async function openCategory(cat){
  currentCategory = cat;
  categoryItemsTitle.textContent = cat;
  show(categoryItemsWrap);
  categoryItemsGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;'>Loading…</p>";
  const items = await fetchAllItemsInCategory(cat);
  const render = (list)=>{
    categoryItemsGrid.innerHTML = "";
    list.forEach(ad=> renderItemCard(categoryItemsGrid, ad));
    if (!list.length) categoryItemsGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;'>No items yet.</p>";
  };
  render(items);
  categorySearch.oninput = ()=>{
    const q = (categorySearch.value||"").toLowerCase();
    render(items.filter(ad =>
      (ad.name||'').toLowerCase().includes(q) ||
      (ad.desc||'').toLowerCase().includes(q) ||
      (ad.shop||'').toLowerCase().includes(q)
    ));
  };
}

/* ======== Shops grid ======== */
async function fetchShopCounts(){
  const cached = loadCache(CACHE.shops);
  if (cached) return cached;
  const map = {};
  await Promise.all(SHOPS.map(async sh=>{
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    map[sh.name] = snap.size || 0;
  }));
  saveCache(CACHE.shops, map);
  return map;
}
function renderShopsGrid(countMap){
  shopsGrid.innerHTML = "";
  const list = SHOPS.filter(s=>!isExpired(s.expiry))
    .sort((a,b)=> (countMap[b.name]||0)-(countMap[a.name]||0) || a.name.localeCompare(b.name));
  list.forEach(shop=>{
    const count = countMap[shop.name]||0;
    const card = document.createElement('div');
    card.className = "shop-card";
    card.style.backgroundImage = `url('${shop.heroImage}')`;
    const content = document.createElement('div');
    content.className = "content";
    content.innerHTML = `
      <div>
        <div class="shop-title">${escapeHtml(shop.name)}</div>
        <div class="shop-slogan">${escapeHtml(shop.slogan||"")}</div>
      </div>
      <div class="shop-lower">
        <div class="shop-meta">Items: ${count}</div>
        <button class="btn-enter">Enter Shop</button>
      </div>
    `;
    content.querySelector(".btn-enter").addEventListener('click', ()=> openShop(shop));
    card.appendChild(content);
    shopsGrid.appendChild(card);
  });
  if (!shopsGrid.children.length){
    shopsGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;'>No shops available.</p>";
  }
}

/* ======== Drawer openers ======== */
function openDrawer(){ drawer.classList.add("show"); }
function closeDrawer(){ drawer.classList.remove("show"); }
drawerClose.addEventListener('click', closeDrawer);

/* Item detail with infinite slider */
function buildSlider(images, sliderEl, dotsEl){
  sliderEl.innerHTML = ""; dotsEl.innerHTML="";
  if (!images || !images.length) images = ["https://via.placeholder.com/1000x600?text=Image"];
  images.forEach((src,i)=>{
    const img = document.createElement("img");
    img.src = src; img.alt = `image-${i+1}`; img.className = "slide" + (i===0?" active":"");
    sliderEl.appendChild(img);
    const dot = document.createElement("div"); dot.className="dot"+(i===0?" active":"");
    dot.addEventListener("click",()=>goTo(i)); dotsEl.appendChild(dot);
  });
  const left=document.createElement("div"); left.className="nav left"; left.innerHTML="&#10094;";
  const right=document.createElement("div"); right.className="nav right"; right.innerHTML="&#10095;";
  sliderEl.append(left,right);

  let current=0;
  const slides=sliderEl.querySelectorAll(".slide");
  const dots=dotsEl.querySelectorAll(".dot");
  function setPos(prev,next,dir){
    const a=slides[prev], b=slides[next];
    b.style.transition="none"; b.style.left=(dir===1?"100%":"-100%"); b.style.opacity="1"; void b.offsetWidth;
    a.style.transition="left .45s ease, opacity .45s ease";
    b.style.transition="left .45s ease, opacity .45s ease";
    a.style.left=(dir===1?"-100%":"100%"); a.style.opacity="1"; b.style.left="0";
  }
  function goTo(n){
    if (n===current) return;
    const dir=(n>current)?1:-1;
    setPos(current,n,dir);
    slides[current].classList.remove("active");
    slides[n].classList.add("active");
    dots[current].classList.remove("active");
    dots[n].classList.add("active");
    current=n;
  }
  left.addEventListener("click",()=>goTo((current-1+slides.length)%slides.length));
  right.addEventListener("click",()=>goTo((current+1)%slides.length));
  let startX=0;
  sliderEl.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
  sliderEl.addEventListener("touchend",e=>{
    const endX=e.changedTouches[0].clientX;
    if (startX-endX>40) right.click();
    if (endX-startX>40) left.click();
  });
}

/* Open item detail */
function openItemDetail(ad){
  // item mode
  hide(shopBanner); hide(shopGallery); hide(shopTopActions);
  show(itemDetail);
  buildSlider(ad.images||[], itemSlider, itemDots);
  detailTitle.textContent = ad.name||"Item";
  detailPrice.textContent = fmtPrice(ad.price);
  detailPostedBy.textContent = "Posted by " + (ad.shop||"");
  detailDesc.textContent = ad.desc||"";
  openDrawer();

  // actions
  callBtn.onclick = ()=> captureNumberThenProceed("call", ad);
  waBtn.onclick   = ()=> captureNumberThenProceed("wa", ad);
  viewShopBtn.onclick = ()=> {
    jumpToAdId = ad.id || null;
    const shopObj = SHOPS.find(s=>s.name===ad.shop);
    if (shopObj) openShop(shopObj);
  };
}

/* Open shop gallery */
async function openShop(shop){
  currentShop = shop;
  currentShopName = shop.name;
  jumpToAdId = jumpToAdId || null;

  // shop mode
  show(shopBanner); show(shopTopActions);
  hide(itemDetail);
  show(shopGallery);

  shopBanner.style.backgroundImage = `url('${shop.heroImage}')`;
  shopNameEl.textContent = shop.name;
  shopSloganEl.textContent = shop.slogan || "";
  openDrawer();

  hamburgerBtn.onclick = ()=> promptShopCode();

  await renderShopTabsAndItems(shop, jumpToAdId);
  jumpToAdId = null; // reset after jump
}

async function renderShopTabsAndItems(shop, focusAdId=null){
  // tabs are only categories that have items
  const items = await fetchShopItems(shop.name);
  const byCat = {};
  items.forEach(it=>{
    const c = it.category||"Other";
    (byCat[c]||(byCat[c]=[])).push(it);
  });
  // build tabs
  shopTabs.innerHTML = "";
  const cats = Object.keys(byCat).sort((a,b)=> a.localeCompare(b));
  cats.forEach((c,i)=>{
    const tab = document.createElement('div');
    tab.className = "main-tab"+(i===0?" active":"");
    tab.dataset.cat = c;
    tab.textContent = `${c}  (${byCat[c].length})`;
    tab.addEventListener('click', ()=>{
      shopTabs.querySelectorAll('.main-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      renderShopItems(byCat[c]);
    });
    shopTabs.appendChild(tab);
  });
  if (!cats.length){
    shopItemsGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;'>No items yet.</p>";
    return;
  }
  // initial render
  const firstCat = focusAdId ? Object.keys(byCat).find(cat => (byCat[cat]||[]).some(it=>it.id===focusAdId)) : cats[0];
  shopTabs.querySelectorAll('.main-tab').forEach(t=> t.dataset.cat===firstCat && t.classList.add('active'));
  renderShopItems(byCat[firstCat], focusAdId);
}

function renderShopItems(list, focusAdId=null){
  shopItemsGrid.innerHTML = "";
  list.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(ad=>{
    renderItemCard(shopItemsGrid, ad);
  });
  if (!list.length) shopItemsGrid.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;'>No items in this category.</p>";

  if (focusAdId){
    const ad = list.find(x=>x.id===focusAdId);
    if (ad) openItemDetail(ad);
  }
}

async function fetchShopItems(shopName){
  const cacheKey = CACHE.shopItems(shopName);
  const cached = loadCache(cacheKey);
  if (cached) return cached;

  const col = collection(db, PAGE_KEY, "Shops", shopName, "items");
  const snap = await getDocs(col);
  const arr = [];
  snap.forEach(d=>{
    const it = d.data(); it.id = d.id; arr.push(it);
  });
  arr.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  saveCache(cacheKey, arr);
  return arr;
}

/* ======== Search ======== */
globalSearch.addEventListener('input', ()=>{
  const q = (globalSearch.value||"").trim().toLowerCase();
  // live filter both visible views
  if (!q){
    // re-render from cached
    if (categoriesView.classList.contains('show') && currentCategory){
      openCategory(currentCategory);
    }
    if (shopsView.classList.contains('show')){
      fetchShopCounts().then(renderShopsGrid);
    }
    return;
  }

  if (categoriesView.classList.contains('show')){
    // filter current category items if visible
    if (categoryItemsWrap.style.display!=="none"){
      const cards = categoryItemsGrid.querySelectorAll('.item-card');
      cards.forEach(c=>{
        const txt = c.textContent.toLowerCase();
        c.style.display = txt.includes(q) ? '' : 'none';
      });
    } else {
      // filter categories list captions only (simple)
      Array.from(categoriesGrid.children).forEach(card=>{
        const txt = card.textContent.toLowerCase();
        card.style.display = txt.includes(q)?'':'none';
      });
    }
  }

  if (shopsView.classList.contains('show')){
    Array.from(shopsGrid.children).forEach(card=>{
      const txt = card.textContent.toLowerCase();
      card.style.display = txt.includes(q)?'':'none';
    });
  }
});

/* ======== Tabs switching ======== */
tabButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.view;
    [categoriesView, shopsView].forEach(v=>v.classList.remove('show'));
    document.getElementById(target).classList.add('show');
  });
});

/* ======== Number capture + proceed ======== */
function openNumberModal(){ numberModal.classList.add('show'); }
function closeNumberModal(){ numberModal.classList.remove('show'); }
[numberClose, numberCancel].forEach(b=> b.addEventListener('click', closeNumberModal));

async function captureNumberThenProceed(kind, ad){
  pendingAction = kind;
  pendingContactFor = { shopName: ad.shop, phone: (SHOPS.find(s=>s.name===ad.shop)?.phone)||"", itemTitle: ad.name };
  waNumberInput.value = userPhoneCache || "";
  numberError.style.display = 'none';
  openNumberModal();
}
numberOk.addEventListener('click', async ()=>{
  const norm = normalizeGhanaNumber(waNumberInput.value);
  if (!norm){ numberError.textContent="Enter a valid WhatsApp number"; numberError.style.display='block'; return; }
  numberError.style.display='none';
  userPhoneCache = norm.e164;

  // save under Tek&gaget (dedup **within this page only**)
  await setDoc(doc(globalNums, norm.e164.replace(/[^\d+]/g,'')), {
    whatsapp: norm.e164, timestamp: serverTimestamp()
  }, { merge: true });

  // also per-shop unique set
  const shop = pendingContactFor?.shopName;
  if (shop){
    const custCol = collection(db, PAGE_KEY, "Shops", shop, "customers");
    await setDoc(doc(custCol, norm.e164.replace(/[^\d+]/g,'')), {
      whatsapp: norm.e164, timestamp: serverTimestamp()
    }, { merge: true });
  }

  // proceed
  const shopPhone = pendingContactFor?.phone || "";
  if (pendingAction==="call"){
    if (shopPhone) window.location.href = `tel:${shopPhone}`;
  } else {
    // WhatsApp to the shop owner
    const waNum = shopPhone.replace(/^\+/,'');
    const msg = `Hello, I saw your item *${pendingContactFor?.itemTitle||''}* on PickMe (Tek&gaget).`;
    if (waNum) window.location.href = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
  }
  closeNumberModal();
});

/* ======== Admin: per-shop access ======== */
function openModal(m){ m.classList.add('show'); }
function closeModal(m){ m.classList.remove('show'); }

function promptShopCode(){
  codeInput.value = "";
  openModal(codeModal);
}
[codeClose, codeCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(codeModal)));
codeOk.addEventListener('click', ()=>{
  const input = codeInput.value.trim();
  const expected = (currentShop?.accessCode) || SHOP_ADMIN_DEFAULT_CODE;
  if (input && input===expected){
    closeModal(codeModal);
    openModal(adminOptionsModal);
  } else {
    alert("Incorrect code.");
  }
});
[adminOptClose, adminOptCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(adminOptionsModal)));

/* ======== Admin options actions ======== */
optAdd.addEventListener('click', ()=>{
  closeModal(adminOptionsModal);
  // choose category (only those in shop.categories)
  catChooseGrid.innerHTML = "";
  (currentShop?.categories||CATEGORIES.map(c=>c.id)).forEach(c=>{
    const div = document.createElement('div');
    div.className="mopt-card";
    div.innerHTML = `<h4>${escapeHtml(c)}</h4><p>Add an advert in this category</p>`;
    div.addEventListener('click', ()=> startAddFlow(c));
    catChooseGrid.appendChild(div);
  });
  openModal(catChooseModal);
});
[catChooseClose, catChooseCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(catChooseModal)));

optDelete.addEventListener('click', async ()=>{
  closeModal(adminOptionsModal);
  // list current items with delete buttons
  deleteList.innerHTML = "<p>Loading items…</p>";
  openModal(deleteModal);
  const items = await fetchShopItems(currentShopName);
  deleteList.innerHTML = "";
  if (!items.length){ deleteList.innerHTML = "<p>No items to delete.</p>"; return; }
  items.forEach(ad=>{
    const blk = document.createElement('div');
    blk.className="mopt-card";
    blk.innerHTML = `<h4>${escapeHtml(ad.name||'Item')}</h4><p>${escapeHtml(ad.category||'')}</p><button class="btn-secondary">Delete</button>`;
    blk.querySelector('button').addEventListener('click', ()=> deleteAd(ad));
    deleteList.appendChild(blk);
  });
});
[deleteClose, deleteCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(deleteModal)));

async function deleteAd(ad){
  if (!confirm("Delete this item permanently?")) return;
  // delete Firestore doc
  try{
    await deleteDoc(doc(db, PAGE_KEY, "Shops", currentShopName, "items", ad.id));
  }catch(e){ console.warn("delete doc err", e); }
  // delete images in Storage
  try{
    const folder = sRef(st, `${PAGE_KEY}/${currentShopName}/${ad.id}/`);
    const listing = await listAll(folder);
    await Promise.all(listing.items.map(obj=> deleteObject(obj)));
  }catch(e){ console.warn("delete images err", e); }
  alert("Deleted.");
  closeModal(deleteModal);
  // refresh caches
  localStorage.removeItem(CACHE.shopItems(currentShopName));
  localStorage.removeItem(CACHE.shops);
  // refresh view
  renderShops();
  if (currentShop) openShop(currentShop);
}

/* ======== Add flow ======== */
let currentAddCategory = null;
function startAddFlow(category){
  currentAddCategory = category;
  closeModal(catChooseModal);
  openDraftEditor();
}
function openDraftEditor(){
  draftTitle.textContent = `Add items · ${currentAddCategory}`;
  imgInput.value = "";
  imgThumbs.innerHTML = "";
  nameInput.value = "";
  priceInput.value = "";
  descInput.value = "";
  openModal(draftModal);
}
draftClose.addEventListener('click', ()=> closeModal(draftModal));

/* thumbnails state for current form */
let filesBuffer = []; // File[]
function refreshThumbs(){
  imgThumbs.innerHTML = "";
  filesBuffer.forEach((file, idx)=>{
    const url = URL.createObjectURL(file);
    const t = document.createElement('div');
    t.className='thumb';
    t.innerHTML = `<img src="${url}"><button class="trash" title="Remove">&times;</button>`;
    t.querySelector('.trash').addEventListener('click', ()=>{
      filesBuffer.splice(idx,1);
      refreshThumbs();
    });
    imgThumbs.appendChild(t);
  });
}
imgInput.addEventListener('change', ()=>{
  const list = Array.from(imgInput.files||[]);
  const wanted = Math.min(MAX_IMAGES - filesBuffer.length, list.length);
  filesBuffer.push(...list.slice(0, wanted));
  refreshThumbs();
});

function pushDraftFromForm(){
  const nm = nameInput.value.trim();
  const pr = money(priceInput.value);
  const ds = descInput.value.trim();
  if (!nm){ alert("Enter name"); return false; }
  if (!filesBuffer.length){ alert("Add at least 1 image"); return false; }
  const id = makeId();
  drafts.push({ id, cat: currentAddCategory, name:nm, price:pr, desc:ds, files:[...filesBuffer] });
  // visual in draft list
  renderDraftList();
  // clear form for next (same category)
  filesBuffer = []; refreshThumbs(); nameInput.value=""; priceInput.value=""; descInput.value="";
  return true;
}
function renderDraftList(){
  draftList.innerHTML = "";
  drafts.forEach((d, i)=>{
    const wrap = document.createElement('div');
    wrap.className="mopt-card";
    wrap.innerHTML = `
      <h4>#${i+1} ${escapeHtml(d.name)}</h4>
      <p>${escapeHtml(d.cat)} · ${fmtPrice(d.price)} · ${d.files.length} image(s)</p>
      <p style="white-space:pre-wrap">${escapeHtml(d.desc||'')}</p>
    `;
    draftList.appendChild(wrap);
  });
}

addMoreBtn.addEventListener('click', ()=>{
  if (pushDraftFromForm()) {
    // stay, continue adding in same category
  }
});

submitDraftsBtn.addEventListener('click', async ()=>{
  if (!drafts.length){
    // if nothing yet, try to push current
    if (!pushDraftFromForm()) return;
  }
  // Upload images to storage temp path and create payload
  const payload = {
    type:"review",
    page: PAGE_KEY,
    shop: currentShopName,
    items: []
  };
  for (const d of drafts){
    const adId = d.id;
    const urls = [];
    let idx=1;
    for (const f of d.files){
      const key = `${PAGE_KEY}/${currentShopName}/${adId}/img_${idx}.jpg`;
      const rf = sRef(st, key);
      const snap = await uploadBytes(rf, f);
      const url = await getDownloadURL(sRef(st, snap.metadata.fullPath));
      urls.push(url);
      idx++;
    }
    payload.items.push({
      id: adId,
      category: d.cat,
      name: d.name,
      price: d.price,
      desc: d.desc,
      images: urls
    });
  }
  // short link
  const id = makeId();
  await setDoc(doc(linksCol, id), {
    payload, createdAt: serverTimestamp()
  });
  closeModal(draftModal);
  drafts = []; filesBuffer = []; refreshThumbs(); draftList.innerHTML="";

  // WhatsApp to PickMe
  const link = `${location.origin}${location.pathname}?review=${id}`;
  const msg = `New Tek&gaget adverts from *${currentShopName}*.\nOpen: ${link}`;
  window.location.href = `https://wa.me/${PICKME_WHATSAPP}?text=${encodeURIComponent(msg)}`;
});

/* ======== Review Flow (PickMe) ======== */
async function getShort(id){
  const snap = await getDoc(doc(linksCol, id));
  return snap.exists()? (snap.data().payload||null) : null;
}
async function putShort(payload){
  const id = makeId();
  await setDoc(doc(linksCol, id), { payload, createdAt: serverTimestamp() });
  return id;
}

function promptReviewCode(){
  openModal(reviewCodeModal);
}
[reviewCodeClose, reviewCodeCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(reviewCodeModal)));
reviewCodeOk.addEventListener('click', async ()=>{
  if (reviewCodeInput.value.trim()!==GLOBAL_ADMIN_CODE){ alert("Incorrect admin code."); return; }
  closeModal(reviewCodeModal);
  // continue (the router already drew the page)
});

/* Render review UI in-page (reuse drawer) */
async function openReview(payload){
  // simple in-page renderer (read-only)
  hide(shopBanner); hide(shopTopActions);
  show(itemDetail);
  // Build a stack of items with approve/reject
  const container = document.createElement('div');
  container.style.marginTop = "8px";
  container.innerHTML = `<div class="section-title">Review · ${escapeHtml(payload.shop)}</div>`;
  const states = []; // {id, approve:boolean|null, reason:string|null}

  payload.items.forEach((it, idx)=>{
    const box = document.createElement('div');
    box.className = "mopt-card";
    const holder = document.createElement('div');
    holder.style.marginBottom = "8px";
    const slider = document.createElement('div'); slider.className="slider";
    const dots = document.createElement('div'); dots.className="dots";
    holder.appendChild(slider); holder.appendChild(dots);
    box.appendChild(holder);

    // fill slider
    buildSlider(it.images||[], slider, dots);

    const meta = document.createElement('div');
    meta.innerHTML = `
      <h4 style="margin:8px 0 4px">#${idx+1} ${escapeHtml(it.name)}</h4>
      <div>${escapeHtml(it.category||'')}</div>
      <div>${fmtPrice(it.price)}</div>
      <div style="white-space:pre-wrap;margin-top:6px">${escapeHtml(it.desc||'')}</div>
    `;
    box.appendChild(meta);

    // controls
    const row = document.createElement('div'); row.className="row"; row.style.marginTop="8px";
    const approve = document.createElement('button'); approve.className="btn-primary"; approve.textContent="Approve";
    const reject = document.createElement('button'); reject.className="btn-secondary"; reject.textContent="Reject";
    row.appendChild(approve); row.appendChild(reject);
    box.appendChild(row);

    const st = { id: it.id, approve: null, reason:null, data:it };
    states.push(st);

    approve.onclick = ()=>{ st.approve = true; st.reason=null; approve.style.opacity="1"; reject.style.opacity="0.5"; };
    reject.onclick = async ()=>{
      // reason modal (quick prompt for now with dropdown)
      const reason = prompt("Reason (e.g., blurry images, wrong price, prohibited item, other…):","");
      st.approve = false; st.reason = reason||"Rejected by admin";
      approve.style.opacity="0.5"; reject.style.opacity="1";
    };

    container.appendChild(box);
  });

  // Done button
  const done = document.createElement('button');
  done.className="btn-primary";
  done.style.marginTop="10px";
  done.textContent="Done";
  done.onclick = async ()=>{
    // split approved / rejected
    const approved = states.filter(s=>s.approve===true).map(s=>s.data);
    const rejected = states.filter(s=>s.approve===false).map(s=>({ ...s.data, reason:s.reason||"Rejected" }));

    // commit approved to Firestore
    await Promise.all(approved.map(async it=>{
      const ref = doc(db, PAGE_KEY, "Shops", payload.shop, "items", it.id);
      await setDoc(ref, {
        id: it.id,
        shop: payload.shop,
        category: it.category,
        name: it.name,
        price: it.price,
        desc: it.desc,
        images: it.images||[],
        createdAt: serverTimestamp()
      }, { merge:true });
    }));

    // result payload
    const result = { type:"result", page:PAGE_KEY, shop:payload.shop, approved, rejected };
    const id2 = await putShort(result);

    // notify shop via WhatsApp
    const shopPhone = (SHOPS.find(s=>s.name===payload.shop)?.phone)||"";
    const link = `${location.origin}${location.pathname}?result=${id2}`;
    const msg = `Your Tek&gaget adverts were reviewed.\nOpen results: ${link}`;
    if (shopPhone) window.location.href = `https://wa.me/${shopPhone.replace(/^\+/,'')}?text=${encodeURIComponent(msg)}`;
    else alert("Result link:\n"+link);

    // refresh caches
    localStorage.removeItem(CACHE.shopItems(payload.shop));
    localStorage.removeItem(CACHE.cats);
    localStorage.removeItem(CACHE.shops);
  };

  // paint into itemDetail area
  itemSlider.innerHTML = ""; itemDots.innerHTML="";
  detailTitle.textContent = "Review panel";
  detailPrice.textContent = "";
  detailPostedBy.textContent = "";
  detailDesc.textContent = "";
  const host = document.createElement('div'); host.style.marginTop="10px";
  host.appendChild(container);
  host.appendChild(done);
  // replace the existing detail container content
  const detailContainer = itemDetail.querySelector('.item-detail');
  detailContainer.innerHTML = "";
  detailContainer.appendChild(host);
  openDrawer();
}

/* ======== Result view (shop owner) ======== */
async function openResult(payload){
  hide(shopBanner); hide(shopTopActions);
  show(itemDetail);
  itemSlider.innerHTML = ""; itemDots.innerHTML="";
  detailTitle.textContent = "Submission results";
  detailPrice.textContent = "";
  detailPostedBy.textContent = payload.shop||"";
  detailDesc.textContent = "";

  const host = document.createElement('div');
  const secA = document.createElement('div'); secA.innerHTML = `<div class="section-title">Approved</div>`;
  const listA = document.createElement('div'); listA.className="items-grid";
  (payload.approved||[]).forEach(ad=> renderItemCard(listA, ad));
  if (!(payload.approved||[]).length) listA.innerHTML = "<p>No approved items.</p>";
  secA.appendChild(listA);

  const secR = document.createElement('div'); secR.style.marginTop="10px";
  secR.innerHTML = `<div class="section-title">Rejected</div>`;
  const listR = document.createElement('div'); listR.className="items-grid";
  (payload.rejected||[]).forEach(ad=>{
    const card = document.createElement('div'); card.className="item-card";
    card.innerHTML = `
      <div class="item-img"><img src="${(ad.images&&ad.images[0])||'https://via.placeholder.com/600x400?text=Image'}"></div>
      <div class="item-body">
        <div class="item-price">${fmtPrice(ad.price)}</div>
        <div class="item-desc">${escapeHtml(ad.desc||'')}</div>
        <div class="item-shop">Reason: ${escapeHtml(ad.reason||'')}</div>
      </div>
    `;
    listR.appendChild(card);
  });
  if (!(payload.rejected||[]).length) listR.innerHTML = "<p>No rejected items.</p>";
  secR.appendChild(listR);

  const done = document.createElement('button'); done.className="btn-primary"; done.style.marginTop="10px"; done.textContent="Done";
  done.onclick = ()=> closeDrawer();

  const detailContainer = itemDetail.querySelector('.item-detail');
  detailContainer.innerHTML = "";
  detailContainer.appendChild(secA);
  detailContainer.appendChild(secR);
  detailContainer.appendChild(done);
  openDrawer();
}

/* ======== Router ======== */
async function router(){
  const url = new URL(location.href);
  const reviewId = url.searchParams.get("review");
  const resultId = url.searchParams.get("result");

  document.body.classList.remove("ready");
  document.body.classList.add("hide-initial");

  try{
    if (reviewId){
      const payload = await getShort(reviewId);
      if (!payload || payload.type!=="review"){ alert("Invalid review link."); }
      else{
        promptReviewCode();
        // Wait a tick so code modal shows before building
        setTimeout(()=> openReview(payload), 50);
        document.body.classList.remove("hide-initial"); document.body.classList.add("ready");
        return;
      }
    }
    if (resultId){
      const payload = await getShort(resultId);
      if (!payload || payload.type!=="result"){ alert("Invalid result link."); }
      else{
        openResult(payload);
        document.body.classList.remove("hide-initial"); document.body.classList.add("ready");
        return;
      }
    }

    // normal home
    show(categoriesView); document.querySelector('.main-tab[data-view="categoriesView"]').classList.add('active');
    document.querySelector('.main-tab[data-view="shopsView"]').classList.remove('active');
    document.body.classList.remove("hide-initial"); document.body.classList.add("ready");
  }catch(e){
    console.error("router error:", e);
    document.body.classList.remove("hide-initial"); document.body.classList.add("ready");
  }
}

/* ======== Init page ======== */
async function renderCategories(){
  const counts = await countByCategory();
  renderCategoriesGrid(counts);
}
async function renderShops(){
  const counts = await fetchShopCounts();
  renderShopsGrid(counts);
}

document.addEventListener("DOMContentLoaded", async () => {
  await upsertShopsMeta().catch(()=>{});
  await renderCategories().catch(()=>{});
  await renderShops().catch(()=>{});
  router();
});
const fallbackCounts = {};
SHOPS.forEach(shop => { fallbackCounts[shop.name] = 0; });
renderShopsGrid(fallbackCounts);
</script>

<!-- ========= FOOTER ========= -->
<div class="footer-wrap">
  <iframe src="footer.html" style="width:100%;height:60px;border:none;overflow:hidden" scrolling="no"></iframe>
</div>

</body>
</html>

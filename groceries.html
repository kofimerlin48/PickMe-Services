<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Groceries - PickMe Services</title>

<!-- =========HEADER CODE STARTS HERE ================== -->
<div id="header-placeholder"></div>
<script>
(async () => {
  try {
    const response = await fetch('header.html');
    if (!response.ok) throw new Error('Failed to load header');
    let html = await response.text();
    const pageTitle = "Groceries";
    html = html.replace(/<h1[^>]*>.*?<\/h1>/i,
      `<h1 style="margin:0; font-weight:bold; color:#c12872; font-size:24px; position:absolute; left:50%; transform:translateX(-50%);">${pageTitle}</h1>`
    );
    document.getElementById('header-placeholder').innerHTML = html;
    document.querySelectorAll('#header-placeholder script').forEach(oldScript => {
      const s = document.createElement('script');
      if (oldScript.src) s.src = oldScript.src;
      else s.textContent = oldScript.textContent;
      document.body.appendChild(s);
    });
  } catch (err) { console.error(err); }
})();
</script>
<!-- =========HEADER CODE ENDS HERE ================== -->

<style>
:root{ --theme-color:#c12872; }

*{box-sizing:border-box}
* { -webkit-tap-highlight-color: transparent; }
:focus, :focus-visible, button:focus, input:focus { outline: none !important; box-shadow: none !important; }

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f9f9f9;
  padding-top:100px;
  overflow-x:hidden;
}

.page-header{text-align:center;margin-bottom:20px;}
.page-header h1{color:var(--theme-color);margin:0;font-size:28px;}
.page-header p{color:#000;margin-top:5px;font-size:16px;font-weight:bold;}

.search-bar{display:flex;justify-content:center;margin:10px 16px 6px;}
.search-bar input{width:100%;max-width:480px;padding:10px 14px;border:1px solid #ccc;border-radius:8px;font-size:16px;}

.tabs{display:flex;gap:8px;overflow-x:auto;padding:8px 16px;border-bottom:2px solid #eee;}
.tab{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid #eee;cursor:pointer;white-space:nowrap;font-size:14px;}
.tab.active{color:#fff;background:var(--theme-color);border-color:var(--theme-color);}

/* EXTRA BOTTOM SPACE so footer iframe doesn't block last card */
.cards-container{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:70px;padding:20px;
  padding-bottom:160px;
}
.card{
  position:relative;border-radius:15px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.1);
  background-size:cover;background-position:center;height:250px;display:flex;align-items:flex-end;transition:transform .2s;
}
.card:hover{transform:translateY(-5px)}
.card::before{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.8), rgba(0,0,0,0))}
.card-content{position:relative;color:#fff;padding:15px;width:100%;display:flex;flex-direction:column;justify-content:space-between;z-index:1}
.card-title{font-weight:bold;font-size:22px;margin-bottom:4px}
.card-description{font-size:13px;opacity:.95;margin-bottom:4px}

/* trusted buyers + button line */
.card-lower { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
.card-meta { font-size:12px; opacity:0.9; margin:0; }

.btn-enter{background:var(--theme-color);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;align-self:flex-end}

/* ============ DETAILS PANEL ============ */
#detailsPanel{
  position:fixed;top:0;right:-100%;width:100%;max-width:1100px;height:100%;
  background:#fff;z-index:9999;overflow-y:auto;transition:right .5s ease;box-shadow:-5px 0 15px rgba(0,0,0,.2);
  padding-bottom:140px;
}
#detailsPanel.show{right:0;}
#detailsBackBtn{
  position:fixed;top:15px;right:-60px;width:40px;height:40px;background:#000;color:#fff;border:none;border-radius:50%;
  font-size:24px;cursor:pointer;z-index:10000;display:flex;align-items:center;justify-content:center;transition:right .5s ease;
}
#detailsPanel.show #detailsBackBtn{right:15px;}

/* Shorter banner with darker overlay (full readability) */
.banner{
  position:relative;width:100%;height:35vh;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;
  background:#333 center/cover no-repeat;
}
.banner::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.22), rgba(0,0,0,.70), rgba(0,0,0,.80));
}
.banner-text{position:relative;z-index:2}
.banner-text h2{font-size:16px;margin:0 0 6px}
.banner-text h1{font-size:26px;margin:0 0 8px}
.banner-text p{font-size:13px;margin:0;opacity:.95}

.details-content{padding:18px;max-width:1100px;margin:0 auto}
.section-title{font-weight:bold;margin:8px 0 12px;color:#333}

/* Carousel */
.carousel{position:relative;width:100%;height:240px;overflow:hidden;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.carousel img{
  position:absolute;top:0;left:100%;width:100%;height:100%;object-fit:cover;opacity:0;transition:left .45s ease, opacity .45s ease;
}
.carousel img.active{left:0;opacity:1}
.carousel .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:24px;color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:50%;cursor:pointer;user-select:none}
.carousel .nav.left{left:10px}
.carousel .nav.right{right:10px}
.dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.dot{width:8px;height:8px;border-radius:50%;background:#ddd}
.dot.active{background:var(--theme-color)}

/* Add Items button (raised up) */
.action-row{display:flex;justify-content:center;margin:22px 0 120px;}
.btn-primary{background:var(--theme-color);color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-size:15px}

/* Modal form */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10001;}
.modal.show{display:flex}
.modal-card{width:95%;max-width:560px;background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden;max-height:90vh;display:flex;flex-direction:column;}
.modal-header{padding:14px 16px;border-bottom:1px solid #eee;font-weight:bold}
.modal-body{padding:16px;overflow-y:auto;max-height:calc(90vh - 120px)}
.modal-footer{padding:14px 16px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end}

/* item card layout ‚Äî screenshot style */
.item-card{
  background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:12px 12px 10px;margin-bottom:12px;
}
.item-top{display:flex;align-items:center;gap:10px}
.item-num{font-weight:700;color:#333;min-width:22px;text-align:right}
.item-name{
  flex:1;border:none;border-bottom:1px solid #eee;padding:8px 6px 6px;font-size:15px;
  transition:border-color .2s, box-shadow .2s;
}
.item-name::placeholder{color:#aaa}
.item-name:focus{border-color:var(--theme-color);box-shadow:0 0 4px rgba(193,40,114,0.5);}

/* dustbin icon always visible (inline SVG) */
.item-del{
  margin-left:8px;background:var(--theme-color);border:none;color:#fff;border-radius:50%;
  width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;position:relative;z-index:2;
}
.item-del svg{width:20px;height:20px;fill:#fff;display:block;pointer-events:none;}

/* Quantity section */
.item-qty{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
.qty-label{font-size:12px;color:#666;margin-left:4px;}
.qty-controls{display:flex;align-items:center;gap:8px;}
/* dark ash buttons */
.qty-btn{ width:38px;height:38px;border:none;border-radius:8px;background:#3a3a3a;color:#fff;font-size:22px;cursor:pointer; }
.qty-btn:active{filter:brightness(0.9);}
.qty-input{
  width:64px;height:38px;border:1px solid #ccc;border-radius:8px;text-align:center;font-size:16px;
  transition:border-color .2s, box-shadow .2s;
}
.qty-input:focus{border-color:var(--theme-color);box-shadow:0 0 4px rgba(193,40,114,0.5);}
.qty-input::-webkit-outer-spin-button,.qty-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.qty-input[type=number]{-moz-appearance:textfield}

.small-note{font-size:12px;color:#666;margin:8px 0 0}
.whats-row{display:grid;grid-template-columns:1fr;gap:8px;margin-top:12px}
#whatsappInput{
  padding:14px 12px;height:52px;border:1px solid #ddd;border-radius:10px;font-size:16px;
  transition:border-color .2s, box-shadow .2s;
}
#whatsappInput:focus{border-color:var(--theme-color);box-shadow:0 0 4px rgba(193,40,114,0.5);}
.error{color:#b00020;font-size:13px;margin-top:8px;display:none}

/* ===== Admin (Hidden) Panel ===== */
#adminPanel{
  position:fixed; inset:0; background:#fff; z-index:10002; display:none;
  overflow-y:auto; padding:16px 16px 90px;
}
#adminPanel .admin-top{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
#adminPanel .admin-top h2{margin:0; font-size:18px;}
#adminPanel .close-admin{background:#000; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;}

.admin-shop-actions{display:flex; gap:8px; margin:8px 0 14px;}
.admin-shop-actions a{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:8px; text-decoration:none; color:#fff; font-size:14px;}
.call-btn{background:#0a7d0a;}
.wa-btn{background:#25D366;}

.admin-section{margin:10px 0 16px;}
.group-title{font-weight:700; margin:10px 0 8px;}

.admin-item{
  border:1px solid #eee; border-radius:10px; padding:10px; margin:8px 0; display:grid;
  grid-template-columns: 1fr 110px 90px; grid-template-areas:
  "name qty subtotal"
  "avail price subtotal";
  gap:6px 10px; align-items:center;
}
.ai-name{ grid-area:name; font-weight:600; }
.ai-qty{ grid-area:qty; display:flex; align-items:center; gap:6px; justify-content:flex-end; }
.ai-qty .qty-btn{ width:30px; height:30px; font-size:18px; }
.ai-qty .qty-input{ width:54px; height:32px; font-size:14px; }
.ai-avail{ grid-area:avail; }
.ai-price{ grid-area:price; }
.ai-price input{ width:140px; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
.ai-sub{ grid-area:subtotal; text-align:right; font-weight:700; }

.avail-toggle{padding:6px 10px; border-radius:999px; border:1px solid #ddd; cursor:pointer; background:#f7f7f7; font-size:13px;}
.avail-toggle.on{background:#e9fff1; border-color:#b7e7c5; color:#146c2e;}
.avail-toggle.off{background:#fff3f3; border-color:#f0c3c3; color:#8a1c1c;}

.admin-fee-row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
.fee-input{display:flex; align-items:center; gap:6px; background:#fff; border:1px solid #eee; border-radius:8px; padding:6px 8px;}
.fee-input input{width:90px; border:none; outline:none; font-weight:600;}

.admin-totals{margin-top:10px; padding-top:8px; border-top:1px dashed #ddd;}
.admin-totals div{margin:6px 0;}
.admin-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px;}
.btn{border:none; border-radius:10px; padding:10px 14px; cursor:pointer;}
.btn-done{background:var(--theme-color); color:#fff;}
.btn-cancel{background:#777; color:#fff;}

/* ===== Customer (Hidden) Panel ===== */
#customerPanel{
  position:fixed; inset:0; background:#fff; z-index:10002; display:none;
  overflow-y:auto; padding:16px 16px 90px;
}
.cust-top{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.cust-top h2{margin:0; font-size:18px;}
.cust-close{background:#000; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;}
.cust-card{border:1px solid #eee; border-radius:10px; padding:12px; margin:10px 0;}
.cust-items h3{margin:0 0 8px 0; font-size:16px;}
.cust-list li{margin:6px 0;}
.cust-totals{margin-top:10px; border-top:1px dashed #ddd; padding-top:10px; font-weight:600;}
.cust-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px;}
.cust-btn{border:none; border-radius:10px; padding:10px 14px; cursor:pointer; }
.cust-pay{background:var(--theme-color); color:#fff;}
.cust-cancel{background:#777; color:#fff;}

/* Footer iframe pinned */
.footer-wrap{position:fixed;bottom:0;width:100%;z-index:9999}
</style>
</head>
<body>

<div class="page-header" id="homeHeader">
  <h1></h1>
  <p>Find grocery shops around you and send your list</p>
</div>

<div class="search-bar" id="homeSearch">
  <input type="text" id="searchInput" placeholder="Search grocery shops...">
</div>

<div class="tabs" id="tabs">
  <div class="tab active" data-cat="All">All</div>
  <div class="tab" data-cat="Stores">Stores</div>
  <div class="tab" data-cat="Supermarkets">Supermarkets</div>
  <div class="tab" data-cat="Market">Market</div>
</div>

<div class="cards-container" id="cardsContainer"></div>

<!-- ================= DETAILS PANEL ================= -->
<div id="detailsPanel">
  <button id="detailsBackBtn">&times;</button>
  <section class="banner" id="detailsBanner">
    <div class="banner-text">
      <h2>Welcome to</h2>
      <h1 id="shopName"></h1>
      <p id="shopSlogan"></p>
    </div>
  </section>

  <div class="details-content">
    <div class="section-title">Sample of items sold</div>
    <div class="carousel" id="carousel"></div>
    <div class="dots" id="dots"></div>
    <div class="action-row">
      <button class="btn-primary" id="openFormBtn">+ Add Items</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Add Items Form ===== -->
<div class="modal" id="formModal">
  <div class="modal-card">
    <div class="modal-header">List your items</div>
    <div class="modal-body">
      <div id="itemsHolder"></div>
      <button class="btn-primary" id="addRowBtn" style="margin:8px 0 0">Add another item</button>
      <div class="whats-row">
        <input type="tel" id="whatsappInput" placeholder="Your WhatsApp (+233‚Ä¶ or 0‚Ä¶)" />
        <div class="small-note">We‚Äôll message you back on WhatsApp after confirming prices.</div>
      </div>
      <div class="error" id="formError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="cancelBtn" style="background:#777">Cancel</button>
      <button class="btn-primary" id="submitBtn">Submit</button>
    </div>
  </div>
</div>

<!-- ===== Hidden Admin Panel (query: ?admin=ID) ===== -->
<div id="adminPanel" aria-hidden="true">
  <div class="admin-top">
    <div>
      <h2 id="adminShop">Order</h2>
      <div class="admin-shop-actions" id="adminShopActions">
        <!-- filled dynamically: Call / WhatsApp -->
      </div>
    </div>
    <button class="close-admin" id="closeAdminBtn">Close</button>
  </div>

  <div class="admin-section">
    <div class="group-title">Available items</div>
    <div id="adminAvail"></div>
  </div>
  <div class="admin-section">
    <div class="group-title">Unavailable items</div>
    <div id="adminUnavail"></div>
  </div>

  <div class="admin-section">
    <div class="group-title">Fees</div>
    <div class="admin-fee-row">
      <label class="fee-input">Service: GH‚Çµ <input type="number" min="0" step="1" id="feeServiceInput"></label>
      <label class="fee-input">Delivery: GH‚Çµ <input type="number" min="0" step="1" id="feeDeliveryInput"></label>
    </div>
  </div>

  <div class="admin-totals">
    <div>Items total: GH‚Çµ <span id="adminItemsTotal">0</span></div>
    <div>Grand total (with fees): GH‚Çµ <span id="adminGrandTotal">0</span></div>
  </div>

  <div class="admin-actions">
    <button class="btn btn-cancel" id="adminCancel">Cancel</button>
    <button class="btn btn-done" id="adminDone">Done</button>
  </div>
</div>

<!-- ===== Hidden Customer Panel (query: ?order=ID) ===== -->
<div id="customerPanel" aria-hidden="true">
  <div class="cust-top">
    <h2 id="custShop">Order</h2>
    <button class="cust-close" id="closeCustomerBtn">Close</button>
  </div>

  <div class="cust-card cust-items">
    <h3>Available items</h3>
    <ul id="custAvail" class="cust-list"></ul>
    <h3 style="margin-top:12px;">Unavailable items</h3>
    <ul id="custUnavail" class="cust-list"></ul>
    <div class="cust-totals">
      <div>Items total: GH‚Çµ <span id="custItemsTotal">0</span></div>
      <div>Grand total (with fees): GH‚Çµ <span id="custGrandTotal">0</span></div>
    </div>
  </div>

  <div class="cust-actions">
    <button class="cust-btn cust-cancel" id="custCancel">Cancel</button>
    <button class="cust-btn cust-pay" id="custPay">Proceed to payment</button>
  </div>
</div>

<!-- ========= FIREBASE + PAGE LOGIC ========= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2L649fIs0CS-fGDC0ybFeAO5Im5BEP_c",
    authDomain: "pickmeservicesonline.firebaseapp.com",
    projectId: "pickmeservicesonline",
    storageBucket: "pickmeservicesonline.firebasestorage.app",
    messagingSenderId: "265031616239",
    appId: "1:265031616239:web:e2ef418704af5595aa7d1a"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* Fees (editable in code) */
  const SERVICE_FEE  = 5;   // GH‚Çµ
  const DELIVERY_FEE = 15;  // GH‚Çµ

  /* Hard-coded shops & images (replace URLs with your Drive links) */
  const GROCERY_DATA = [
    {
      name: "E&G Supermarket",
      slogan: "Everything household & fresh",
      category: "Supermarkets",
      heroImage: "https://lh3.googleusercontent.com/d/1rfAPWnEAa4kpCEUyldYl5KEkjXE48QYV",
      samples: [
        "https://via.placeholder.com/1000x600?text=Rice+Bags",
        "https://via.placeholder.com/1000x600?text=Canned+Foods",
        "https://via.placeholder.com/1000x600?text=Beverages",
        "https://via.placeholder.com/1000x600?text=Toiletries"
      ],
      phone: "233201234567", // <‚Äî shop phone (no +)
      expiry: "2026-09-19"
    },
    {
      name: "FreshMart Store",
      slogan: "Your daily essentials",
      category: "Stores",
      heroImage: "https://via.placeholder.com/1200x700?text=FreshMart+Store",
      samples: [
        "https://via.placeholder.com/1000x600?text=Cooking+Oil",
        "https://via.placeholder.com/1000x600?text=Bread+%26+Eggs",
        "https://via.placeholder.com/1000x600?text=Soap+%26+Detergents"
      ],
      phone: "233209876543",
      expiry: "2025-12-31"
    },
    {
      name: "Kumasi Central Market",
      slogan: "All your perishables",
      category: "Market",
      heroImage: "https://via.placeholder.com/1200x700?text=Kumasi+Market",
      samples: [
        "https://via.placeholder.com/1000x600?text=Tomatoes",
        "https://via.placeholder.com/1000x600?text=Plantain",
        "https://via.placeholder.com/1000x600?text=Yam",
        "https://via.placeholder.com/1000x600?text=Pepper"
      ],
      phone: "233551112223",
      expiry: "2025-12-31"
    }
  ];

  /* Your PickMe WhatsApp receiver (no +) */
  const PICKME_WHATSAPP = "233534742142";

  /* Paystack link (replace with your real one) */
  const PAYSTACK_LINK = "https://paystack.com/pay/example-link";

  /* DOM refs (home) */
  const cardsContainer  = document.getElementById("cardsContainer");
  const searchInput     = document.getElementById("searchInput");
  const tabs            = document.querySelectorAll(".tab");
  const homeHeader      = document.getElementById("homeHeader");
  const homeSearch      = document.getElementById("homeSearch");

  /* details panel */
  const detailsPanel  = document.getElementById("detailsPanel");
  const detailsBackBtn= document.getElementById("detailsBackBtn");
  const detailsBanner = document.getElementById("detailsBanner");
  const shopNameEl    = document.getElementById("shopName");
  const shopSloganEl  = document.getElementById("shopSlogan");
  const carouselEl    = document.getElementById("carousel");
  const dotsEl        = document.getElementById("dots");
  const openFormBtn   = document.getElementById("openFormBtn");

  /* modal */
  const formModal     = document.getElementById("formModal");
  const itemsHolder   = document.getElementById("itemsHolder");
  const addRowBtn     = document.getElementById("addRowBtn");
  const whatsappInput = document.getElementById("whatsappInput");
  const submitBtn     = document.getElementById("submitBtn");
  const cancelBtn     = document.getElementById("cancelBtn");
  const formError     = document.getElementById("formError");

  /* Admin panel */
  const adminPanel      = document.getElementById("adminPanel");
  const adminShop       = document.getElementById("adminShop");
  const adminAvail      = document.getElementById("adminAvail");
  const adminUnavail    = document.getElementById("adminUnavail");
  const feeServiceInput = document.getElementById("feeServiceInput");
  const feeDeliveryInput= document.getElementById("feeDeliveryInput");
  const adminItemsTotal = document.getElementById("adminItemsTotal");
  const adminGrandTotal = document.getElementById("adminGrandTotal");
  const closeAdminBtn   = document.getElementById("closeAdminBtn");
  const adminCancelBtn  = document.getElementById("adminCancel");
  const adminDoneBtn    = document.getElementById("adminDone");
  const adminShopActions= document.getElementById("adminShopActions");

  /* Customer panel */
  const customerPanel   = document.getElementById("customerPanel");
  const closeCustomerBtn= document.getElementById("closeCustomerBtn");
  const custShop        = document.getElementById("custShop");
  const custAvail       = document.getElementById("custAvail");
  const custUnavail     = document.getElementById("custUnavail");
  const custItemsTotal  = document.getElementById("custItemsTotal");
  const custGrandTotal  = document.getElementById("custGrandTotal");
  const custPayBtn      = document.getElementById("custPay");
  const custCancelBtn   = document.getElementById("custCancel");

  let currentShop = null;
  let buyersCountMap = {};

  /* ===== Buyers count (for "Trusted by X Buyers" + sorting) ===== */
  async function fetchBuyersCount(shopName){
    try{
      const ref = collection(db, "GroceryPurchases", shopName, "buyers");
      const snap = await getDocs(ref);
      return snap.size || 0;
    }catch{ return 0; }
  }
  async function buildBuyersCountMap(){
    const entries = await Promise.all(GROCERY_DATA.map(async s => {
      const c = await fetchBuyersCount(s.name);
      return [s.name, c];
    }));
    buyersCountMap = Object.fromEntries(entries);
  }

  /* Expiry helper */
  function isExpired(isoDate){
    if (!isoDate) return false;
    const end = new Date(isoDate + "T23:59:59");
    const now = new Date();
    return now > end;
  }

  /* ===== Cards rendering ===== */
  function renderCards(activeCategory = "All", searchTerm = "") {
    cardsContainer.innerHTML = "";
    const term = searchTerm.trim().toLowerCase();

    const data = [...GROCERY_DATA]
      .filter(s => !isExpired(s.expiry))
      .sort((a,b)=>{
        const ca = buyersCountMap[a.name] || 0;
        const cb = buyersCountMap[b.name] || 0;
        if (cb !== ca) return cb - ca;
        return a.name.localeCompare(b.name);
      });

    data.forEach((shop) => {
      if (activeCategory !== "All" && shop.category !== activeCategory) return;
      if (term && !shop.name.toLowerCase().includes(term)) return;

      const buyers = buyersCountMap[shop.name] ?? 0;

      const card = document.createElement("div");
      card.className = "card";
      card.style.backgroundImage = `url('${shop.heroImage}')`;

      const content = document.createElement("div");
      content.className = "card-content";
      content.innerHTML = `
        <div>
          <div class="card-title">${escapeHtml(shop.name)}</div>
          <div class="card-description">${escapeHtml(shop.slogan || "")}</div>
        </div>
        <div class="card-lower">
          <div class="card-meta">‚≠ê Trusted by ${buyers} Buyers</div>
          <button class="btn-enter">Enter Shop</button>
        </div>
      `;
      content.querySelector(".btn-enter").addEventListener("click", () => openShop(shop));
      card.appendChild(content);
      cardsContainer.appendChild(card);
    });

    if (!cardsContainer.children.length) {
      cardsContainer.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#666;padding:20px;'>No shops available.</p>";
    }
  }

  function openShop(shop) {
    currentShop = shop;
    detailsBanner.style.backgroundImage = `url('${shop.heroImage}')`;
    shopNameEl.textContent = shop.name;
    shopSloganEl.textContent = shop.slogan || "";
    buildCarousel(shop.samples || []);
    detailsPanel.classList.add("show");
  }
  detailsBackBtn.addEventListener("click", () => detailsPanel.classList.remove("show"));

  /* ===== Carousel (right-in / left-out) ===== */
  function buildCarousel(images) {
    carouselEl.innerHTML = ""; dotsEl.innerHTML = "";
    if (!images || images.length === 0) return;

    images.forEach((src, i) => {
      const img = document.createElement("img");
      img.src = src; img.alt = `sample-${i+1}`;
      if (i === 0) img.classList.add("active");
      carouselEl.appendChild(img);

      const dot = document.createElement("div");
      dot.className = "dot" + (i===0 ? " active" : "");
      dot.addEventListener("click", () => goTo(i));
      dotsEl.appendChild(dot);
    });

    const left = document.createElement("div"); left.className="nav left"; left.innerHTML="&#10094;";
    const right = document.createElement("div"); right.className="nav right"; right.innerHTML="&#10095;";
    carouselEl.appendChild(left); carouselEl.appendChild(right);

    let current = 0;
    const slides = carouselEl.querySelectorAll("img");
    const dots   = dotsEl.querySelectorAll(".dot");

    function setPositions(prevIdx, nextIdx, direction){
      const prev = slides[prevIdx], next = slides[nextIdx];
      next.style.transition="none";
      next.style.left = (direction===1 ? "100%" : "-100%");
      next.style.opacity = "1"; void next.offsetWidth;
      prev.style.transition="left .45s ease, opacity .45s ease";
      next.style.transition="left .45s ease, opacity .45s ease";
      prev.style.left = (direction===1 ? "-100%" : "100%");
      prev.style.opacity = "1";
      next.style.left = "0";
    }
    function goTo(nextIndex){
      if (nextIndex === current) return;
      const dir = (nextIndex > current) ? 1 : -1;
      setPositions(current, nextIndex, dir);
      slides[current].classList.remove("active");
      slides[nextIndex].classList.add("active");
      dots[current].classList.remove("active");
      dots[nextIndex].classList.add("active");
      current = nextIndex;
    }
    left.addEventListener("click", () => goTo((current - 1 + slides.length) % slides.length));
    right.addEventListener("click", () => goTo((current + 1) % slides.length));

    let startX = 0;
    carouselEl.addEventListener("touchstart", e => startX = e.touches[0].clientX);
    carouselEl.addEventListener("touchend", e => {
      const endX = e.changedTouches[0].clientX;
      if (startX - endX > 40) right.click();
      if (endX - startX > 40) left.click();
    });
  }

  /* ==================== Modal open/close ==================== */
  function openForm(){
    formModal.classList.add("show");
    formError.style.display = "none";
    if (itemsHolder.children.length === 0) addRow();
    const firstName = itemsHolder.querySelector(".item-card .item-name");
    if (firstName) setTimeout(()=> firstName.focus(), 50);
  }
  function closeForm(){ formModal.classList.remove("show"); }
  document.getElementById("openFormBtn").addEventListener("click", openForm);
  cancelBtn.addEventListener("click", closeForm);

  /* ==================== Keep keyboard steady ==================== */
  let stickyFocusEl = null;
  formModal.addEventListener('focusin', (e) => {
    if (e.target.matches('input[type="text"], input[type="number"], input[type="tel"]')) stickyFocusEl = e.target;
  });
  formModal.addEventListener('mousedown', (e) => { if (e.target.closest('button')) e.preventDefault(); });
  function restoreFocusSoon(el=stickyFocusEl){ setTimeout(()=> { if (el) el.focus(); }, 0); }

  /* ==================== Item-card logic ==================== */
  function renumberRows(){
    const nums = itemsHolder.querySelectorAll(".item-num");
    nums.forEach((el, idx) => el.textContent = `${idx+1}.`);
  }

  function trashSVG(){
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h4v2h-1l-1 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 7H4V5h4V4a1 1 0 0 1 1-1zm2 0v1h2V3h-2z"/></svg>`;
  }

  function addRow(itemVal = "", qtyVal = "1"){
    const card = document.createElement("div");
    card.className = "item-card";
    card.innerHTML = `
      <div class="item-top">
        <div class="item-num"></div>
        <input class="item-name" type="text" placeholder="Enter item name" value="${escapeAttr(itemVal)}"/>
        <button class="item-del" title="Delete">${trashSVG()}</button>
      </div>
      <div class="item-qty">
        <div class="qty-label">Set quantity</div>
        <div class="qty-controls">
          <button class="qty-btn minus" type="button">‚àí</button>
          <input class="qty-input" type="number" inputmode="numeric" pattern="[0-9]*" min="1" step="1" value="${escapeAttr(qtyVal)}"/>
          <button class="qty-btn plus" type="button">+</button>
        </div>
      </div>
    `;
    const delBtn   = card.querySelector(".item-del");
    const minusBtn = card.querySelector(".minus");
    const plusBtn  = card.querySelector(".plus");
    const qtyInput = card.querySelector(".qty-input");
    const nameEl   = card.querySelector(".item-name");

    delBtn.addEventListener("click", () => {
      const toFocusNext = nameEl.closest(".item-card")?.nextElementSibling?.querySelector(".item-name")
                       || nameEl.closest(".item-card")?.previousElementSibling?.querySelector(".item-name");
      card.remove(); renumberRows();
      restoreFocusSoon(toFocusNext || stickyFocusEl);
    });
    minusBtn.addEventListener("click", () => {
      let v = parseInt(qtyInput.value || "1", 10); if (!v || v < 1) v = 1;
      if (v > 1) qtyInput.value = String(v - 1);
      restoreFocusSoon(qtyInput);
    });
    plusBtn.addEventListener("click", () => {
      let v = parseInt(qtyInput.value || "1", 10); if (!v || v < 1) v = 1;
      qtyInput.value = String(v + 1);
      restoreFocusSoon(qtyInput);
    });
    qtyInput.addEventListener("input", () => { qtyInput.value = qtyInput.value.replace(/[^\d]/g,''); });
    qtyInput.addEventListener("blur", () => {
      let v = parseInt(qtyInput.value || "1", 10);
      if (!v || v < 1) v = 1; qtyInput.value = String(v);
    });

    itemsHolder.appendChild(card);
    renumberRows();
    setTimeout(()=> nameEl.focus(), 0);
  }

  addRowBtn.addEventListener("click", () => {
    const last = itemsHolder.querySelector(".item-card:last-child .item-name");
    if (last && !last.value.trim()){ last.focus(); return; }
    addRow();
    const newest = itemsHolder.querySelector(".item-card:last-child .item-name");
    restoreFocusSoon(newest);
  });

  /* ===== WhatsApp number handling & saving ===== */
  async function saveCustomerWhatsApp(shopName, whatsappE164){
    try{
      const ref = collection(db, "GroceryCustomers", shopName, "customers");
      await addDoc(ref, { whatsapp: whatsappE164, timestamp: new Date().toISOString() });
    }catch(err){ console.error("Failed to save WhatsApp:", err); }
  }
  function normalizeGhanaNumber(input){
    let s = String(input).trim().replace(/[\s\-]/g,'');
    if (s.startsWith('+233')) return { e164: s, wa: s.slice(1) };
    if (s.startsWith('233'))  return { e164: '+'+s, wa: s };
    if (/^0\d{9}$/.test(s))   return { e164: '+233'+s.slice(1), wa: '233'+s.slice(1) };
    if (/^\d{9}$/.test(s))    return { e164: '+233'+s, wa: '233'+s };
    const digits = s.replace(/\D/g,'');
    if (digits.startsWith('233')) return { e164: '+'+digits, wa: digits };
    if (digits.length===10 && digits.startsWith('0')) return { e164: '+233'+digits.slice(1), wa: '233'+digits.slice(1) };
    return null;
  }

  /* ===== Short link store (sessionStorage) ===== */
  function putShort(data){
    const id = (Date.now().toString(36) + Math.random().toString(36).slice(2,8)).toLowerCase();
    sessionStorage.setItem("pkm_"+id, JSON.stringify(data));
    return id;
  }
  function getShort(id){
    try{
      return JSON.parse(sessionStorage.getItem("pkm_"+id));
    }catch{ return null; }
  }

  /* ===== Submit: validations & WhatsApp (no items in message) ===== */
  submitBtn.addEventListener("click", async () => {
    const rows = Array.from(itemsHolder.querySelectorAll(".item-card"));
    const items = rows.map((row) => {
      const nameEl = row.querySelector(".item-name");
      const qtyEl  = row.querySelector(".qty-input");
      const name = (nameEl.value||"").trim();
      let qty = parseInt((qtyEl.value||"1"), 10);
      if (!qty || qty < 1) qty = 1;
      return { name, qty };
    }).filter(x => x.name);

    const rawWhats = whatsappInput.value.trim();
    const normalized = normalizeGhanaNumber(rawWhats);

    if (items.length === 0) {
      formError.textContent = "Please add at least one item before submitting.";
      formError.style.display = "block";
      const firstName = itemsHolder.querySelector(".item-card .item-name");
      if (firstName) firstName.focus(); else { addRow(); setTimeout(()=> itemsHolder.querySelector(".item-card .item-name")?.focus(), 30); }
      return;
    }
    if (!normalized) {
      formError.textContent = "Please enter your WhatsApp number.";
      formError.style.display = "block";
      whatsappInput.focus();
      return;
    }
    formError.style.display = "none";

    const { e164, wa } = normalized;
    await saveCustomerWhatsApp(currentShop.name, e164);

    // admin payload for PickMe (no WA msg items)
    const adminPayload = {
      type: "admin",
      shop: currentShop.name,
      shopPhone: currentShop.phone || "",
      cust: e164,
      items: items.map(({name,qty})=>({name,qty,available:true,price:null})),
      fees: { service: SERVICE_FEE, delivery: DELIVERY_FEE }
    };
    const id = putShort(adminPayload);
    const link = `${location.origin}${location.pathname}?admin=${id}`;

    const msg =
`Hello PickMe Services,
I would like to buy from *${currentShop.name}*.

Open Order: ${link}`;
    const waUrl = `https://wa.me/${PICKME_WHATSAPP}?text=${encodeURIComponent(msg)}`;
    window.location.href = waUrl;

    formModal.classList.remove("show");
  });

  /* ===== Tabs + search ===== */
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      renderCards(tab.dataset.cat, searchInput.value);
    });
  });
  searchInput.addEventListener("input", () => {
    const activeTab = document.querySelector(".tab.active")?.dataset.cat || "All";
    renderCards(activeTab, searchInput.value);
  });

  /* ===== Helpers ===== */
  function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
  function escapeAttr(s){ return String(s||"").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

  /* ===== ADMIN PANEL ===== */
  function money(n){ return Number(n||0); }

  function drawAdminItem(idx, rec, container){
    const wrap = document.createElement("div");
    wrap.className = "admin-item";
    wrap.dataset.index = idx;

    wrap.innerHTML = `
      <div class="ai-name">${idx+1}. ${escapeHtml(rec.name)}</div>
      <div class="ai-qty">
        <button class="qty-btn minus" type="button">‚àí</button>
        <input class="qty-input" type="number" min="1" step="1" value="${rec.qty}"/>
        <button class="qty-btn plus" type="button">+</button>
      </div>
      <div class="ai-avail">
        <button class="avail-toggle ${rec.available?'on':'off'}">${rec.available?'Available':'Not available'}</button>
      </div>
      <div class="ai-price" ${rec.available?'':'style="display:none"'} >
        <input type="number" min="0" step="1" placeholder="Unit price (GH‚Çµ)" value="${rec.price??''}">
      </div>
      <div class="ai-sub">GH‚Çµ <span class="subv">0</span></div>
    `;

    const minus = wrap.querySelector('.minus');
    const plus  = wrap.querySelector('.plus');
    const qtyIn = wrap.querySelector('.qty-input');
    const avail = wrap.querySelector('.avail-toggle');
    const priceIn = wrap.querySelector('.ai-price input');
    const subV  = wrap.querySelector('.subv');

    function recalc(){
      const qty = Math.max(1, parseInt(qtyIn.value||'1',10));
      qtyIn.value = qty;
      const unit = rec.available ? money(priceIn.value||0) : 0;
      const sub  = rec.available ? qty * unit : 0;
      subV.textContent = sub.toFixed(2).replace(/\.00$/,'');
      updateTotals();
    }

    minus.addEventListener('click', ()=>{ qtyIn.stepDown(); if (parseInt(qtyIn.value,10)<1) qtyIn.value=1; rec.qty=parseInt(qtyIn.value,10); recalc(); });
    plus .addEventListener('click', ()=>{ qtyIn.stepUp(); rec.qty=parseInt(qtyIn.value,10); recalc(); });
    qtyIn.addEventListener('input', ()=>{ rec.qty = Math.max(1, parseInt(qtyIn.value||'1',10)); recalc(); });

    avail.addEventListener('click', ()=>{
      rec.available = !rec.available;
      avail.classList.toggle('on', rec.available);
      avail.classList.toggle('off', !rec.available);
      avail.textContent = rec.available ? 'Available' : 'Not available';
      if (rec.available){
        wrap.querySelector('.ai-price').style.display = '';
        (priceIn).focus();
        adminUnavail.removeChild(wrap);
        adminAvail.appendChild(wrap);
      } else {
        wrap.querySelector('.ai-price').style.display = 'none';
        priceIn.value = '';
        rec.price = null;
        adminAvail.removeChild(wrap);
        adminUnavail.appendChild(wrap);
      }
      recalc();
    });

    if (priceIn){
      priceIn.addEventListener('input', ()=>{ rec.price = priceIn.value===''?null:money(priceIn.value); recalc(); });
    }

    container.appendChild(wrap);
    recalc();
  }

  function updateTotals(){
    const allItems = currentAdmin.items;
    const itemsTotal = allItems.reduce((sum, it)=>{
      if (!it.available || it.price==null) return sum;
      return sum + (Math.max(1,it.qty) * money(it.price));
    }, 0);
    const service = money(feeServiceInput.value || SERVICE_FEE);
    const delivery= money(feeDeliveryInput.value || DELIVERY_FEE);
    adminItemsTotal.textContent = itemsTotal.toFixed(2).replace(/\.00$/,'');
    adminGrandTotal.textContent = (itemsTotal + service + delivery).toFixed(2).replace(/\.00$/,'');
  }

  let currentAdmin = null;

  function openAdmin(payload){
    currentAdmin = JSON.parse(JSON.stringify(payload)); // clone
    adminShop.textContent = `Order ¬∑ ${currentAdmin.shop || ''}`;

    // Call / WhatsApp shop actions
    adminShopActions.innerHTML = '';
    if (currentAdmin.shopPhone){
      const a1 = document.createElement('a');
      a1.href = `tel:${currentAdmin.shopPhone}`;
      a1.className='call-btn';
      a1.innerHTML = 'üìû Call';
      const a2 = document.createElement('a');
      a2.href = `https://wa.me/${currentAdmin.shopPhone}`;
      a2.target = '_blank';
      a2.className='wa-btn';
      a2.innerHTML = 'üü¢ WhatsApp';
      adminShopActions.appendChild(a1);
      adminShopActions.appendChild(a2);
    }

    adminAvail.innerHTML = '';
    adminUnavail.innerHTML = '';

    currentAdmin.items.forEach((rec, idx)=>{
      if (rec.available) drawAdminItem(idx, rec, adminAvail);
      else drawAdminItem(idx, rec, adminUnavail);
    });

    feeServiceInput.value  = currentAdmin.fees?.service ?? SERVICE_FEE;
    feeDeliveryInput.value = currentAdmin.fees?.delivery ?? DELIVERY_FEE;
    feeServiceInput.addEventListener('input', updateTotals);
    feeDeliveryInput.addEventListener('input', updateTotals);
    updateTotals();

    // Hide home immediately (no flash)
    homeHeader.style.display='none'; homeSearch.style.display='none';
    document.getElementById('tabs').style.display='none';
    cardsContainer.style.display='none';
    detailsPanel.classList.remove('show');

    adminPanel.style.display = 'block';
    adminPanel.setAttribute('aria-hidden','false');
  }

  closeAdminBtn.addEventListener('click', ()=>{ adminPanel.style.display='none'; adminPanel.setAttribute('aria-hidden','true'); });
  adminCancelBtn.addEventListener('click', ()=>{ adminPanel.style.display='none'; adminPanel.setAttribute('aria-hidden','true'); });

  // Done => send link to CUSTOMER via WhatsApp (no items in msg)
  adminDoneBtn.addEventListener('click', async ()=>{
    const useService = feeServiceInput.value==='' ? SERVICE_FEE : money(feeServiceInput.value);
    const useDelivery= feeDeliveryInput.value==='' ? DELIVERY_FEE : money(feeDeliveryInput.value);

    const customerPayload = {
      type: 'order',
      shop: currentAdmin.shop,
      items: currentAdmin.items.map(it=>({
        name: it.name,
        qty: Math.max(1, parseInt(it.qty||1,10)),
        available: !!it.available,
        price: (it.available && it.price!=null) ? money(it.price) : null
      })),
      fees: { service: useService, delivery: useDelivery }
    };
    const id = putShort(customerPayload);
    const link = `${location.origin}${location.pathname}?order=${id}`;

    // Open WhatsApp with prefilled message to the customer (cust is E.164; wa is without '+')
    const waNum = (currentAdmin.cust||'').replace(/^\+/, '');
    const msg =
`Hello, here is your order summary for *${currentAdmin.shop}*.
Open to view: ${link}`;
    const waUrl = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
    window.location.href = waUrl;
  });

  /* ===== CUSTOMER PANEL ===== */
  function openCustomer(data){
    custShop.textContent = `Order ¬∑ ${data.shop||''}`;
    custAvail.innerHTML = '';
    custUnavail.innerHTML = '';

    let itemsTotal = 0;
    (data.items||[]).forEach((it, i)=>{
      const li = document.createElement('li');
      if (it.available && it.price!=null){
        const sub = Math.max(1,parseInt(it.qty||1,10)) * money(it.price);
        itemsTotal += sub;
        li.textContent = `${i+1}. ${it.name} √ó ${it.qty} ‚Äî GH‚Çµ ${sub.toFixed(2).replace(/\.00$/,'')}`;
        custAvail.appendChild(li);
      } else {
        li.textContent = `${i+1}. ${it.name} √ó ${it.qty}`;
        custUnavail.appendChild(li);
      }
    });

    const service = money(data.fees?.service ?? SERVICE_FEE);
    const delivery= money(data.fees?.delivery ?? DELIVERY_FEE);
    custItemsTotal.textContent = itemsTotal.toFixed(2).replace(/\.00$/,'');
    custGrandTotal.textContent = (itemsTotal + service + delivery).toFixed(2).replace(/\.00$/,'');

    // Hide home immediately (no flash)
    homeHeader.style.display='none'; homeSearch.style.display='none';
    document.getElementById('tabs').style.display='none';
    cardsContainer.style.display='none';
    detailsPanel.classList.remove('show');

    customerPanel.style.display='block';
    customerPanel.setAttribute('aria-hidden','false');

    custPayBtn.onclick = ()=>{ window.location.href = PAYSTACK_LINK; };
    const closeAll = ()=>{ customerPanel.style.display='none'; customerPanel.setAttribute('aria-hidden','true'); };
    closeCustomerBtn.onclick = closeAll; custCancelBtn.onclick = closeAll;
  }

  /* ===== Router: direct-page open for ?admin= or ?order= (no home flash) ===== */
  function router(){
    const url = new URL(location.href);
    const adminId = url.searchParams.get('admin');
    const orderId = url.searchParams.get('order');

    if (adminId){
      const payload = getShort(adminId);
      if (payload && payload.type==='admin'){ openAdmin(payload); return; }
    }
    if (orderId){
      const payload = getShort(orderId);
      if (payload && payload.type==='order'){ openCustomer(payload); return; }
    }

    // normal home
    homeHeader.style.display=''; homeSearch.style.display='';
    document.getElementById('tabs').style.display='';
    cardsContainer.style.display='';
  }

  /* Init */
  (async () => {
    await buildBuyersCountMap();
    renderCards("All", "");
    router(); // open admin/customer directly if query present
  })();

</script>

<!-- =========FOOTER ========= -->
<div class="footer-wrap">
  <iframe src="footer.html" style="width:100%;height:60px;border:none;overflow:hidden" scrolling="no"></iframe>
</div>

</body>
</html>

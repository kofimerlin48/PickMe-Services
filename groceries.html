<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Groceries - PickMe Services</title>

<!-- ========== CSS SECTION ========== -->
<style>
/* =========================================
   PASTE ALL YOUR CSS INSIDE THIS AREA ONLY
   ========================================= */
   
/* ===== CSS SECTION START ===== */

:root{ --theme-color:#c12872; }

*{box-sizing:border-box}
* { -webkit-tap-highlight-color: transparent; }
:focus, :focus-visible, button:focus, input:focus, textarea:focus, select:focus {
  outline: none !important;
  box-shadow: none !important;
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#f9f9f9;
  padding-top:100px;
  overflow-x:hidden;
}

/* For all basic controls */
input, textarea, select, button {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
}

/* PAGE TOP */
.page-header{text-align:center;margin-bottom:10px;}
.page-header h1{color:var(--theme-color);margin:0;font-size:28px;}
.page-header p{color:#000;margin-top:5px;font-size:16px;font-weight:bold;}

.add-shop-wrap{
  display:flex;
  justify-content:center;
  margin:4px 16px 10px;
}
#openShopBtn{
  border:2px solid var(--theme-color);
  border-radius:999px;
  padding:9px 18px;
  background:#fff;
  color:var(--theme-color);
  font-size:14px;
  cursor:pointer;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

/* SEARCH + TABS */
.search-bar{display:flex;justify-content:center;margin:4px 16px 6px;}
.search-bar input{width:100%;max-width:480px;padding:10px 14px;border:1px solid #ccc;border-radius:8px;font-size:16px;}

.tabs{display:flex;gap:8px;overflow-x:auto;padding:8px 16px;border-bottom:2px solid #eee;}
.tab{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid #eee;cursor:pointer;white-space:nowrap;font-size:14px;}
.tab.active{color:#fff;background:var(--theme-color);border-color:var(--theme-color);}

/* Cards grid */
.cards-container{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:70px;
  padding:20px;
  padding-bottom:160px;
}
.card{
  position:relative;border-radius:15px;overflow:hidden;box-shadow:0 3px 8px rgba(0,0,0,.1);
  background-size:cover;background-position:center;height:250px;display:flex;align-items:flex-end;transition:transform .2s;
}
.card:hover{transform:translateY(-5px)}
.card::before{content:"";position:absolute;inset:0;background:linear-gradient(to top, rgba(0,0,0,.8), rgba(0,0,0,0))}
.card-content{position:relative;color:#fff;padding:15px;width:100%;display:flex;flex-direction:column;justify-content:space-between;z-index:1}
.card-title{font-weight:bold;font-size:22px;margin-bottom:4px}
.card-description{font-size:13px;opacity:.95;margin-bottom:4px}
.card-lower { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
.card-meta { font-size:12px; opacity:0.9; margin:0; }
.btn-enter{background:var(--theme-color);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px;align-self:flex-end}

/* Details */
#detailsPanel{
  position:fixed;top:0;right:-100%;width:100%;max-width:1100px;height:100%;
  background:#fff;z-index:9999;overflow-y:auto;transition:right .5s ease;box-shadow:-5px 0 15px rgba(0,0,0,.2);
  padding-bottom:140px;
}
#detailsPanel.show{right:0;}
#detailsBackBtn{
  position:fixed;top:15px;right:-60px;width:40px;height:40px;background:#000;color:#fff;border:none;border-radius:50%;
  font-size:24px;cursor:pointer;z-index:10000;display:flex;align-items:center;justify-content:center;transition:right .5s ease;
}
#detailsPanel.show #detailsBackBtn{right:15px;}
.banner{
  position:relative;width:100%;height:35vh;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;
  background:#333 center/cover no-repeat;
}
.banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom, rgba(0,0,0,.22), rgba(0,0,0,.70), rgba(0,0,0,.80))}
.banner-text{position:relative;z-index:2}
.banner-text h2{font-size:16px;margin:0 0 6px}
.banner-text h1{font-size:26px;margin:0 0 8px}
.banner-text p{font-size:13px;margin:0;opacity:.95}
.details-content{padding:18px;max-width:1100px;margin:0 auto}
.section-title{font-weight:bold;margin:8px 0 12px;color:#333}

/* Carousel */
.carousel{position:relative;width:100%;height:240px;overflow:hidden;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.carousel img{position:absolute;top:0;left:100%;width:100%;height:100%;object-fit:cover;opacity:0;transition:left .45s ease, opacity .45s ease;}
.carousel img.active{left:0;opacity:1}
.carousel .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:24px;color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:50%;cursor:pointer;user-select:none}
.carousel .nav.left{left:10px}
.carousel .nav.right{right:10px}
.dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.dot{width:8px;height:8px;border-radius:50%;background:#ddd}
.dot.active{background:var(--theme-color)}

/* Action row */
.action-row{display:flex;justify-content:center;margin:22px 0 120px;}
.btn-primary{background:var(--theme-color);color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-size:15px}

/* Generic Modal */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10001;
}
.modal.show{display:flex}
.modal-card{
  width:95%;
  max-width:560px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  overflow:hidden;
  max-height:90vh;
  display:flex;
  flex-direction:column;
}
.modal-header{
  padding:14px 16px;
  border-bottom:1px solid #eee;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px
}
.modal-body{
  padding:16px;
  overflow-y:auto;
  max-height:calc(90vh - 120px)
}
.modal-footer{
  padding:14px 16px;
  border-top:1px solid #eee;
  display:flex;
  gap:10px;
  justify-content:flex-end
}

/* ===== Mode choose + catalog modals ===== */

.mode-options{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.mode-btn{
  width:100%;
  border-radius:12px;
  border:1px solid #eee;
  padding:12px 14px;
  font-size:15px;
  text-align:left;
  background:#fafafa;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.mode-btn span:first-child{
  font-weight:600;
}
.mode-btn small{
  font-size:12px;
  color:#666;
}

/* Catalog modal: big cards */
.catalog-body{
  padding:12px 16px 4px;
}
.catalog-search{
  margin-bottom:10px;
}
.catalog-search input{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}
.catalog-list{
  max-height:50vh;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding-right:4px;
}
.catalog-item-card{
  border-radius:14px;
  background:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  padding:12px 12px 10px;
  display:flex;
  align-items:flex-start;
  gap:10px;
  cursor:pointer;
}
.catalog-item-card .check-box{
  width:22px;
  height:22px;
  border-radius:6px;
  border:2px solid var(--theme-color);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  font-size:14px;
}
.catalog-item-card.selected .check-box{
  background:var(--theme-color);
  color:#fff;
}
.catalog-item-card .info{
  flex:1;
}
.catalog-item-name{
  font-weight:700;
  font-size:15px;
  margin-bottom:4px;
}
.catalog-item-meta{
  font-size:12px;
  color:#666;
}
.modal-footer.catalog-footer{
  justify-content:space-between;
  align-items:center;
}
.catalog-footer-left{
  flex:1;
  font-size:13px;
  color:#555;
}

/* item card layout (vertical, no horizontal scroll) */
.item-card{
  background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:12px 12px 10px;margin-bottom:12px;
}
.item-top{display:flex;align-items:center;gap:10px}
.item-num{font-weight:700;color:#333;min-width:22px;text-align:right}
.item-name{
  flex:1;border:none;border-bottom:1px solid #eee;padding:8px 6px 6px;font-size:15px;
  transition:border-color .2s, box-shadow .2s;
}
.item-name::placeholder{color:#aaa}
.item-name:focus{border-color:var(--theme-color);box-shadow:0 0 4px rgba(193,40,114,0.5);}
.item-del{margin-left:8px;background:var(--theme-color);border:none;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.item-del svg{width:20px;height:20px;fill:#fff;display:block}
.item-qty{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
.qty-label{font-size:12px;color:#666;margin-left:4px;}
.qty-controls{display:flex;align-items:center;gap:8px;}
.qty-btn{ width:38px;height:38px;border:none;border-radius:8px;background:#3a3a3a;color:#fff;font-size:22px;cursor:pointer;}
.qty-input{width:64px;height:38px;border:1px solid #ccc;border-radius:8px;text-align:center;font-size:16px;}
.small-note{font-size:12px;color:#666;margin:6px 0 0}

/* Name + phone row */
.whats-row{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:12px;
}

/* --- Add Grocery Shop form (vertical, modern) --- */
.shop-form-group{
  display:flex;
  flex-direction:column;
  margin-bottom:10px;
}
.shop-form-group label{
  font-size:13px;
  color:#444;
  margin-bottom:4px;
  font-weight:600;
}
.shop-form-group input,
.shop-form-group select,
.shop-form-group textarea{
  width:100%;
  max-width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #e0e0e0;
  font-size:14px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.shop-form-group input::placeholder,
shop-form-group textarea::placeholder{
  color:#b8b8b8;
}
.shop-form-group textarea{
  min-height:70px;
  resize:vertical;
}
.shop-form-group small{
  font-size:11px;
  color:#777;
}

/* Error text */
.error{color:#b00020;font-size:13px;margin-top:8px;display:none}

/* Disable state for shop submit */
#shopSubmitBtn[disabled]{
  opacity:.7;
  cursor:not-allowed;
}

/* Admin & customer panels â€“ unchanged layout */
#adminPanel{position:fixed; inset:0; background:#fff; z-index:10002; display:none; overflow-y:auto; padding:16px 16px 90px;}
#adminPanel .admin-top{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
#adminPanel .admin-top h2{margin:0; font-size:18px;}
#adminPanel .close-admin{background:#000; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;}
.admin-shop-actions{display:flex; gap:8px; margin:8px 0 14px;}
.admin-shop-actions a{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:8px; text-decoration:none; color:#fff; font-size:14px;}
.call-btn{background:#0a7d0a;}
.wa-btn{background:#25D366;}

.admin-section{margin:10px 0 16px;}
.group-title{font-weight:700; margin:10px 0 8px;}

/* Admin cards */
.admin-item-card{
  background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:12px;margin-bottom:10px;
}
.admin-row1{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
.admin-item-num{font-weight:700;min-width:22px;text-align:right;color:#333}
.admin-item-name{flex:1;border:none;background:transparent;padding:0;font-weight:700;color:#222;pointer-events:none}
.admin-qty-pill{border:1px solid #eee;border-radius:8px;padding:6px 10px;font-size:13px;color:#333;background:#fafafa}

.admin-row2{display:flex;align-items:center;gap:10px}
.avail-toggle{padding:8px 10px;border-radius:999px;border:1px solid #ddd;cursor:pointer;background:#f7f7f7;font-size:13px;user-select:none}
.avail-toggle.on{background:#e9fff1;border-color:#b7e7c5;color:#146c2e;}
.avail-toggle.off{background:#fff3f3;border-color:#f0c3c3;color:#8a1c1c;}

.price-input{flex:1;min-width:140px;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
.price-input:focus{border-color:var(--theme-color);box-shadow:0 0 0 3px rgba(193,40,114,.08)}
.subtotal{margin-left:auto;font-weight:700}

/* Modern fee inputs */
.admin-fee-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.fee-input{
  display:flex;align-items:center;gap:8px;
  background:#fff;border:1px solid #eee;border-radius:12px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,.06)
}
.fee-input input{
  width:120px;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px;text-align:right
}
.fee-input input:focus{border-color:var(--theme-color);box-shadow:0 0 0 3px rgba(193,40,114,.08)}

.admin-totals{margin-top:10px;font-size:14px;font-weight:600;}
.admin-totals div{margin:4px 0}

/* Modern Admin Action Buttons */
.admin-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 16px;
}
.btn {
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 600;
}
.btn-cancel {
  background: #777;
  color: #fff;
}
.btn-cancel:hover {
  background: #555;
}
.btn-done {
  background: var(--theme-color);
  color: #fff;
}
.btn-done:hover {
  background: #a21f60;
}

/* Customer panel (modern cards) */
#customerPanel{position:fixed; inset:0; background:#fff; z-index:10002; display:none; overflow-y:auto; padding:16px 16px 90px;}
.cust-top{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
.cust-top h2{margin:0; font-size:18px;}
.cust-close{background:#000; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;}
.cust-group{margin:10px 0 16px;}
.cust-group h3{margin:0 0 8px 0; font-size:16px;}
.cust-items-wrap{display:grid;gap:10px}

.cust-item-card{
  background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:12px;display:flex;flex-direction:column;gap:8px
}
.cust-row1{display:flex;align-items:center;justify-content:space-between;gap:10px}
.cust-item-num{font-weight:700;min-width:22px;text-align:right}
.cust-item-name{flex:1;font-weight:700}
.cust-item-meta{font-size:13px;color:#444}

.cust-row2{display:flex;align-items:center;justify-content:space-between;gap:10px}
.cust-badge{display:flex;align-items:center;gap:6px;font-size:13px;color:#146c2e;background:#e9fff1;border:1px solid #b7e7c5;border-radius:999px;padding:6px 10px}
.cust-badge.off{color:#8a1c1c;background:#fff3f3;border:1px solid #f0c3c3}

.cust-price-block{font-size:14px;color:#333}
.cust-price-line{display:flex;gap:8px}
.cust-price-line .unit{opacity:.85}
.cust-price-line .sub{font-weight:700}

.cust-totals{margin-top:10px;border-top:1px dashed #ddd;padding-top:10px;font-weight:600;}
.cust-totals .line{display:flex;justify-content:space-between;margin:4px 0}
.cust-totals .grand{color:var(--theme-color);font-weight:800}

.cust-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px;}
.cust-btn{border:none; border-radius:10px; padding:10px 14px; cursor:pointer;}
.cust-pay{background:var(--theme-color); color:#fff;}
.cust-cancel{background:#777; color:#fff;}

/* Footer iframe pinned */
.footer-wrap{position:fixed;bottom:0;width:100%;z-index:9999}

/* ===== CSS SECTION END ===== */



</style>

</head>
<body>

<!-- ========= HEADER (Static, do not touch) ========= -->
<div id="header-placeholder"></div>
<script>
(async () => {
  try {
    const response = await fetch('header.html');
    let html = await response.text();
    document.getElementById('header-placeholder').innerHTML = html;
  } catch (err) {
    console.error("Header load error:", err);
  }
})();
</script>

<!-- ========== HTML SECTION ========== -->
<!-- =========================================
     PASTE ALL YOUR HTML INSIDE THIS AREA ONLY
     ========================================= -->

<div id="page-content">
  <!-- ===== HTML SECTION START ===== -->

<!-- ========= HEADER LOADER (Working version) ========= -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const host = document.getElementById('header-placeholder');
    const res = await fetch('header.html', { cache: 'no-store' });
    if (!res.ok) throw 0;

    let html = await res.text();
    const pageTitle = "Groceries";

    // Inject page title into header
    html = html.replace(
      /<h1[^>]*>.*?<\/h1>/i,
      `<h1 style="margin:0;font-weight:800;color:#c12872;font-size:24px;position:absolute;left:50%;transform:translateX(-50%)">${pageTitle}</h1>`
    );

    host.innerHTML = html;
    host.removeAttribute('aria-hidden');

    // Load header scripts so hamburger works
    host.querySelectorAll('script').forEach(old => {
      const s = document.createElement('script');
      if (old.src) s.src = old.src;
      else s.textContent = old.textContent;
      document.body.appendChild(s);
    });

  } catch (e) { /* silent fail */ }
});
</script>

<!-- ===== Home ===== -->
<div class="page-header" id="homeHeader">
  <h1></h1>
  <p>Find grocery shops around you and send your list</p>
</div>

<div class="add-shop-wrap">
  <button id="openShopBtn">ðŸ›’ Add your grocery shop</button>
</div>

<div class="search-bar" id="homeSearch">
  <input type="text" id="searchInput" placeholder="Search grocery shops...">
</div>

<div class="tabs" id="tabs">
  <div class="tab active" data-cat="All">All</div>
  <div class="tab" data-cat="Stores">Stores</div>
  <div class="tab" data-cat="Supermarkets">Supermarkets</div>
  <div class="tab" data-cat="Market">Market</div>
</div>

<div class="cards-container" id="cardsContainer"></div>

<!-- ================= DETAILS PANEL ================= -->
<div id="detailsPanel">
  <button id="detailsBackBtn">&times;</button>
  <section class="banner" id="detailsBanner">
    <div class="banner-text">
      <h2>Welcome to</h2>
      <h1 id="shopName"></h1>
      <p id="shopSlogan"></p>
    </div>
  </section>

  <div class="details-content">
    <div class="section-title">Sample of items sold</div>
    <div class="carousel" id="carousel"></div>
    <div class="dots" id="dots"></div>
    <div class="action-row">
      <button class="btn-primary" id="openFormBtn">+ Add Items to your list</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Add Items Form ===== -->
<div class="modal" id="formModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>List your items</span>
      <button class="btn-primary" id="clearAllBtn" style="background:#777">Clear all</button>
    </div>
    <div class="modal-body">
      <div id="itemsHolder"></div>
      <button class="btn-primary" id="addRowBtn" style="margin:8px 0 0">Add another item</button>

      <div class="whats-row">
        <div class="shop-form-group">
          <label for="customerName">Your full name</label>
          <input type="text" id="customerName" placeholder="Your full name"/>
        </div>
        <div class="shop-form-group">
          <label for="customerPhone">Your phone number</label>
          <input type="tel" id="customerPhone" placeholder="+233â€¦ or 0â€¦"/>
        </div>
        <div class="small-note">
          Weâ€™ll review prices with the shop and send you your list with totals before you pay.
        </div>
      </div>

      <div class="error" id="formError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="cancelBtn" style="background:#777">Cancel</button>
      <button class="btn-primary" id="submitBtn">Submit list</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Choose how to add items ===== -->
<div class="modal" id="chooseModeModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Add items to your list</span>
    </div>
    <div class="modal-body">
      <div class="mode-options">
        <button class="mode-btn" id="modeTypeBtn">
          <span>Type items yourself</span>
          <small>Start with an empty form and type each item name.</small>
        </button>
        <button class="mode-btn" id="modeSelectBtn">
          <span>Select items from shop list</span>
          <small>Pick from items other customers have bought from this shop.</small>
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="modeCancelBtn" style="background:#777">Cancel</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Select items from this shop ===== -->
<div class="modal" id="catalogModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Shop items</span>
      <button class="btn-primary" id="catalogCloseBtn" style="background:#777">Close</button>
    </div>
    <div class="modal-body catalog-body">
      <div class="catalog-search">
        <input type="text" id="catalogSearch" placeholder="Search items in this shop...">
      </div>
      <div id="catalogList" class="catalog-list"></div>
    </div>
    <div class="modal-footer catalog-footer">
      <div class="catalog-footer-left">
        Selected: <span id="catalogSelectedCount">0</span> item(s)
      </div>
      <div>
        <button class="btn-primary" id="catalogCancelBtn" style="background:#777">Cancel</button>
        <button class="btn-primary" id="catalogDoneBtn">Use selected items</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal: Add Grocery Shop ===== -->
<div class="modal" id="shopModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>Add your grocery shop</span>
      <button class="btn-primary" id="shopCloseBtn" style="background:#777">Close</button>
    </div>
    <div class="modal-body">

      <div class="shop-form-group">
        <label for="ownerName">Owner full name</label>
        <input type="text" id="ownerName" placeholder="Your full name"/>
      </div>
      <div class="shop-form-group">
        <label for="ownerPhone">Owner phone number</label>
        <input type="tel" id="ownerPhone" placeholder="+233â€¦ or 0â€¦"/>
      </div>
      <div class="shop-form-group">
        <label for="shopNameInput">Shop name</label>
        <input type="text" id="shopNameInput" placeholder="e.g. E&G Supermarket"/>
      </div>
      <div class="shop-form-group">
        <label for="shopSloganInput">Shop slogan</label>
        <input type="text" id="shopSloganInput" placeholder="e.g. Everything household & fresh"/>
      </div>
      <div class="shop-form-group">
        <label for="shopShortDesc">Short description</label>
        <textarea id="shopShortDesc" placeholder="Brief description of your shop"></textarea>
      </div>
      <div class="shop-form-group">
        <label for="shopCategory">Category</label>
        <select id="shopCategory">
          <option value="">Select category</option>
          <option value="Stores">Stores</option>
          <option value="Supermarkets">Supermarkets</option>
          <option value="Market">Market</option>
        </select>
      </div>
      <div class="shop-form-group">
        <label for="shopPlan">Subscription plan</label>
        <select id="shopPlan">
          <option value="">Select subscription plan</option>
          <option value="1m_50">1 Month 50</option>
          <option value="3m_100">3 Months 100</option>
          <option value="6m_200">6 Months 200</option>
          <option value="12m_300">1 Year 300</option>
        </select>
      </div>
      <div class="shop-form-group">
        <label for="shopTown">Location / Town</label>
        <input type="text" id="shopTown" placeholder="e.g. Agogo, near main station"/>
      </div>
      <div class="shop-form-group">
        <label for="shopPhone">Shop phone number</label>
        <input type="tel" id="shopPhone" placeholder="+233â€¦ or 0â€¦"/>
      </div>
      <div class="shop-form-group">
        <label for="shopMainImage">Main shop image</label>
        <input type="file" id="shopMainImage" accept="image/*"/>
        <small>This will be used as the shop card background.</small>
      </div>
      <div class="shop-form-group">
        <label for="shopSampleImages">Sample item pictures (up to 5)</label>
        <input type="file" id="shopSampleImages" accept="image/*" multiple/>
        <small>Upload some pictures of items you sell. At least 1 is required.</small>
      </div>

      <div class="error" id="shopError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" id="shopCancelBtn" style="background:#777">Cancel</button>
      <button class="btn-primary" id="shopSubmitBtn">Submit shop</button>
    </div>
  </div>
</div>

<!-- ===== NEW Waiting Modal ===== -->
<div class="modal" id="waitingModal">
  <div class="modal-card">
    <div class="modal-header">
      <span>We are confirming your prices</span>
    </div>

    <div class="modal-body">
      <p id="waitingTopMsg" style="margin:0 0 6px;font-size:14px;color:#444;">
        Your list has been submitted. We are confirming prices with the shop.
      </p>

      <p style="font-size:18px;font-weight:bold;margin:10px 0;color:#333;">
        Please wait<span id="waitingDots"></span>
      </p>

      <div style="margin:14px 0 4px;">
        <div style="background:#eee;width:100%;height:12px;border-radius:6px;overflow:hidden;">
          <div id="waitingProgressBar" style="height:100%;width:0%;background:#c12872;transition:width .4s ease;"></div>
        </div>
      </div>

      <div id="waitingCounter" style="font-size:14px;color:#666;margin-top:4px;">
        0 of 0 items reviewed
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-primary" id="waitingBtn" disabled style="display:none;">
        View reviewed list
      </button>
    </div>

  </div>
</div>

<!-- ===== Hidden Admin Panel (query: ?admin=ID) ===== -->
<div id="adminPanel" aria-hidden="true">
  <div class="admin-top">
    <div>
      <h2 id="adminShop">Order</h2>
      <div class="admin-shop-actions" id="adminShopActions"></div>
    </div>
    <button class="close-admin" id="closeAdminBtn">Close</button>
  </div>

  <div class="admin-section">
    <div class="group-title">Available items</div>
    <div id="adminAvail"></div>
  </div>
  <div class="admin-section">
    <div class="group-title">Unavailable items</div>
    <div id="adminUnavail"></div>
  </div>

  <div class="admin-section">
    <div class="group-title">Fees</div>
    <div class="admin-fee-row">
      <label class="fee-input">Service: GHâ‚µ <input type="number" min="0" step="1" id="feeServiceInput"></label>
      <label class="fee-input">Delivery: GHâ‚µ <input type="number" min="0" step="1" id="feeDeliveryInput"></label>
    </div>
  </div>

  <div class="admin-totals">
    <div>Items total: GHâ‚µ <span id="adminItemsTotal">0</span></div>
    <div>Grand total (with fees): GHâ‚µ <span id="adminGrandTotal">0</span></div>
  </div>

  <div class="admin-actions">
    <button class="btn btn-cancel" id="adminCancel">Cancel</button>
    <button class="btn btn-done" id="adminDone">Done</button>
  </div>
</div>

<!-- ===== Hidden Customer Panel (query: ?order=ID) ===== -->
<div id="customerPanel" aria-hidden="true">
  <div class="cust-top">
    <h2 id="custShop">Order</h2>
    <button class="cust-close" id="closeCustomerBtn">Close</button>
  </div>

  <div class="cust-group">
    <h3>Available items</h3>
    <div id="custAvail" class="cust-items-wrap"></div>
  </div>
  <div class="cust-group">
    <h3>Unavailable items</h3>
    <div id="custUnavail" class="cust-items-wrap"></div>
  </div>

  <div class="cust-totals"></div>

  <div class="cust-actions">
    <button class="cust-btn cust-cancel" id="custCancel">Cancel</button>
    <button class="cust-btn cust-pay" id="custPay">Proceed to payment</button>
  </div>
</div>

<!-- =========FOOTER ========= -->
<div class="footer-wrap">
  <iframe src="footer.html" style="width:100%;height:60px;border:none;overflow:hidden" scrolling="no"></iframe>
</div>

<!-- ===== HTML SECTION END ===== -->
</div>

<!-- ========== JAVASCRIPT SECTION ========== -->
<script type="module">
/* =========================================
   PASTE ALL YOUR JAVASCRIPT HERE ONLY
   ========================================= */

/* ===== JS SECTION START ===== */

import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

import {
  getFirestore, collection, doc, setDoc, getDoc, deleteDoc,
  getDocs, onSnapshot, updateDoc, serverTimestamp,
  query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

/* === Firebase Config === */
const firebaseConfig = {
  apiKey: "AIzaSyB2L649fIs0CS-fGDC0ybFeAO5Im5BEP_c",
  authDomain: "pickmeservicesonline.firebaseapp.com",
  projectId: "pickmeservicesonline",
  storageBucket: "pickmeservicesonline.appspot.com",
  messagingSenderId: "1038647139751",
  appId: "1:1038647139751:web:1bff38c7ca1df9b2ce2743"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* UI ELEMENTS */
const cardsContainer = document.getElementById("cardsContainer");
const searchInput = document.getElementById("searchInput");
const tabs = document.getElementById("tabs");
let currentCategory = "All";

/* LOAD SHOPS */
async function loadShops() {
  const q = query(collection(db, "GroceryShops"));
  const snapshot = await getDocs(q);

  cardsContainer.innerHTML = "";

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;

    if (currentCategory !== "All" && data.category !== currentCategory) {
      return;
    }

    addShopCard(id, data);
  });
}

/* CREATE SHOP CARD */
function addShopCard(id, data) {
  const card = document.createElement("div");
  card.className = "card";
  card.style.backgroundImage = `url('${data.mainImageURL}')`;

  card.innerHTML = `
    <div class="card-content">
      <div>
        <div class="card-title">${data.shopName}</div>
        <div class="card-description">${data.shortDesc ?? ""}</div>
        <div class="card-lower">
          <p class="card-meta">${data.category}</p>
          <p class="card-meta">${data.town}</p>
        </div>
      </div>
      <button class="btn-enter">Enter</button>
    </div>
  `;

  card.addEventListener("click", () => openDetails(id, data));
  cardsContainer.appendChild(card);
}

/* SEARCH */
searchInput.addEventListener("input", () => {
  const txt = searchInput.value.toLowerCase();
  const cards = cardsContainer.children;
  for (let c of cards) {
    const title = c.querySelector(".card-title").textContent.toLowerCase();
    const desc = c.querySelector(".card-description").textContent.toLowerCase();
    c.style.display = (title.includes(txt) || desc.includes(txt)) ? "block" : "none";
  }
});

/* TABS */
tabs.addEventListener("click", (e) => {
  if (!e.target.classList.contains("tab")) return;

  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  e.target.classList.add("active");

  currentCategory = e.target.dataset.cat;
  loadShops();
});

/* DETAILS PANEL */
const detailsPanel = document.getElementById("detailsPanel");
const detailsBackBtn = document.getElementById("detailsBackBtn");
const shopNameEl = document.getElementById("shopName");
const shopSloganEl = document.getElementById("shopSlogan");
const detailsBanner = document.getElementById("detailsBanner");
const carousel = document.getElementById("carousel");
const dotsContainer = document.getElementById("dots");

let currentShopId = null;
let sampleImages = [];
let currentSlide = 0;
let carouselInterval = null;

/* OPEN SHOP DETAILS */
function openDetails(id, data) {
  currentShopId = id;

  shopNameEl.textContent = data.shopName;
  shopSloganEl.textContent = data.slogan ?? "";
  detailsBanner.style.backgroundImage = `url('${data.mainImageURL}')`;

  sampleImages = data.sampleImages || [];

  loadCarousel();

  detailsPanel.classList.add("show");
}

/* CLOSE DETAILS */
detailsBackBtn.addEventListener("click", () => {
  detailsPanel.classList.remove("show");
  clearInterval(carouselInterval);
});

/* CAROUSEL */
function loadCarousel() {
  carousel.innerHTML = "";
  dotsContainer.innerHTML = "";

  sampleImages.forEach((url, index) => {
    const img = document.createElement("img");
    img.src = url;
    if (index === 0) img.classList.add("active");
    carousel.appendChild(img);

    const dot = document.createElement("div");
    dot.className = "dot" + (index === 0 ? " active" : "");
    dot.addEventListener("click", () => setSlide(index));
    dotsContainer.appendChild(dot);
  });

  currentSlide = 0;
  if (carouselInterval) clearInterval(carouselInterval);
  carouselInterval = setInterval(nextSlide, 4000);
}

function nextSlide() {
  currentSlide = (currentSlide + 1) % sampleImages.length;
  setSlide(currentSlide);
}

function setSlide(i) {
  const imgs = carousel.querySelectorAll("img");
  const dots = dotsContainer.querySelectorAll(".dot");

  imgs.forEach(img => img.classList.remove("active"));
  dots.forEach(dot => dot.classList.remove("active"));

  imgs[i].classList.add("active");
  dots[i].classList.add("active");

  currentSlide = i;
}

/* ADD ITEMS BUTTON */
document.getElementById("openFormBtn").addEventListener("click", () => {
  chooseModeModal.classList.add("show");
});

/* CHOOSE MODE */
const chooseModeModal = document.getElementById("chooseModeModal");
document.getElementById("modeCancelBtn").addEventListener("click", () => chooseModeModal.classList.remove("show"));

/* Mode: type manually */
document.getElementById("modeTypeBtn").addEventListener("click", () => {
  chooseModeModal.classList.remove("show");
  resetForm();
  formModal.classList.add("show");
});

/* Mode: select from shop catalog */
document.getElementById("modeSelectBtn").addEventListener("click", () => {
  chooseModeModal.classList.remove("show");
  loadShopCatalog(currentShopId);
});

/* FORM MODAL */
const formModal = document.getElementById("formModal");
const itemsHolder = document.getElementById("itemsHolder");
const addRowBtn = document.getElementById("addRowBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const formError = document.getElementById("formError");
const cancelBtn = document.getElementById("cancelBtn");
const submitBtn = document.getElementById("submitBtn");

/* ADD ITEM ROW */
addRowBtn.addEventListener("click", addNewRow);

function addNewRow(name = "", qty = 1) {
  const index = itemsHolder.children.length + 1;

  const div = document.createElement("div");
  div.className = "item-card";
  div.innerHTML = `
    <div class="item-top">
      <div class="item-num">${index}</div>
      <input class="item-name" type="text" placeholder="Item name" value="${name}">
      <button class="item-del">&times;</button>
    </div>
    <div class="item-qty">
      <div class="qty-label">Quantity</div>
      <div class="qty-controls">
        <button class="qty-btn minus">-</button>
        <input class="qty-input" type="number" value="${qty}" min="1">
        <button class="qty-btn plus">+</button>
      </div>
    </div>
  `;

  itemsHolder.appendChild(div);

  const minus = div.querySelector(".minus");
  const plus = div.querySelector(".plus");
  const qtyInput = div.querySelector(".qty-input");
  const delBtn = div.querySelector(".item-del");

  minus.addEventListener("click", () => {
    let v = parseInt(qtyInput.value) || 1;
    if (v > 1) qtyInput.value = v - 1;
  });

  plus.addEventListener("click", () => {
    let v = parseInt(qtyInput.value) || 1;
    qtyInput.value = v + 1;
  });

  delBtn.addEventListener("click", () => {
    div.remove();
    renumberItems();
  });

  renumberItems();
}

/* CLEAR ALL */
clearAllBtn.addEventListener("click", () => {
  itemsHolder.innerHTML = "";
  addNewRow();
});

/* RESET FORM */
function resetForm() {
  itemsHolder.innerHTML = "";
  addNewRow();
  formError.style.display = "none";
}

/* CLOSE FORM */
cancelBtn.addEventListener("click", () => formModal.classList.remove("show"));

/* RENUMBER */
function renumberItems() {
  [...itemsHolder.children].forEach((div, i) => {
    div.querySelector(".item-num").textContent = i + 1;
  });
}

/* SUBMIT FORM */
submitBtn.addEventListener("click", submitList);

async function submitList() {
  const name = document.getElementById("customerName").value.trim();
  const phone = document.getElementById("customerPhone").value.trim();

  if (!name || !phone) {
    formError.textContent = "Enter your name and phone number.";
    formError.style.display = "block";
    return;
  }

  const items = [];
  [...itemsHolder.children].forEach(div => {
    const itemName = div.querySelector(".item-name").value.trim();
    const qty = parseInt(div.querySelector(".qty-input").value);

    if (itemName) {
      items.push({
        name: itemName,
        qty: qty || 1,
        available: null,
        price: null,
        subtotal: null
      });
    }
  });

  if (items.length === 0) {
    formError.textContent = "Add at least one item.";
    formError.style.display = "block";
    return;
  }

  formError.style.display = "none";
  formModal.classList.remove("show");

  /* SHOW WAITING MODAL */
  startWaitingModal(items.length);

  const orderRef = doc(collection(db, "GroceryOrders"));
  await setDoc(orderRef, {
    shopId: currentShopId,
    customerName: name,
    customerPhone: phone,
    items: items,
    createdAt: serverTimestamp()
  });

  waitForAdminReview(orderRef.id, items.length);
}

/* ===== WAITING MODAL ===== */
const waitingModal = document.getElementById("waitingModal");
const waitingDots = document.getElementById("waitingDots");
const waitingBtn = document.getElementById("waitingBtn");
const waitingTopMsg = document.getElementById("waitingTopMsg");
const waitingProgressBar = document.getElementById("waitingProgressBar");
const waitingCounter = document.getElementById("waitingCounter");

let dotInterval = null;

function startWaitingModal(totalItems) {
  waitingCounter.textContent = `0 of ${totalItems} items reviewed`;
  waitingProgressBar.style.width = "0%";

  waitingBtn.style.display = "none";
  waitingBtn.disabled = true;

  waitingModal.classList.add("show");

  if (dotInterval) clearInterval(dotInterval);
  waitingDots.textContent = "";
  dotInterval = setInterval(() => {
    waitingDots.textContent += ".";
    if (waitingDots.textContent.length > 3) waitingDots.textContent = "";
  }, 500);
}

/* CHECK REVIEW STATUS */
function waitForAdminReview(orderId, totalItems) {
  const orderDoc = doc(db, "GroceryOrders", orderId);

  const unsubscribe = onSnapshot(orderDoc, (snap) => {
    if (!snap.exists()) return;

    const data = snap.data();
    const items = data.items || [];

    const reviewed = items.filter(i => i.available !== null).length;
    waitingCounter.textContent = `${reviewed} of ${totalItems} items reviewed`;

    const progress = (reviewed / totalItems) * 100;
    waitingProgressBar.style.width = progress + "%";

    if (reviewed === totalItems) {
      waitingBtn.style.display = "block";
      waitingBtn.disabled = false;

      waitingTopMsg.textContent = "All prices confirmed.";

      waitingBtn.onclick = () => {
        waitingModal.classList.remove("show");
        openCustomerPanel(orderId);
      };
    }
  });
}

/* ===== Catalog Modal ===== */
const catalogModal = document.getElementById("catalogModal");
const catalogSearch = document.getElementById("catalogSearch");
const catalogList = document.getElementById("catalogList");
const catalogCloseBtn = document.getElementById("catalogCloseBtn");
const catalogCancelBtn = document.getElementById("catalogCancelBtn");
const catalogDoneBtn = document.getElementById("catalogDoneBtn");
const catalogSelectedCount = document.getElementById("catalogSelectedCount");

let catalogItems = [];
let selectedCatalogItems = new Set();

/* LOAD SHOP CATALOG */
async function loadShopCatalog(shopId) {
  catalogList.innerHTML = "Loading...";

  const q = query(collection(db, "GroceryItems"), where("shopId", "==", shopId));
  const snap = await getDocs(q);

  catalogItems = [];
  selectedCatalogItems.clear();

  snap.forEach(docSnap => {
    catalogItems.push({ id: docSnap.id, ...docSnap.data() });
  });

  catalogModal.classList.add("show");
  renderCatalog();
}

/* RENDER CATALOG */
function renderCatalog() {
  const searchTxt = catalogSearch.value.toLowerCase();

  catalogList.innerHTML = "";

  catalogItems
    .filter(i => i.name.toLowerCase().includes(searchTxt))
    .forEach(item => {
      const div = document.createElement("div");
      div.className = "catalog-item-card" + (selectedCatalogItems.has(item.id) ? " selected" : "");
      div.innerHTML = `
        <div class="check-box">${selectedCatalogItems.has(item.id) ? "âœ“" : ""}</div>
        <div class="info">
          <div class="catalog-item-name">${item.name}</div>
          <div class="catalog-item-meta">${item.meta ?? ""}</div>
        </div>
      `;
      div.addEventListener("click", () => toggleCatalogItem(item.id));
      catalogList.appendChild(div);
    });

  catalogSelectedCount.textContent = selectedCatalogItems.size;
}

function toggleCatalogItem(id) {
  if (selectedCatalogItems.has(id)) {
    selectedCatalogItems.delete(id);
  } else {
    selectedCatalogItems.add(id);
  }
  renderCatalog();
}

catalogSearch.addEventListener("input", renderCatalog);

catalogCloseBtn.addEventListener("click", () => catalogModal.classList.remove("show"));
catalogCancelBtn.addEventListener("click", () => catalogModal.classList.remove("show"));

catalogDoneBtn.addEventListener("click", () => {
  catalogModal.classList.remove("show");

  if (selectedCatalogItems.size === 0) return;

  resetForm();
  selectedCatalogItems.forEach(id => {
    const item = catalogItems.find(i => i.id === id);
    if (item) addNewRow(item.name, 1);
  });

  formModal.classList.add("show");
});

/* ===== Admin Panel (URL Query: ?admin=ID) ===== */
const adminPanel = document.getElementById("adminPanel");
const closeAdminBtn = document.getElementById("closeAdminBtn");

const adminShop = document.getElementById("adminShop");
const adminShopActions = document.getElementById("adminShopActions");
const adminAvail = document.getElementById("adminAvail");
const adminUnavail = document.getElementById("adminUnavail");

const feeServiceInput = document.getElementById("feeServiceInput");
const feeDeliveryInput = document.getElementById("feeDeliveryInput");

const adminItemsTotal = document.getElementById("adminItemsTotal");
const adminGrandTotal = document.getElementById("adminGrandTotal");

const adminCancel = document.getElementById("adminCancel");
const adminDone = document.getElementById("adminDone");

let adminOrderId = null;
let adminOrderData = null;

/* IF URL HAS ADMIN ID */
const urlParams = new URLSearchParams(window.location.search);

if (urlParams.has("admin")) {
  adminOrderId = urlParams.get("admin");
  loadAdminOrder(adminOrderId);
}

/* LOAD ADMIN ORDER */
async function loadAdminOrder(orderId) {
  const snap = await getDoc(doc(db, "GroceryOrders", orderId));
  if (!snap.exists()) return;

  adminOrderData = snap.data();

  adminShop.textContent = `Order from ${adminOrderData.customerName}`;

  adminShopActions.innerHTML = `
    <a class="call-btn" href="tel:${adminOrderData.customerPhone}">
      Call ${adminOrderData.customerPhone}
    </a>
    <a class="wa-btn" href="https://wa.me/${adminOrderData.customerPhone.replace(/^0/,'233')}?text=Your%20Grocery%20Order" target="_blank">
      WhatsApp
    </a>
  `;

  adminPanel.style.display = "block";

  renderAdminItems();
}

/* RENDER ADMIN ITEMS */
function renderAdminItems() {
  adminAvail.innerHTML = "";
  adminUnavail.innerHTML = "";

  let total = 0;

  adminOrderData.items.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "admin-item-card";
    div.innerHTML = `
      <div class="admin-row1">
        <div class="admin-item-num">${index + 1}</div>
        <div class="admin-item-name">${item.name}</div>
        <div class="admin-qty-pill">${item.qty} pcs</div>
      </div>

      <div class="admin-row2">
        <div
          class="avail-toggle ${item.available === true ? "on" : item.available === false ? "off" : ""}"
        >
          ${item.available === true ? "Available" : item.available === false ? "Unavailable" : "Check"}
        </div>

        <input class="price-input" type="number" placeholder="Price" value="${item.price ?? ""}">
        <div class="subtotal">GHâ‚µ ${item.subtotal ?? 0}</div>
      </div>
    `;

    const toggle = div.querySelector(".avail-toggle");
    const priceInput = div.querySelector(".price-input");
    const subtotalEl = div.querySelector(".subtotal");

    toggle.addEventListener("click", () => {
      if (toggle.classList.contains("on")) {
        toggle.classList.remove("on");
        toggle.classList.add("off");
        toggle.textContent = "Unavailable";
        adminOrderData.items[index].available = false;
        adminOrderData.items[index].price = null;
        adminOrderData.items[index].subtotal = 0;
      } else {
        toggle.classList.remove("off");
        toggle.classList.add("on");
        toggle.textContent = "Available";
        adminOrderData.items[index].available = true;
      }
      updateAdminTotals();
    });

    priceInput.addEventListener("input", () => {
      const price = parseFloat(priceInput.value) || 0;
      adminOrderData.items[index].price = price;
      adminOrderData.items[index].subtotal = price * adminOrderData.items[index].qty;
      subtotalEl.textContent = `GHâ‚µ ${adminOrderData.items[index].subtotal}`;
      updateAdminTotals();
    });

    if (item.available === false) {
      adminUnavail.appendChild(div);
    } else {
      adminAvail.appendChild(div);
    }

    if (item.subtotal) total += item.subtotal;
  });

  adminItemsTotal.textContent = total;

  const serviceFee = parseFloat(feeServiceInput.value) || 0;
  const deliveryFee = parseFloat(feeDeliveryInput.value) || 0;

  const grand = total + serviceFee + deliveryFee;
  adminGrandTotal.textContent = grand;
}

feeServiceInput.addEventListener("input", updateAdminTotals);
feeDeliveryInput.addEventListener("input", updateAdminTotals);

/* UPDATE TOTALS */
function updateAdminTotals() {
  let total = 0;

  adminOrderData.items.forEach(i => {
    if (i.subtotal) total += i.subtotal;
  });

  adminItemsTotal.textContent = total;

  const s = parseFloat(feeServiceInput.value) || 0;
  const d = parseFloat(feeDeliveryInput.value) || 0;

  adminGrandTotal.textContent = total + s + d;
}

/* SAVE ADMIN REVIEW */
adminDone.addEventListener("click", async () => {
  await updateDoc(doc(db, "GroceryOrders", adminOrderId), {
    items: adminOrderData.items,
    feeService: parseFloat(feeServiceInput.value) || 0,
    feeDelivery: parseFloat(feeDeliveryInput.value) || 0
  });
  alert("Saved!");
});

/* CANCEL ADMIN */
adminCancel.addEventListener("click", () => {
  adminPanel.style.display = "none";
});

/* ===== Customer Panel (URL: ?order=ID) ===== */
const customerPanel = document.getElementById("customerPanel");
const closeCustomerBtn = document.getElementById("closeCustomerBtn");
const custShop = document.getElementById("custShop");
const custAvail = document.getElementById("custAvail");
const custUnavail = document.getElementById("custUnavail");

const custPay = document.getElementById("custPay");
const custCancel = document.getElementById("custCancel");
const custTotals = document.querySelector(".cust-totals");

if (urlParams.has("order")) {
  openCustomerPanel(urlParams.get("order"));
}

/* OPEN CUSTOMER PANEL */
async function openCustomerPanel(orderId) {
  const snap = await getDoc(doc(db, "GroceryOrders", orderId));
  if (!snap.exists()) return;

  const data = snap.data();

  custShop.textContent = `Order from ${data.customerName}`;

  customerPanel.style.display = "block";

  renderCustomerItems(data);
}

/* RENDER CUSTOMER ITEMS */
function renderCustomerItems(data) {
  custAvail.innerHTML = "";
  custUnavail.innerHTML = "";

  let total = 0;

  data.items.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "cust-item-card";

    div.innerHTML = `
      <div class="cust-row1">
        <div class="cust-item-num">${index + 1}</div>
        <div class="cust-item-name">${item.name}</div>
      </div>

      <div class="cust-row2">
        <div class="cust-badge ${item.available ? "" : "off"}">
          ${item.available ? "Available" : "Unavailable"}
        </div>

        ${
          item.available
            ? `<div class="cust-price-block">
                <div class="cust-price-line">
                  <span class="unit">GHâ‚µ ${item.price}</span>
                  <span class="sub">x ${item.qty} = GHâ‚µ ${item.subtotal}</span>
                </div>
               </div>`
            : ""
        }
      </div>
    `;

    if (item.available) {
      custAvail.appendChild(div);
      total += item.subtotal ?? 0;
    } else {
      custUnavail.appendChild(div);
    }
  });

  /* SHOW TOTALS */
  custTotals.innerHTML = `
    <div class="line"><span>Items total</span><span>GHâ‚µ ${total}</span></div>
  `;
}

/* CLOSE CUSTOMER */
closeCustomerBtn.addEventListener("click", () => {
  customerPanel.style.display = "none";
});

/* ===== Add Grocery Shop ===== */
const shopModal = document.getElementById("shopModal");
const shopCloseBtn = document.getElementById("shopCloseBtn");
const shopCancelBtn = document.getElementById("shopCancelBtn");
const shopSubmitBtn = document.getElementById("shopSubmitBtn");
const shopError = document.getElementById("shopError");

document.getElementById("openShopBtn").addEventListener("click", () => {
  shopModal.classList.add("show");
});

shopCloseBtn.addEventListener("click", () => shopModal.classList.remove("show"));
shopCancelBtn.addEventListener("click", () => shopModal.classList.remove("show"));

shopSubmitBtn.addEventListener("click", submitShop);

/* SUBMIT SHOP */
async function submitShop() {
  const ownerName = document.getElementById("ownerName").value.trim();
  const ownerPhone = document.getElementById("ownerPhone").value.trim();
  const shopNameInput = document.getElementById("shopNameInput").value.trim();
  const shopSloganInput = document.getElementById("shopSloganInput").value.trim();
  const shopShortDesc = document.getElementById("shopShortDesc").value.trim();
  const shopCategory = document.getElementById("shopCategory").value;
  const shopPlan = document.getElementById("shopPlan").value;
  const shopTown = document.getElementById("shopTown").value.trim();
  const shopPhone = document.getElementById("shopPhone").value.trim();
  const shopMainImage = document.getElementById("shopMainImage").files[0];
  const shopSampleImages = document.getElementById("shopSampleImages").files;

  if (!ownerName || !ownerPhone || !shopNameInput || !shopCategory || !shopPlan || !shopTown || !shopPhone || !shopMainImage || shopSampleImages.length === 0) {
    shopError.textContent = "Please fill all required fields.";
    shopError.style.display = "block";
    return;
  }

  shopError.style.display = "none";
  shopSubmitBtn.disabled = true;

  /* UPLOAD IMAGES */
  const mainRef = ref(storage, `GroceryShops/${Date.now()}_${shopMainImage.name}`);
  await uploadBytes(mainRef, shopMainImage);
  const mainImageURL = await getDownloadURL(mainRef);

  const sampleURLs = [];
  for (let i = 0; i < shopSampleImages.length; i++) {
    const f = shopSampleImages[i];
    const r = ref(storage, `GroceryShops/${Date.now()}_${f.name}`);
    await uploadBytes(r, f);
    const url = await getDownloadURL(r);
    sampleURLs.push(url);
  }

  /* SAVE SHOP */
  const refDoc = doc(collection(db, "GroceryShops"));
  await setDoc(refDoc, {
    ownerName,
    ownerPhone,
    shopName: shopNameInput,
    slogan: shopSloganInput,
    shortDesc: shopShortDesc,
    category: shopCategory,
    plan: shopPlan,
    town: shopTown,
    shopPhone,
    mainImageURL,
    sampleImages: sampleURLs,
    createdAt: serverTimestamp()
  });

  alert("Shop submitted!");
  shopModal.classList.remove("show");
  shopSubmitBtn.disabled = false;
  loadShops();
}

/* INITIAL LOAD */
loadShops();

/* ===== JS SECTION END ===== */

</script>

</body>
</html>

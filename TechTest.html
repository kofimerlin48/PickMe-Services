<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tech & Gadgets - PickMe Services</title>

<!-- ===================== HEADER (Injected) ===================== -->
<script>
/* Robust header loader â€” runs after DOM is ready so #header-placeholder exists */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load header');
    let html = await res.text();
    const pageTitle = "Tech & Gadgets";
    html = html.replace(
      /<h1[^>]*>.*?<\/h1>/i,
      `<h1 style="margin:0;font-weight:800;color:#c12872;font-size:24px;position:absolute;left:50%;transform:translateX(-50%)">${pageTitle}</h1>`
    );
    const host = document.getElementById('header-placeholder');
    if (host) {
      host.innerHTML = html;

      // Re-run any scripts within the injected header
      host.querySelectorAll('script').forEach(s0 => {
        const s1 = document.createElement('script');
        if (s0.src) s1.src = s0.src;
        else s1.textContent = s0.textContent;
        document.body.appendChild(s1);
      });
      host.removeAttribute('aria-hidden');
    }
  } catch (e) {
    console.error('[header]', e);
  }
});
</script>

<!-- ===================== STYLES ===================== -->
<style>
:root{
  --theme:#c12872;
  --ink:#222;
  --muted:#666;
  --bg:#f9f9f9;
  --card:#fff;
}

/* base */
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:focus,:focus-visible,button:focus,input:focus,textarea:focus{ outline:none!important; box-shadow:none!important; }
html,body{ height:100%; }
body{
  margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background:var(--bg); color:var(--ink); padding-top:100px; overflow-x:hidden;
}

/* header + search */
.page-header{ text-align:center; margin:0 16px 8px; }
.page-header p{ margin:6px 0 0; color:#000; font-weight:700; font-size:15px; }
.search-bar{ display:flex; justify-content:center; margin:10px 16px 6px; }
.search-bar input{
  width:100%; max-width:640px; padding:12px 14px; border:1px solid #ddd; border-radius:12px; background:#fff; font-size:16px;
}
.search-bar input::placeholder{ color:#999; }

/* top tabs */
.main-tabs{ display:flex; gap:8px; overflow:auto hidden; padding:8px 16px; border-bottom:2px solid #eee; }
.main-tab{ padding:10px 14px; border:1px solid #eee; border-radius:999px; background:#fff; cursor:pointer; user-select:none; font-weight:800; font-size:14px; white-space:nowrap; }
.main-tab.active{ color:#fff; background:var(--theme); border-color:var(--theme); }

/* containers */
.view{ display:none; }
.view.show{ display:block; }
.container{ padding:16px 16px 120px; }

/* categories list */
.categories-grid{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px;
}
.cat-card{
  display:flex; align-items:center; gap:12px; background:#fff; border:1px solid #eee; border-radius:12px; padding:10px 12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06); cursor:pointer;
}
.cat-thumb{ width:42px; height:42px; border-radius:10px; background:#f2f2f2; overflow:hidden; display:grid; place-items:center; flex-shrink:0; }
.cat-thumb img{ width:100%; height:100%; object-fit:cover; }
.cat-info{ flex:1; min-width:0; }
.cat-title{ font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.cat-sub{ font-size:12px; color:#555; }
.cat-arrow{ font-size:18px; color:#999; margin-left:4px; }

/* items grid */
.items-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:12px; }
.item-card{ background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.08); border:1px solid #eee; display:flex; flex-direction:column; min-height:240px; }
.item-img{ position:relative; width:100%; padding-top:66%; background:#f2f2f2; overflow:hidden; }
.item-img img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
.item-body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
.item-price{ font-weight:900; color:#111; }
.item-name{ font-size:14px; font-weight:700; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.item-shop{ font-size:11px; color:#777; }

/* shops grid (hero cards) */
.cards-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:18px; padding-top:6px; }
.shop-card{
  position:relative; height:250px; border-radius:15px; overflow:hidden; background:#ddd center/cover no-repeat;
  box-shadow:0 3px 10px rgba(0,0,0,.08); display:flex; align-items:flex-end; transition:transform .18s ease;
}
.shop-card:hover{ transform:translateY(-4px); }
.shop-card::before{ content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,.75) 100%); }
.shop-card .content{ position:relative; z-index:1; color:#fff; width:100%; padding:15px; display:flex; flex-direction:column; justify-content:space-between; }
.shop-title{ font-weight:900; font-size:20px; margin:0 0 4px; }
.shop-slogan{ font-size:13px; opacity:.95; margin:0 0 4px; }
.shop-lower{ display:flex; align-items:center; justify-content:space-between; }
.shop-meta{ font-size:12px; opacity:.92; }
.btn-enter{ background:var(--theme); color:#fff; border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; }

/* drawer */
#drawer{
  position:fixed; top:0; right:-100%; width:100%; max-width:1100px; height:100%;
  background:#fff; z-index:9999; overflow-y:auto; transition:right .42s ease; box-shadow:-5px 0 16px rgba(0,0,0,.18);
  padding-bottom:140px;
}
#drawer.show{ right:0; }
#drawerClose{
  position:fixed; top:16px; right:-60px; width:42px; height:42px; border-radius:50%;
  background:#111; color:#fff; border:0; font-size:24px; display:grid; place-items:center; z-index:10000; transition:right .42s ease;
}
#drawer.show #drawerClose{ right:16px; }
.banner{
  position:relative; height:35vh; display:grid; place-items:center; text-align:center; color:#fff;
  background:#333 center/cover no-repeat;
}
.banner::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.7), rgba(0,0,0,.82)); }
.banner-text{ position:relative; z-index:1; padding:0 16px; }
.banner-text h2{ margin:0 0 6px; font-size:15px; font-weight:700; }
.banner-text h1{ margin:0 0 6px; font-size:26px; }
.banner-text p{ margin:0; font-size:13px; opacity:.95; }
.drawer-content{ max-width:1100px; margin:0 auto; padding:18px; }
.section-title{ font-weight:900; margin:6px 0 12px; }

/* slider */
.slider{ position:relative; overflow:hidden; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); background:#f2f2f2; }
.slide{ position:absolute; top:0; left:100%; width:100%; height:100%; object-fit:contain; opacity:0; transition:left .45s ease, opacity .45s ease; }
.slide.active{ left:0; opacity:1; }
.slider .nav{ position:absolute; top:50%; transform:translateY(-50%); font-size:24px; color:#fff; background:rgba(0,0,0,.38); padding:6px 10px; border-radius:50%; cursor:pointer; user-select:none; }
.slider .nav.left{ left:10px; }
.slider .nav.right{ right:10px; }
.dots{ display:flex; justify-content:center; gap:6px; margin-top:10px; }
.dot{ width:8px; height:8px; border-radius:50%; background:#ddd; }
.dot.active{ background:var(--theme); }

/* item detail */
.item-detail{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.detail-title{ font-weight:900; font-size:18px; }
.detail-price{ font-weight:900; color:#111; font-size:16px; }
.detail-meta{ font-size:12px; color:#666; }
.detail-desc{ font-size:14px; white-space:pre-wrap; color:#333; }
.actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
.btn-primary{ background:var(--theme); color:#fff; border:0; border-radius:10px; padding:12px 18px; cursor:pointer; font-size:15px; font-weight:800; }
.btn-secondary{ background:#3a3a3a; color:#fff; border:0; border-radius:10px; padding:12px 18px; cursor:pointer; font-size:15px; }

/* inside-drawer top actions */
.shop-top-actions{ position:fixed; top:12px; left:12px; z-index:10002; display:none; gap:8px; }
.action-round{ background:#000; color:#fff; border:0; border-radius:50%; width:40px; height:40px; display:grid; place-items:center; cursor:pointer; font-size:22px; }

/* modal base */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:10001; }
.modal.show{ display:flex; }
.modal-card{ width:95%; max-width:700px; max-height:90vh; background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); overflow:hidden; display:flex; flex-direction:column; }
.modal-header,.modal-footer{ padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:8px; }
.modal-footer{ border-top:1px solid #eee; border-bottom:none; justify-content:flex-end; }
.modal-body{ padding:16px; overflow:auto; }

/* admin option cards */
.mopt-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; }
.mopt-card{ border:1px solid #eee; border-radius:12px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:6px; cursor:pointer; }
.mopt-card h4{ margin:0; font-size:14px; }
.mopt-card p{ margin:0; font-size:12px; color:#555; }
.close-x{ background:#000; color:#fff; border:none; border-radius:50%; width:32px; height:32px; display:grid; place-items:center; cursor:pointer; }

/* inputs */
.input{ width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
.input:focus{ border-color:var(--theme); box-shadow:0 0 0 3px rgba(193,40,114,.08); }
.lbl{ font-size:12px; color:#555; margin:6px 0 4px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; }

/* thumbs */
.thumb-row{ display:flex; gap:8px; overflow-x:auto; }
.thumb{ position:relative; width:90px; height:90px; border-radius:10px; background:#f2f2f2; overflow:hidden; flex-shrink:0; }
.thumb img{ width:100%; height:100%; object-fit:cover; }
.thumb .trash{ position:absolute; top:4px; right:4px; width:22px; height:22px; border:0; border-radius:50%; background:rgba(0,0,0,.55); color:#fff; cursor:pointer; display:grid; place-items:center; }

/* simple toast/progress */
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:opacity .2s; z-index:10050; }
.toast.show{ opacity:1; }

/* footer */
.footer-wrap{ position:fixed; bottom:0; left:0; right:0; z-index:9999; }

/* shop tabs */
.shop-tabs{ display:flex; gap:8px; overflow:auto hidden; padding:8px 0; margin:0 0 10px; }
.shop-tab{ padding:8px 12px; border-radius:999px; background:#eee; cursor:pointer; user-select:none; font-weight:600; font-size:14px; white-space:nowrap; position:relative; }
.shop-tab.active{ background:var(--theme); color:#fff; }
.shop-tab .count{ background:#fff; color:var(--ink); font-size:12px; padding:2px 6px; border-radius:999px; margin-left:4px; display:inline-block; min-width:20px; text-align:center; }
.shop-tab.active .count{ background:rgba(255,255,255,.3); color:#fff; }
</style>
</head>

<body>
<!-- HEADER HOST (must be in <body>, not <head>) -->
<div id="header-placeholder" aria-hidden="true"></div>

<!-- FOUC control -->
<style>
  body.hide-initial *{ visibility:hidden!important; }
  body.ready *{ visibility:visible!important; }
</style>
<script> document.documentElement.style.background="#fff"; document.body.classList.add("hide-initial"); </script>

<!-- ===================== PAGE HEADER + SEARCH ===================== -->
<header class="page-header">
  <h1 class="sr-only" style="position:absolute;left:-9999px">Tech &amp; Gadgets</h1>
  <p>Find tech & gadget shops around you, browse categories, and contact sellers directly</p>
</header>

<div class="search-bar">
  <input id="globalSearch" type="search" placeholder="Search items, shops, models, keywordsâ€¦" aria-label="Search">
</div>

<!-- ===================== TOP TABS ===================== -->
<nav class="main-tabs" aria-label="Main sections">
  <button class="main-tab active" data-view="allItemsView" aria-pressed="true">All Items</button>
  <button class="main-tab" data-view="categoriesView" aria-pressed="false">Categories</button>
  <button class="main-tab" data-view="shopsView" aria-pressed="false">Shops</button>
</nav>

<!-- ===================== ALL ITEMS VIEW ===================== -->
<section id="allItemsView" class="view show" aria-label="All Items">
  <div class="container">
    <div id="allItemsGrid" class="items-grid" aria-live="polite"></div>
  </div>
</section>

<!-- ===================== CATEGORIES VIEW ===================== -->
<section id="categoriesView" class="view" aria-label="Categories">
  <div class="container">
    <div id="categoriesGrid" class="categories-grid" aria-live="polite"></div>
    <!-- Legacy inline block kept but unused; we now show categories inside drawer -->
    <div id="categoryItemsWrap" style="display:none;margin-top:14px;">
      <div id="categoryItemsTitle" class="section-title"></div>
      <div class="search-bar" style="margin:6px 0 12px;">
        <input id="categorySearch" class="input" type="search" placeholder="Search within this categoryâ€¦" aria-label="Category search">
      </div>
      <div id="categoryItemsGrid" class="items-grid" aria-live="polite"></div>
    </div>
  </div>
</section>

<!-- ===================== SHOPS VIEW ===================== -->
<section id="shopsView" class="view" aria-label="Shops">
  <div class="container">
    <div id="shopsGrid" class="cards-grid" aria-live="polite"></div>
  </div>
</section>

<!-- ===================== DRAWER (ITEM / CATEGORY / SHOP) ===================== -->
<aside id="drawer" aria-hidden="true" aria-label="Details drawer">
  <button id="catBackBtn" aria-label="Back" style="position:fixed;top:12px;left:12px;padding:8px 16px;border:none;border-radius:6px;background:#000;color:#fff;font-weight:700;font-size:14px;display:none;z-index:10002;">
    BACK
  </button>
  <button id="drawerClose" aria-label="Close details">&times;</button>

  <!-- shop header -->
  <section id="shopBanner" class="banner" style="display:none;">
    <div class="banner-text">
      <h2>Welcome to</h2>
      <h1 id="shopName"></h1>
      <p id="shopSlogan"></p>
    </div>
  </section>

  <!-- inside-drawer actions (restore hamburger left + close at right) -->
  <div id="shopTopActions" class="shop-top-actions">
    <button id="hamburgerBtn" class="action-round" aria-label="Admin">&#9776;</button>
  </div>

  <div class="drawer-content">
    <!-- Item detail -->
    <div id="itemDetail" style="display:none;">
      <div id="itemSlider" class="slider"></div>
      <div id="itemDots" class="dots"></div>
      <div class="item-detail">
        <div id="detailTitle" class="detail-title"></div>
        <div id="detailPrice" class="detail-price"></div>
        <div id="detailPostedBy" class="detail-meta"></div>
        <div id="detailDesc" class="detail-desc"></div>
        <div class="actions-row">
          <button id="callBtn" class="btn-primary">Call</button>
          <button id="waBtn" class="btn-secondary">WhatsApp</button>
          <button id="viewShopBtn" class="btn-primary">View Shop</button>
        </div>
      </div>
    </div>

    <!-- Shop gallery -->
    <div id="shopGallery" style="display:none;">
      <div class="section-title">Items</div>
      <div id="shopTabs" class="shop-tabs"></div>
      <div id="shopItemsGrid" class="items-grid"></div>
    </div>

    <!-- Category page within drawer -->
    <div id="catPage" style="display:none;">
      <div class="section-title" id="catPageTitle"></div>
      <div class="search-bar" style="margin:6px 0 12px;">
        <input id="catPageSearch" class="input" type="search" placeholder="Search within this categoryâ€¦" aria-label="Category search">
      </div>
      <div id="catPageGrid" class="items-grid" aria-live="polite"></div>
    </div>
  </div>
</aside>

<!-- ===================== MODALS ===================== -->
<!-- per-shop access code -->
<div id="codeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="codeTitle">Enter Access Code</span>
      <button id="codeClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="codeInput" class="input" placeholder="Access code" aria-label="Access code">
    </div>
    <div class="modal-footer">
      <button id="codeCancel" class="btn-secondary">Back</button>
      <button id="codeOk" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<!-- admin options -->
<div id="adminOptionsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="adminTitle">Admin</span>
      <button id="adminOptClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="mopt-grid">
        <div id="optAdd" class="mopt-card"><h4>Add item</h4></div>
        <div id="optDelete" class="mopt-card"><h4>Delete item</h4></div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="adminOptCancel" class="btn-secondary">Close</button>
    </div>
  </div>
</div>

<!-- choose category -->
<div id="catChooseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="catChooseTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="catChooseTitle">Choose Category</span>
      <button id="catChooseClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="catChooseGrid" class="mopt-grid"></div>
    </div>
    <div class="modal-footer">
      <button id="catChooseCancel" class="btn-secondary">Back</button>
    </div>
  </div>
</div>

<!-- draft editor -->
<div id="draftModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="draftTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="draftTitle">Add items</span>
      <button id="draftClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="draftHint" class="lbl" style="font-weight:700">Upload up to 5 images</div>
      <input id="imgInput" type="file" accept="image/*" multiple class="input" aria-label="Upload images" style="display:none">
      <div class="row" style="margin-bottom:6px">
        <button id="addImagesBtn" class="btn-primary" type="button">Add images</button>
      </div>
      <div id="imgThumbs" class="thumb-row"></div>
      <div class="lbl">Name</div>
      <input id="nameInput" class="input" placeholder="e.g., iPhone 13 Pro Max 128GB">
      <div class="lbl">Price (GHâ‚µ)</div>
      <input id="priceInput" class="input" type="number" min="0" step="1" placeholder="e.g., 4500">
      <div class="lbl">Description / Specs</div>
      <textarea id="descInput" class="input" rows="4" placeholder="Key specs, condition, warrantyâ€¦"></textarea>
      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
      <div id="draftList"></div>
    </div>
    <div class="modal-footer">
      <button id="clearFormBtn" class="btn-secondary">Clear form</button>
      <button id="addMoreBtn" class="btn-secondary">Add more</button>
      <button id="submitDraftsBtn" class="btn-primary">Submit</button>
    </div>
  </div>
</div>

<!-- delete picker -->
<div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="deleteTitle">Delete item</span>
      <button id="deleteClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="deleteList"></div>
    </div>
    <div class="modal-footer">
      <button id="deleteCancel" class="btn-secondary">Back</button>
    </div>
  </div>
</div>

<!-- number capture -->
<div id="numberModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="numberTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="numberTitle">Your WhatsApp number</span>
      <button id="numberClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="waNumberInput" class="input" placeholder="+233â€¦ or 0â€¦" inputmode="tel" aria-label="WhatsApp number">
      <div id="numberError" style="display:none;color:#b00020;font-size:13px;margin-top:6px"></div>
    </div>
    <div class="modal-footer">
      <button id="numberCancel" class="btn-secondary">Back</button>
      <button id="numberOk" class="btn-primary">Continue</button>
    </div>
  </div>
</div>

<!-- review admin -->
<div id="reviewCodeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="reviewTitle">PickMe Admin Access</span>
      <button id="reviewCodeClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="reviewCodeInput" class="input" placeholder="Enter admin code" aria-label="Admin code">
    </div>
    <div class="modal-footer">
      <button id="reviewCodeCancel" class="btn-secondary">Back</button>
      <button id="reviewCodeOk" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ===================== LOGIC (Firebase + App) ===================== -->
<script type="module">
/* Firebase (v10) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll, deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB2L649fIs0CS-fGDC0ybFeAO5Im5BEP_c",
  authDomain: "pickmeservicesonline.firebaseapp.com",
  projectId: "pickmeservicesonline",
  storageBucket: "pickmeservicesonline.firebasestorage.app",
  messagingSenderId: "265031616239",
  appId: "1:265031616239:web:e2ef418704af5595aa7d1a"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const st = getStorage(app);

/* ===== Constants ===== */
const PAGE_KEY = "Tech&Gadgets";
const PICKME_WHATSAPP = "233534742142";
const GLOBAL_ADMIN_CODE = "999888";
const SHOP_ADMIN_DEFAULT_CODE = "123456";
const MAX_IMAGES = 5;
const SHOPS_SUB_COL = "shops";

/* ===== Shops (hardcoded) ===== */
const SHOPS = [
  {
    name: "Trick Eye Store",
    slogan: "Phones, laptops & accessories",
    heroImage: "https://via.placeholder.com/1200x700?text=Trick+Eye+Store",
    phone: "233530477395",
    accessCode: "123456",
    expiry: "2026-12-31"
  },
  {
    name: "DigiHub",
    slogan: "All things electronics",
    heroImage: "https://via.placeholder.com/1200x700?text=DigiHub",
    phone: "233540576548",
    accessCode: "123456",
    expiry: "2026-10-31"
  }
];

/* ===== Categories (global) ===== */
const CATEGORIES = [
  { id: "Phones", img: "https://via.placeholder.com/200?text=Phones" },
  { id: "Computers & Laptops", img: "https://via.placeholder.com/200?text=Laptops" },
  { id: "Printers & Scanners", img: "https://via.placeholder.com/200?text=Printers" },
  { id: "Accessories", img: "https://via.placeholder.com/200?text=Accessories" },
  { id: "Security & Surveillance", img: "https://via.placeholder.com/200?text=Security" },
  { id: "Networking", img: "https://via.placeholder.com/200?text=Networking" },
  { id: "Gaming", img: "https://via.placeholder.com/200?text=Gaming" },
  { id: "Software", img: "https://via.placeholder.com/200?text=Software" },
  { id: "Cameras & Photo", img: "https://via.placeholder.com/200?text=Cameras" }
];

/* ===== Firestore paths ===== */
const linksCol = collection(db, PAGE_KEY, "Links", "items");
const globalNums = collection(db, PAGE_KEY, "Numbers", "items");

/* ===== DOM ===== */
const tabs = document.querySelectorAll('.main-tab');
const categoriesView = document.getElementById('categoriesView');
const shopsView = document.getElementById('shopsView');
const allItemsView = document.getElementById('allItemsView');
const categoriesGrid = document.getElementById('categoriesGrid');
const shopsGrid = document.getElementById('shopsGrid');
const allItemsGrid = document.getElementById('allItemsGrid');
const globalSearch = document.getElementById('globalSearch');
const drawer = document.getElementById('drawer');
const drawerClose = document.getElementById('drawerClose');
const shopBanner = document.getElementById('shopBanner');
const shopTopActions = document.getElementById('shopTopActions');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const shopNameEl = document.getElementById('shopName');
const shopSloganEl = document.getElementById('shopSlogan');
const shopGallery = document.getElementById('shopGallery');
const shopTabs = document.getElementById('shopTabs');
const shopItemsGrid = document.getElementById('shopItemsGrid');
const catPage = document.getElementById('catPage');
const catPageTitle = document.getElementById('catPageTitle');
const catPageSearch = document.getElementById('catPageSearch');
const catPageGrid = document.getElementById('catPageGrid');
const itemDetail = document.getElementById('itemDetail');
const itemSlider = document.getElementById('itemSlider');
const itemDots = document.getElementById('itemDots');
const detailTitle = document.getElementById('detailTitle');
const detailPrice = document.getElementById('detailPrice');
const detailDesc = document.getElementById('detailDesc');
const detailPostedBy = document.getElementById('detailPostedBy');
const callBtn = document.getElementById('callBtn');
const waBtn = document.getElementById('waBtn');
const viewShopBtn = document.getElementById('viewShopBtn');
const codeModal = document.getElementById('codeModal');
const codeInput = document.getElementById('codeInput');
const codeOk = document.getElementById('codeOk');
const codeCancel = document.getElementById('codeCancel');
const codeClose = document.getElementById('codeClose');
const adminOptionsModal = document.getElementById('adminOptionsModal');
const optAdd = document.getElementById('optAdd');
const optDelete = document.getElementById('optDelete');
const adminOptClose = document.getElementById('adminOptClose');
const adminOptCancel = document.getElementById('adminOptCancel');
const catChooseModal = document.getElementById('catChooseModal');
const catChooseGrid = document.getElementById('catChooseGrid');
const catChooseClose = document.getElementById('catChooseClose');
const catChooseCancel = document.getElementById('catChooseCancel');
const draftModal = document.getElementById('draftModal');
const draftClose = document.getElementById('draftClose');
const draftTitle = document.getElementById('draftTitle');
const imgInput = document.getElementById('imgInput');
const imgThumbs = document.getElementById('imgThumbs');
const addImagesBtn = document.getElementById('addImagesBtn');
const nameInput = document.getElementById('nameInput');
const priceInput = document.getElementById('priceInput');
const descInput = document.getElementById('descInput');
const addMoreBtn = document.getElementById('addMoreBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const submitDraftsBtn = document.getElementById('submitDraftsBtn');
const draftList = document.getElementById('draftList');
const deleteModal = document.getElementById('deleteModal');
const deleteClose = document.getElementById('deleteClose');
const deleteCancel = document.getElementById('deleteCancel');
const deleteList = document.getElementById('deleteList');
const numberModal = document.getElementById('numberModal');
const waNumberInput = document.getElementById('waNumberInput');
const numberOk = document.getElementById('numberOk');
const numberCancel = document.getElementById('numberCancel');
const numberClose = document.getElementById('numberClose');
const numberError = document.getElementById('numberError');
const reviewCodeModal = document.getElementById('reviewCodeModal');
const reviewCodeInput = document.getElementById('reviewCodeInput');
const reviewCodeOk = document.getElementById('reviewCodeOk');
const reviewCodeClose = document.getElementById('reviewCodeClose');
const reviewCodeCancel = document.getElementById('reviewCodeCancel');
const toastEl = document.getElementById('toast');
const catBackBtn = document.getElementById('catBackBtn');

/* ===== State ===== */
let currentShop = null;
let currentShopName = null;
let jumpToAdId = null;
let currentCategory = null;
let pendingAction = null;
let pendingContactFor = null;
let drafts = []; // {id, cat, name, price, desc, files[]}
let filesBuffer = []; // File[] (current add form)
let userPhoneCache = null;
let reviewPayloadPending = null;

/* ===== Helpers ===== */
const show = el => el && (el.style.display = '');
const hide = el => el && (el.style.display = 'none');
const escapeHtml = s => String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
const money = n => Number(n || 0);
const fmtPrice = n => `GHâ‚µ ${Number(n || 0).toFixed(2).replace(/\.00$/, '')}`;
const isExpired = iso => iso ? (new Date() > new Date(iso + "T23:59:59")) : false;
const makeId = () => (Date.now().toString(36) + Math.random().toString(36).slice(2, 8)).toLowerCase();

function toast(msg) {
  if (toastEl) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.classList.remove('show'), 1600);
  }
}

async function urlToSmallPreviewDataURL(url) {
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) return null;
    const blob = await res.blob();
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    await new Promise(r => img.onload = r);
    const canvas = document.createElement('canvas');
    const scale = Math.min(480 / img.width, 1);
    canvas.width = Math.max(1, Math.round(img.width * scale));
    canvas.height = Math.max(1, Math.round(img.height * scale));
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    URL.revokeObjectURL(img.src);
    return canvas.toDataURL('image/jpeg', 0.7);
  } catch (e) {
    console.warn('preview error', e);
    return null;
  }
}

async function ensureShopsContainer() {
  try {
    const ref = doc(db, PAGE_KEY, "Shops");
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
    } else {
      await setDoc(ref, { updatedAt: serverTimestamp() }, { merge: true });
    }
  } catch (e) {
    console.warn('[ensureShopsContainer]', e);
  }
}

async function ensureShopDoc(shopName) {
  await ensureShopsContainer();
  try {
    const ref = doc(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, shopName);
    const snap = await getDoc(ref);
    const meta = SHOPS.find(s => s.name === shopName) || {};
    if (!snap.exists()) {
      await setDoc(ref, {
        name: shopName,
        slogan: meta.slogan || "",
        heroImage: meta.heroImage || "",
        phone: meta.phone || "",
        expiry: meta.expiry || "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });
    } else {
      await setDoc(ref, { updatedAt: serverTimestamp() }, { merge: true });
    }
  } catch (e) {
    console.warn('[ensureShopDoc]', e);
  }
}

function normalizeGhanaNumber(input) {
  let s = String(input || '').trim().replace(/[\s\-]/g, '');
  if (s.startsWith('+233')) return { e164: s, wa: s.slice(1) };
  if (s.startsWith('233')) return { e164: '+' + s, wa: s };
  if (/^0\d{9}$/.test(s)) return { e164: '+233' + s.slice(1), wa: '233' + s.slice(1) };
  if (/^\d{9}$/.test(s)) return { e164: '+233' + s, wa: '233' + s };
  const d = s.replace(/\D/g, '');
  if (d.startsWith('233')) return { e164: '+' + d, wa: d };
  if (d.length === 10 && d.startsWith('0')) return { e164: '+233' + d.slice(1), wa: '233' + d.slice(1) };
  return null;
}

/* ===== Cache keys ===== */
const CACHE_PREFIX = "tg_v1_";
const CACHE = {
  cats: `${CACHE_PREFIX}cats_counts`,
  shops: `${CACHE_PREFIX}shops_counts`,
  shopItems: shop => `${CACHE_PREFIX}shop_${shop}_items`,
  catItems: cat => `${CACHE_PREFIX}cat_${cat}_items`,
  allItems: `${CACHE_PREFIX}all_items`
};
const saveCache = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
const loadCache = (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } };
const clearShopCaches = (shop) => {
  try {
    localStorage.removeItem(CACHE.shopItems(shop));
    localStorage.removeItem(CACHE.cats);
    localStorage.removeItem(CACHE.shops);
    localStorage.removeItem(CACHE.allItems);
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith(`${CACHE_PREFIX}cat_`)) localStorage.removeItem(k);
    });
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith('tk_shop_') || k.startsWith('tk_cat_') || k === 'tk_cats_counts' || k === 'tk_shops_counts') {
        localStorage.removeItem(k);
      }
    });
  } catch {}
};

/* ===== Categories & Items ===== */
async function countByCategory() {
  const cached = loadCache(CACHE.cats);
  if (cached) {
    console.log('Using cached category counts:', cached);
    return cached;
  }
  const out = {};
  try {
    await Promise.all(SHOPS.map(async sh => {
      if (isExpired(sh.expiry)) return;
      const col = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, sh.name, "items");
      const snap = await getDocs(col);
      console.log(`Fetched ${snap.size} items for shop ${sh.name}`);
      snap.forEach(d => {
        const it = d.data();
        const cat = it.category || "Other";
        out[cat] = (out[cat] || 0) + 1;
      });
    }));
    console.log('Category counts:', out);
    saveCache(CACHE.cats, out);
    return out;
  } catch (e) {
    console.error('countByCategory failed:', e);
    return out;
  }
}

function renderCategoriesGrid(counts) {
  if (categoriesGrid) {
    categoriesGrid.innerHTML = "";
    if (!CATEGORIES.length) {
      categoriesGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No categories available.</p>`;
      return;
    }
    CATEGORIES.forEach(c => {
      const card = document.createElement('article');
      card.className = "cat-card";
      card.innerHTML = `
        <div class="cat-thumb">${c.img ? `<img src="${c.img}" alt="${escapeHtml(c.id)}">` : ''}</div>
        <div class="cat-info">
          <div class="cat-title">${escapeHtml(c.id)}</div>
          <div class="cat-sub">${counts[c.id] || 0} adverts</div>
        </div>
        <div class="cat-arrow">&gt;</div>
      `;
      card.addEventListener('click', () => openCategory(c.id));
      categoriesGrid.appendChild(card);
    });
  }
}

async function fetchAllItemsInCategory(cat) {
  const cached = loadCache(CACHE.catItems(cat));
  if (cached) return cached;
  const items = [];
  await Promise.all(SHOPS.map(async sh => {
    if (isExpired(sh.expiry)) return;
    const col = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d => {
      const it = d.data();
      it.id = d.id;
      if ((it.category || '') === cat) items.push(it);
    });
  }));
  items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
  saveCache(CACHE.catItems(cat), items);
  return items;
}

function renderItemCard(container, ad, inShop = false) {
  if (container) {
    const card = document.createElement('div');
    card.className = "item-card";
    const firstImg = (ad.images && ad.images[0]) || "https://via.placeholder.com/600x400?text=Image";
    card.innerHTML = `
      <div class="item-img"><img src="${firstImg}" alt="${escapeHtml(ad.name || 'Item')}"></div>
      <div class="item-body">
        <div class="item-price">${fmtPrice(ad.price)}</div>
        <div class="item-name">${escapeHtml(ad.name || '')}</div>
        ${inShop ? '' : `<div class="item-shop">Posted by ${escapeHtml(ad.shop || '')}</div>`}
      </div>
    `;
    card.addEventListener('click', () => openItemDetail(ad));
    container.appendChild(card);
  }
}

async function openCategory(cat) {
  currentCategory = cat;
  hide(shopBanner);
  hide(shopGallery);
  hide(itemDetail);
  show(catPage);
  if (catPageTitle) catPageTitle.textContent = cat;
  if (catPageTitle) catPageTitle.style.fontSize = "20px";
  if (catPageTitle) catPageTitle.style.fontWeight = "800";
  if (catPageTitle) catPageTitle.style.textAlign = "center";
  if (catPageSearch) catPageSearch.placeholder = `Search in ${cat}â€¦`;
  if (catPageGrid) catPageGrid.innerHTML = '';
  openDrawer();
  if (catBackBtn) catBackBtn.style.display = "block";
  if (hamburgerBtn) hamburgerBtn.style.display = "none";
  if (drawerClose) drawerClose.style.display = "none";
  const items = await fetchAllItemsInCategory(cat);
  const draw = (list) => {
    if (catPageGrid) {
      catPageGrid.innerHTML = "";
      list.forEach(ad => renderItemCard(catPageGrid, ad));
      if (!list.length) {
        catPageGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">Oops! No items here today.</p>`;
      }
    }
  };
  draw(items);
  if (catPageSearch) {
    catPageSearch.value = '';
    catPageSearch.oninput = () => {
      const q = (catPageSearch.value || '').toLowerCase();
      const list = items.filter(ad =>
        (ad.name || '').toLowerCase().includes(q) ||
        (ad.desc || '').toLowerCase().includes(q) ||
        (ad.shop || '').toLowerCase().includes(q)
      );
      draw(list);
    };
  }
}

async function fetchShopCounts() {
  const cached = loadCache(CACHE.shops);
  if (cached) {
    console.log('Using cached shop counts:', cached);
    return cached;
  }
  const map = {};
  try {
    await Promise.all(SHOPS.map(async sh => {
      if (isExpired(sh.expiry)) { map[sh.name] = 0; return; }
      const col = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, sh.name, "items");
      const snap = await getDocs(col);
      map[sh.name] = snap.size || 0;
      console.log(`Shop ${sh.name} has ${snap.size} items`);
    }));
    console.log('Shop counts:', map);
    saveCache(CACHE.shops, map);
    return map;
  } catch (e) {
    console.error('fetchShopCounts failed:', e);
    return map;
  }
}

function renderShopsGrid(countMap) {
  if (shopsGrid) {
    shopsGrid.innerHTML = "";
    const list = SHOPS.filter(s => !isExpired(s.expiry))
      .sort((a, b) => (countMap[b.name] || 0) - (countMap[a.name] || 0) || a.name.localeCompare(b.name));
    if (!list.length) {
      shopsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No shops available.</p>`;
      return;
    }
    list.forEach(shop => {
      const card = document.createElement('article');
      card.className = "shop-card";
      card.style.backgroundImage = `url('${shop.heroImage}')`;
      const content = document.createElement('div');
      content.className = "content";
      content.innerHTML = `
        <div>
          <div class="shop-title">${escapeHtml(shop.name)}</div>
          <div class="shop-slogan">${escapeHtml(shop.slogan || '')}</div>
        </div>
        <div class="shop-lower">
          <p class="shop-meta">Items: ${countMap[shop.name] || 0}</p>
          <button class="btn-enter" type="button">Enter Shop</button>
        </div>
      `;
      content.querySelector('.btn-enter').addEventListener('click', () => openShop(shop));
      card.appendChild(content);
      shopsGrid.appendChild(card);
    });
  }
}

async function fetchAllItems() {
  const cached = loadCache(CACHE.allItems);
  if (cached) return cached;
  const items = [];
  await Promise.all(SHOPS.map(async sh => {
    if (isExpired(sh.expiry)) return;
    const col = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d => {
      const it = d.data();
      it.id = d.id;
      it.shop = sh.name;
      items.push(it);
    });
  }));
  items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
  saveCache(CACHE.allItems, items);
  return items;
}

function renderAllItemsGrid(items) {
  if (allItemsGrid) {
    allItemsGrid.innerHTML = "";
    if (!items.length) {
      allItemsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No items available.</p>`;
      return;
    }
    items.forEach(ad => renderItemCard(allItemsGrid, ad));
  }
}

const openDrawer = () => {
  if (drawer) {
    drawer.classList.add('show');
    drawer.setAttribute('aria-hidden', 'false');
    if (shopTopActions) shopTopActions.style.display = 'flex';
  }
};

const closeDrawer = () => {
  if (drawer) {
    drawer.classList.remove('show');
    drawer.setAttribute('aria-hidden', 'true');
    if (shopTopActions) shopTopActions.style.display = 'none';
    hide(shopBanner);
    hide(shopGallery);
    hide(itemDetail);
    hide(catPage);
    if (catBackBtn) catBackBtn.style.display = "none";
  }
};

if (drawerClose) drawerClose.addEventListener('click', closeDrawer);
if (catBackBtn) catBackBtn.addEventListener('click', closeDrawer);

function buildSlider(images, sliderEl, dotsEl) {
  if (sliderEl && dotsEl) {
    sliderEl.innerHTML = '';
    dotsEl.innerHTML = '';
    if (!images || !images.length) images = ["https://via.placeholder.com/1000x600?text=Image"];
    const slidesContainer = document.createElement('div');
    slidesContainer.style.display = 'flex';
    slidesContainer.style.transition = 'transform 0.45s ease';
    slidesContainer.style.width = `${images.length * 100}%`;
    images.forEach((src, i) => {
      const slide = document.createElement('div');
      slide.style.width = `${100 / images.length}%`;
      slide.style.height = '100%';
      const img = document.createElement('img');
      img.src = src;
      img.alt = `image-${i + 1}`;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      slide.appendChild(img);
      slidesContainer.appendChild(slide);
    });
    // Clone for infinite
    const firstClone = slidesContainer.children[0].cloneNode(true);
    const lastClone = slidesContainer.children[images.length - 1].cloneNode(true);
    slidesContainer.appendChild(firstClone);
    slidesContainer.insertBefore(lastClone, slidesContainer.children[0]);
    slidesContainer.style.width = `${(images.length + 2) * 100}%`;
    slidesContainer.style.transform = `translateX(-${100 / (images.length + 2)}%)`;
    sliderEl.appendChild(slidesContainer);
    images.forEach((_, i) => {
      const dot = document.createElement('div');
      dot.className = 'dot' + (i === 0 ? ' active' : '');
      dot.addEventListener('click', () => goTo(i));
      dotsEl.appendChild(dot);
    });
    const left = document.createElement('div');
    left.className = 'nav left';
    left.innerHTML = '&#10094;';
    const right = document.createElement('div');
    right.className = 'nav right';
    right.innerHTML = '&#10095;';
    sliderEl.append(left, right);

    let current = 0;
    const total = images.length;
    const dots = dotsEl.querySelectorAll('.dot');
    let isTransitioning = false;

    function updateDots() {
      dots.forEach(d => d.classList.remove('active'));
      dots[current].classList.add('active');
    }

    function moveTo(index, animate = true) {
      if (isTransitioning) return;
      isTransitioning = true;
      const pos = -(index + 1) * (100 / (total + 2));
      slidesContainer.style.transition = animate ? 'transform 0.45s ease' : 'none';
      slidesContainer.style.transform = `translateX(${pos}%)`;
      setTimeout(() => {
        isTransitioning = false;
        if (index < 0) {
          current = total - 1;
          moveTo(current, false);
        } else if (index >= total) {
          current = 0;
          moveTo(current, false);
        } else {
          current = index;
        }
        updateDots();
      }, animate ? 450 : 0);
    }

    function goTo(n) {
      moveTo(n);
    }

    left.addEventListener('click', () => moveTo(current - 1));
    right.addEventListener('click', () => moveTo(current + 1));

    let startX = 0;
    let dist = 0;
    sliderEl.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      dist = 0;
    }, { passive: true });
    sliderEl.addEventListener('touchmove', e => {
      dist = e.touches[0].clientX - startX;
    }, { passive: true });
    sliderEl.addEventListener('touchend', () => {
      if (Math.abs(dist) > 40) {
        if (dist > 0) left.click();
        else right.click();
      }
    }, { passive: true });
    updateDots();
    // Preload and set height dynamically
    let maxHeight = 0;
    const imgs = slidesContainer.querySelectorAll('img');
    let loaded = 0;
    imgs.forEach(img => {
      img.onload = () => {
        loaded++;
        const ratio = img.naturalHeight / img.naturalWidth;
        const h = ratio * sliderEl.clientWidth;
        if (h > maxHeight) maxHeight = h;
        if (loaded === imgs.length) {
          sliderEl.style.height = `${maxHeight}px`;
        }
      };
    });
  }
}

function openItemDetail(ad) {
  hide(shopBanner);
  hide(shopGallery);
  hide(catPage);
  show(itemDetail);
  buildSlider(ad.images || [], itemSlider, itemDots);
  if (detailTitle) detailTitle.textContent = ad.name || 'Item';
  if (detailPrice) detailPrice.textContent = fmtPrice(ad.price);
  if (detailPostedBy) detailPostedBy.textContent = "Posted by " + (ad.shop || '');
  if (detailDesc) detailDesc.textContent = ad.desc || '';
  openDrawer();
  if (callBtn) callBtn.onclick = () => captureNumberThenProceed('call', ad);
  if (waBtn) waBtn.onclick = () => captureNumberThenProceed('wa', ad);
  if (viewShopBtn) viewShopBtn.onclick = () => {
    jumpToAdId = ad.id || null;
    const shopObj = SHOPS.find(s => s.name === ad.shop);
    if (shopObj) openShop(shopObj);
  };
}

async function openShop(shop) {
  currentShop = shop;
  currentShopName = shop.name;
  jumpToAdId = jumpToAdId || null;
  if (shopBanner) shopBanner.style.backgroundImage = `url('${shop.heroImage}')`;
  if (shopNameEl) shopNameEl.textContent = shop.name;
  if (shopSloganEl) shopSloganEl.textContent = shop.slogan || '';
  show(shopBanner);
  show(shopGallery);
  hide(itemDetail);
  hide(catPage);
  openDrawer();
  if (hamburgerBtn) hamburgerBtn.style.display = "grid";
  if (drawerClose) drawerClose.style.display = "grid";
  if (hamburgerBtn) hamburgerBtn.onclick = () => promptShopCode();
  await renderShopTabsAndItems(shop, jumpToAdId);
  jumpToAdId = null;
}

async function renderShopTabsAndItems(shop, focusAdId = null) {
  const items = await fetchShopItems(shop.name);
  const byCat = {};
  items.forEach(it => {
    const c = it.category || 'Other';
    (byCat[c] || (byCat[c] = [])).push(it);
  });
  const catList = Object.keys(byCat).map(c => ({ cat: c, count: byCat[c].length }));
  catList.sort((a, b) => b.count - a.count || a.cat.localeCompare(b.cat));
  if (shopTabs) {
    shopTabs.innerHTML = "";
    catList.forEach((entry, i) => {
      const div = document.createElement('div');
      div.className = 'shop-tab' + (i === 0 ? ' active' : '');
      div.dataset.cat = entry.cat;
      div.innerHTML = `${escapeHtml(entry.cat)} <span class="count">${entry.count}</span>`;
      div.addEventListener('click', () => {
        shopTabs.querySelectorAll('.shop-tab').forEach(b => b.classList.remove('active'));
        div.classList.add('active');
        renderShopItems(byCat[entry.cat]);
      });
      shopTabs.appendChild(div);
    });
    if (!catList.length) {
      if (shopItemsGrid) shopItemsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No items yet.</p>`;
      return;
    }
    const firstCat = focusAdId ? catList.find(e => (byCat[e.cat] || []).some(it => it.id === focusAdId))?.cat : catList[0].cat;
    shopTabs.querySelectorAll('.shop-tab').forEach(b => b.dataset.cat === firstCat && b.classList.add('active'));
    renderShopItems(byCat[firstCat], focusAdId);
  }
}

function renderShopItems(list, focusAdId = null) {
  if (shopItemsGrid) {
    shopItemsGrid.innerHTML = '';
    list.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).forEach(ad => renderItemCard(shopItemsGrid, ad, true));
    if (!list.length) shopItemsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No items in this category.</p>`;
    if (focusAdId) {
      const ad = list.find(x => x.id === focusAdId);
      if (ad) openItemDetail(ad);
    }
  }
}

async function fetchShopItems(shopName) {
  const ck = CACHE.shopItems(shopName);
  const cached = loadCache(ck);
  if (cached) return cached;
  const col = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, shopName, "items");
  const snap = await getDocs(col);
  const arr = [];
  snap.forEach(d => {
    const it = d.data();
    it.id = d.id;
    arr.push(it);
  });
  arr.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
  saveCache(ck, arr);
  return arr;
}

if (globalSearch) globalSearch.addEventListener('input', () => {
  const q = (globalSearch.value || '').trim().toLowerCase();
  if (categoriesView.classList.contains('show')) {
    [...categoriesGrid.children].forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  }
  if (shopsView.classList.contains('show')) {
    [...shopsGrid.children].forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  }
  if (allItemsView && allItemsView.classList.contains('show')) {
    const cachedItems = loadCache(CACHE.allItems) || [];
    const filtered = cachedItems.filter(ad =>
      (ad.name || '').toLowerCase().includes(q) ||
      (ad.desc || '').toLowerCase().includes(q) ||
      (ad.shop || '').toLowerCase().includes(q) ||
      (ad.category || '').toLowerCase().includes(q)
    );
    renderAllItemsGrid(filtered);
    fetchAllItems().then(freshItems => {
      const freshFiltered = freshItems.filter(ad =>
        (ad.name || '').toLowerCase().includes(q) ||
        (ad.desc || '').toLowerCase().includes(q) ||
        (ad.shop || '').toLowerCase().includes(q) ||
        (ad.category || '').toLowerCase().includes(q)
      );
      if (JSON.stringify(freshFiltered) !== JSON.stringify(filtered)) {
        renderAllItemsGrid(freshFiltered);
      }
    }).catch(e => console.warn('Failed to update all items search', e));
  }
});

tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
    btn.classList.add('active');
    btn.setAttribute('aria-pressed', 'true');
    const target = btn.dataset.view;
    const views = [categoriesView, shopsView, allItemsView].filter(v => v); // Filter out null/undefined
    views.forEach(v => v.classList.remove('show'));
    const targetView = document.getElementById(target);
    if (targetView) {
      targetView.classList.add('show');
    } else {
      console.warn(`View with ID ${target} not found`);
    }
    closeDrawer();
    if (target === 'allItemsView' && targetView) {
      const cachedItems = loadCache(CACHE.allItems) || [];
      renderAllItemsGrid(cachedItems);
      fetchAllItems().then(freshItems => {
        if (JSON.stringify(freshItems) !== JSON.stringify(cachedItems)) {
          renderAllItemsGrid(freshItems);
        }
      }).catch(e => console.warn('Failed to update all items', e));
    }
  });
});

function openModal(m) { if (m) m.classList.add('show'); }
function closeModal(m) { if (m) m.classList.remove('show'); }

function openNumberModal() { openModal(numberModal); }
function closeNumberModal() { closeModal(numberModal); }
[numberClose, numberCancel].forEach(b => b && b.addEventListener('click', closeNumberModal));

async function captureNumberThenProceed(kind, ad) {
  pendingAction = kind;
  pendingContactFor = {
    shopName: ad.shop,
    phone: (SHOPS.find(s => s.name === ad.shop)?.phone) || "",
    itemTitle: ad.name
  };
  if (waNumberInput) waNumberInput.value = userPhoneCache || "";
  if (numberError) numberError.style.display = 'none';
  openNumberModal();
}

if (numberOk) numberOk.addEventListener('click', async () => {
  const norm = normalizeGhanaNumber(waNumberInput.value);
  if (!norm) {
    if (numberError) numberError.textContent = "Enter a valid WhatsApp number.";
    if (numberError) numberError.style.display = 'block';
    return;
  }
  if (numberError) numberError.style.display = 'none';
  userPhoneCache = norm.e164;
  await setDoc(doc(globalNums, norm.e164.replace(/[^\d+]/g, '')), { whatsapp: norm.e164, timestamp: serverTimestamp() }, { merge: true });
  const shopName = pendingContactFor?.shopName;
  if (shopName) {
    await ensureShopsContainer();
    await ensureShopDoc(shopName);
    const custCol = collection(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, shopName, "customers");
    await setDoc(doc(custCol, norm.e164.replace(/[^\d+]/g, '')), { whatsapp: norm.e164, timestamp: serverTimestamp() }, { merge: true });
  }
  const shopPhone = pendingContactFor?.phone || "";
  if (pendingAction === 'call') {
    if (shopPhone) window.location.href = `tel:${shopPhone}`;
  } else {
    const waNum = shopPhone.replace(/^\+/, '');
    const msg = `Hello, I saw your item *${pendingContactFor?.itemTitle || ''}* on PickMe (Tech & Gadgets).`;
    if (waNum) window.location.href = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
  }
  closeNumberModal();
});

function promptShopCode() {
  if (codeInput) codeInput.value = "";
  openModal(codeModal);
}

[codeClose, codeCancel].forEach(b => b && b.addEventListener('click', () => closeModal(codeModal)));

if (codeOk) codeOk.addEventListener('click', () => {
  const input = codeInput.value.trim();
  const expected = (currentShop?.accessCode) || SHOP_ADMIN_DEFAULT_CODE;
  if (input && input === expected) {
    closeModal(codeModal);
    openModal(adminOptionsModal);
  } else {
    alert("Incorrect code.");
  }
});

[adminOptClose, adminOptCancel].forEach(b => b && b.addEventListener('click', () => closeModal(adminOptionsModal)));

if (optAdd) optAdd.addEventListener('click', () => {
  closeModal(adminOptionsModal);
  if (catChooseGrid) {
    catChooseGrid.innerHTML = "";
    CATEGORIES.forEach(({ id }) => {
      const div = document.createElement('div');
      div.className = 'mopt-card';
      div.innerHTML = `<h4>${escapeHtml(id)}</h4>`;
      div.addEventListener('click', () => startAddFlow(id));
      catChooseGrid.appendChild(div);
    });
  }
  openModal(catChooseModal);
});

[catChooseClose, catChooseCancel].forEach(b => b && b.addEventListener('click', () => {
  closeModal(catChooseModal);
  openModal(adminOptionsModal);
}));

let currentAddCategory = null;
function startAddFlow(category) {
  currentAddCategory = category;
  closeModal(catChooseModal);
  openDraftEditor();
}

function openDraftEditor() {
  if (draftTitle) draftTitle.textContent = `Add items Â· ${currentAddCategory}`;
  resetForm();
  renderDraftList();
  openModal(draftModal);
}

if (draftClose) draftClose.addEventListener('click', () => {
  closeModal(draftModal);
  openModal(catChooseModal);
});

if (addImagesBtn) addImagesBtn.addEventListener('click', () => imgInput.click());

function refreshThumbs() {
  if (imgThumbs) {
    imgThumbs.innerHTML = "";
    filesBuffer.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      const t = document.createElement('div');
      t.className = 'thumb';
      t.innerHTML = `<img src="${url}" alt="img ${idx + 1}"><button class="trash" title="Remove" aria-label="Remove">&times;</button>`;
      t.querySelector('.trash').addEventListener('click', () => {
        filesBuffer.splice(idx, 1);
        refreshThumbs();
      });
      imgThumbs.appendChild(t);
    });
  }
}

function resetForm() {
  if (imgInput) imgInput.value = '';
  filesBuffer = [];
  refreshThumbs();
  if (nameInput) nameInput.value = '';
  if (priceInput) priceInput.value = '';
  if (descInput) descInput.value = '';
}

if (imgInput) imgInput.addEventListener('change', () => {
  const list = Array.from(imgInput.files || []);
  const wanted = Math.min(MAX_IMAGES - filesBuffer.length, list.length);
  filesBuffer.push(...list.slice(0, wanted));
  refreshThumbs();
});

if (clearFormBtn) clearFormBtn.addEventListener('click', resetForm);

function pushDraftFromForm() {
  const nm = nameInput.value.trim();
  const pr = money(priceInput.value);
  const ds = descInput.value.trim();
  if (!nm) { alert("Enter name"); return false; }
  if (!filesBuffer.length) { alert("Add at least 1 image"); return false; }
  const id = makeId();
  drafts.push({ id, cat: currentAddCategory, name: nm, price: pr, desc: ds, files: [...filesBuffer] });
  renderDraftList();
  resetForm();
  return true;
}

function renderDraftList() {
  if (draftList) {
    draftList.innerHTML = "";
    drafts.forEach((d, i) => {
      const wrap = document.createElement('div');
      wrap.className = 'mopt-card';
      wrap.style.borderStyle = 'dashed';
      wrap.innerHTML = `
        <h4 style="margin:0 0 6px">#${i + 1} Â· ${escapeHtml(d.cat)}</h4>
        <div class="row">
          <input class="input d-name" placeholder="Name" value="${escapeHtml(d.name)}" />
          <input class="input d-price" placeholder="Price" value="${escapeHtml(d.price)}" />
        </div>
        <textarea class="input d-desc" rows="2" placeholder="Description">${escapeHtml(d.desc || '')}</textarea>
        <div class="thumb-row d-thumbs"></div>
        <div class="row">
          <button class="btn-primary d-addimg" type="button">Add images</button>
          <button class="btn-secondary d-clearimg" type="button">Clear images</button>
          <button class="btn-secondary d-remove" type="button">Remove item</button>
        </div>
      `;
      const nameEl = wrap.querySelector('.d-name');
      const priceEl = wrap.querySelector('.d-price');
      const descEl = wrap.querySelector('.d-desc');
      const thumbs = wrap.querySelector('.d-thumbs');

      function drawThumbs() {
        thumbs.innerHTML = '';
        d.files.forEach((f, idx) => {
          const u = URL.createObjectURL(f);
          const t = document.createElement('div');
          t.className = 'thumb';
          t.innerHTML = `<img src="${u}" alt=""><button class="trash" title="Remove">&times;</button>`;
          t.querySelector('.trash').onclick = () => { d.files.splice(idx, 1); drawThumbs(); };
          thumbs.appendChild(t);
        });
      }
      drawThumbs();

      nameEl.oninput = e => d.name = e.target.value;
      priceEl.oninput = e => d.price = e.target.value.replace(/[^\d.]/g, '');
      descEl.oninput = e => d.desc = e.target.value;

      const hid = document.createElement('input');
      hid.type = 'file';
      hid.accept = 'image/*';
      hid.multiple = true;
      hid.style.display = 'none';
      wrap.appendChild(hid);
      wrap.querySelector('.d-addimg').onclick = () => hid.click();
      hid.onchange = () => {
        const list = Array.from(hid.files || []);
        const space = MAX_IMAGES - d.files.length;
        d.files.push(...list.slice(0, space));
        drawThumbs();
      };
      wrap.querySelector('.d-clearimg').onclick = () => { d.files = []; drawThumbs(); };
      wrap.querySelector('.d-remove').onclick = () => { drafts.splice(i, 1); renderDraftList(); };
      draftList.appendChild(wrap);
    });
  }
}

if (addMoreBtn) addMoreBtn.addEventListener('click', () => { pushDraftFromForm(); });

if (submitDraftsBtn) submitDraftsBtn.addEventListener('click', async () => {
  if (!drafts.length) {
    const nm = nameInput.value.trim();
    if (nm) {
      const ok = pushDraftFromForm();
      if (!ok) return;
    }
  }
  const valid = drafts.filter(d => d.name && d.files && d.files.length > 0);
  if (!valid.length) { alert("Nothing to submit."); return; }
  submitDraftsBtn.disabled = true;
  submitDraftsBtn.textContent = "Submittingâ€¦";
  toast("Submittingâ€¦");
  const payload = { type: "review", page: PAGE_KEY, shop: currentShopName, items: [] };
  for (const d of valid) {
    const adId = d.id;
    const uploads = d.files.slice(0, MAX_IMAGES).map((f, idx) => {
      const key = `${PAGE_KEY}/${currentShopName}/${adId}/img_${idx + 1}.jpg`;
      const rf = sRef(st, key);
      return uploadBytes(rf, f).then(snap => getDownloadURL(sRef(st, snap.metadata.fullPath)));
    });
    const urls = await Promise.all(uploads);
    payload.items.push({ id: adId, category: d.cat, name: d.name, price: money(d.price), desc: d.desc, images: urls });
  }
  const linkId = await putShort(payload);
  closeModal(draftModal);
  drafts = [];
  resetForm();
  draftList.innerHTML = "";
  submitDraftsBtn.disabled = false;
  submitDraftsBtn.textContent = "Submit";
  const link = `${location.origin}${location.pathname}?review=${linkId}`;
  const msg = `New Tech & Gadgets adverts from *${currentShopName}*.\nOpen: ${link}`;
  window.location.href = `https://wa.me/${PICKME_WHATSAPP}?text=${encodeURIComponent(msg)}`;
  setTimeout(() => openModal(catChooseModal), 500);
});

if (optDelete) optDelete.addEventListener('click', async () => {
  closeModal(adminOptionsModal);
  deleteList.innerHTML = "<p>Loading itemsâ€¦</p>";
  openModal(deleteModal);
  const items = await fetchShopItems(currentShopName);
  deleteList.innerHTML = "";
  if (!items.length) { deleteList.innerHTML = "<p>No items to delete.</p>"; return; }
  items.forEach(ad => {
    const blk = document.createElement('div');
    blk.className = 'mopt-card';
    blk.innerHTML = `
      <h4>${escapeHtml(ad.name || 'Item')}</h4>
      <p>${escapeHtml(ad.category || '')}</p>
      <button class="btn-secondary">Delete</button>
    `;
    blk.querySelector('button').addEventListener('click', () => deleteAd(ad));
    deleteList.appendChild(blk);
  });
});

[deleteClose, deleteCancel].forEach(b => b && b.addEventListener('click', () => {
  closeModal(deleteModal);
  openModal(adminOptionsModal);
}));

async function deleteAd(ad) {
  if (!confirm("Delete this item permanently?")) return;
  try {
    await deleteDoc(doc(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, currentShopName, "items", ad.id));
  } catch (e) {
    console.warn('delete doc', e);
  }
  try {
    const folder = sRef(st, `${PAGE_KEY}/${currentShopName}/${ad.id}/`);
    const listing = await listAll(folder);
    await Promise.all(listing.items.map(obj => deleteObject(obj)));
  } catch (e) {
    console.warn('delete images', e);
  }
  alert("Deleted.");
  closeModal(deleteModal);
  clearShopCaches(currentShopName);
  renderShops();
  if (currentShop) openShop(currentShop);
}

async function getShort(id) {
  const snap = await getDoc(doc(linksCol, id));
  return snap.exists() ? (snap.data()?.payload || null) : null;
}

async function putShort(payload) {
  const id = makeId();
  await setDoc(doc(linksCol, id), {
    payload,
    createdAt: serverTimestamp(),
    expiresInSec: 86400
  });
  return id;
}

function promptReviewCode() {
  openModal(reviewCodeModal);
}

[reviewCodeClose, reviewCodeCancel].forEach(b => b && b.addEventListener('click', () => {
  reviewPayloadPending = null;
  closeModal(reviewCodeModal);
  closeDrawer();
  categoriesView.classList.add('show');
  shopsView.classList.remove('show');
  if (allItemsView) allItemsView.classList.remove('show');
  document.body.classList.add('ready');
}));

if (reviewCodeOk) reviewCodeOk.addEventListener('click', () => {
  if (reviewCodeInput.value.trim() !== GLOBAL_ADMIN_CODE) { alert('Incorrect admin code.'); return; }
  closeModal(reviewCodeModal);
  if (reviewPayloadPending) openReview(reviewPayloadPending);
});

async function openReview(payload) {
  hide(shopBanner);
  show(itemDetail);
  hide(shopGallery);
  hide(catPage);
  buildSlider([], itemSlider, itemDots);
  if (detailTitle) detailTitle.textContent = "Review panel";
  if (detailPrice) detailPrice.textContent = "";
  if (detailPostedBy) detailPostedBy.textContent = payload.shop || "";
  if (detailDesc) detailDesc.textContent = "";
  const container = document.createElement('div');
  container.style.marginTop = '8px';
  const states = [];
  payload.items.forEach((it, idx) => {
    const card = document.createElement('div');
    card.className = 'mopt-card';
    const holder = document.createElement('div');
    holder.style.marginBottom = '8px';
    const slider = document.createElement('div');
    slider.className = 'slider';
    const dots = document.createElement('div');
    dots.className = 'dots';
    holder.append(slider, dots);
    card.appendChild(holder);
    buildSlider(it.images || [], slider, dots);
    const meta = document.createElement('div');
    meta.innerHTML = `
      <h4 style="margin:8px 0 4px">#${idx + 1} ${escapeHtml(it.name)}</h4>
      <div>${escapeHtml(it.category || '')}</div>
      <div>${fmtPrice(it.price)}</div>
    `;
    card.appendChild(meta);
    const st = { id: it.id, approve: true, reason: null, data: it };
    states.push(st);
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn-secondary';
    toggleBtn.textContent = 'Reject';
    toggleBtn.style.marginTop = '8px';
    const rejectBox = document.createElement('div');
    rejectBox.style.display = 'none';
    rejectBox.style.marginTop = '8px';
    rejectBox.innerHTML = `
      <div class="row">
        <select class="input reasonSel">
          <option value="">Select reason</option>
          <option>Inappropriate content</option>
          <option>Wrong price</option>
          <option>Poor image quality</option>
          <option>Duplicate listing</option>
          <option>Other</option>
        </select>
        <input class="input otherTxt" placeholder="Write custom reason (if Other)">
      </div>
    `;
    toggleBtn.onclick = () => {
      st.approve = !st.approve;
      if (st.approve) {
        toggleBtn.textContent = 'Reject';
        toggleBtn.className = 'btn-secondary';
        rejectBox.style.display = 'none';
        st.reason = null;
      } else {
        toggleBtn.textContent = 'Approve';
        toggleBtn.className = 'btn-primary';
        rejectBox.style.display = 'block';
      }
    };
    rejectBox.querySelector('.reasonSel').addEventListener('change', e => {
      const val = e.target.value;
      const otherTxt = rejectBox.querySelector('.otherTxt');
      if (val === 'Other') {
        otherTxt.style.display = 'block';
        st.reason = otherTxt.value.trim() || 'Rejected';
      } else {
        otherTxt.style.display = val ? 'none' : 'none';
        st.reason = val || 'Rejected';
      }
    });
    rejectBox.querySelector('.otherTxt').addEventListener('input', e => {
      if (!st.approve) {
        st.reason = e.target.value.trim() || 'Rejected';
      }
    });
    card.appendChild(toggleBtn);
    card.appendChild(rejectBox);
    container.appendChild(card);
  });
  const done = document.createElement('button');
  done.className = 'btn-primary';
  done.style.marginTop = '10px';
  done.textContent = 'Submit Review';
  done.onclick = async () => {
    const approved = states.filter(s => s.approve === true).map(s => s.data);
    const rejectedStates = states.filter(s => s.approve === false);
    if (!approved.length && !rejectedStates.length) {
      alert("Please approve or reject at least one item before submitting.");
      return;
    }
    done.disabled = true;
    done.textContent = "Submittingâ€¦";
    const cleanShopName = payload.shop.trim();
    try {
      await ensureShopsContainer();
      await ensureShopDoc(cleanShopName);
    } catch (e) {
      console.warn('[ensureShopDoc] failed', e);
    }
    let saveErrors = [];
    for (const it of approved) {
      try {
        const rec = {
          id: String(it.id || "").trim(),
          shop: cleanShopName,
          category: String(it.category || 'Other').trim(),
          name: String(it.name || 'Untitled').trim(),
          price: Number(it.price || 0),
          desc: String(it.desc || ''),
          images: Array.isArray(it.images) ? it.images.filter(Boolean) : [],
          createdAt: serverTimestamp()
        };
        if (!rec.id) throw new Error("missing id");
        const ref = doc(db, PAGE_KEY, "Shops", SHOPS_SUB_COL, cleanShopName, "items", rec.id);
        await setDoc(ref, rec, { merge: true });
      } catch (e) {
        console.error('Save approved failed for', it?.id, e);
        saveErrors.push(it?.id || '(unknown)');
      }
    }
    const rejected = [];
    for (const stRec of rejectedStates) {
      const it = stRec.data;
      let previewDataUrl = null;
      const firstImg = (Array.isArray(it.images) && it.images.length) ? it.images[0] : null;
      if (firstImg) {
        previewDataUrl = await urlToSmallPreviewDataURL(firstImg);
      }
      try {
        const folder = sRef(st, `${PAGE_KEY}/${payload.shop}/${it.id}/`);
        const listing = await listAll(folder);
        await Promise.all(listing.items.map(obj => deleteObject(obj)));
      } catch (e) {
        console.warn('Delete rejected failed for', it?.id, e);
      }
      rejected.push({
        ...it,
        reason: stRec.reason || 'Rejected',
        previewDataUrl: previewDataUrl || null
      });
    }
    const result = {
      type: 'result',
      page: PAGE_KEY,
      shop: payload.shop,
      approved,
      rejected,
      createdAt: serverTimestamp(),
      expiresInSec: 86400
    };
    const resultId = await putShort(result);
    clearShopCaches(payload.shop);
    await Promise.all([
      renderShops(),
      renderCategories(),
      fetchAllItems().then(items => {
        if (allItemsView.classList.contains('show')) {
          renderAllItemsGrid(items);
        }
      })
    ]);
    const shopPhone = (SHOPS.find(s => s.name === payload.shop)?.phone) || "";
    const link = `${location.origin}${location.pathname}?result=${resultId}`;
    const msg = `Your Tech & Gadgets adverts were reviewed.\nOpen results: ${link}`;
    if (shopPhone) {
      window.location.href = `https://wa.me/${shopPhone.replace(/^\+/, '')}?text=${encodeURIComponent(msg)}`;
    } else {
      alert("Result link:\n" + link);
    }
    if (saveErrors.length) {
      alert("Some approved items failed to save: " + saveErrors.join(', '));
    }
    const firstApproved = approved[0] || null;
    closeDrawer();
    toast("Review submitted.");
    if (firstApproved) {
      const shopObj = SHOPS.find(s => s.name === payload.shop);
      if (shopObj) {
        jumpToAdId = firstApproved.id;
        currentCategory = firstApproved.category;
        openShop(shopObj);
      }
    }
    done.disabled = false;
    done.textContent = "Submit Review";
  };
  container.appendChild(done);
  if (itemDetail) itemDetail.appendChild(container);
  openDrawer();
}

async function renderCategories() {
  const counts = await countByCategory();
  renderCategoriesGrid(counts);
}

async function renderShops() {
  const counts = await fetchShopCounts();
  renderShopsGrid(counts);
}

async function router() {
  // Clear cache to ensure fresh data
  localStorage.clear();
  console.log('Cache cleared');
  const params = new URLSearchParams(location.search);
  const reviewId = params.get('review');
  const resultId = params.get('result');
  if (reviewId) {
    const payload = await getShort(reviewId);
    if (payload && payload.type === 'review') {
      reviewPayloadPending = payload;
      promptReviewCode();
      return;
    }
  }
  if (resultId) {
    const payload = await getShort(resultId);
    if (payload && payload.type === 'result') {
      const approved = payload.approved || [];
      const rejected = payload.rejected || [];
      const msg = [];
      if (approved.length) {
        msg.push(`Approved items (${approved.length}):`);
        approved.forEach((it, i) => msg.push(`${i + 1}. ${it.name} (${it.category})`));
      }
      if (rejected.length) {
        msg.push(`\nRejected items (${rejected.length}):`);
        rejected.forEach((it, i) => msg.push(`${i + 1}. ${it.name} (${it.reason})`));
      }
      if (msg.length) {
        alert(msg.join('\n'));
      }
      history.replaceState(state, '', location.pathname);
    }
  }
  document.body.classList.add('ready');
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    // Render from cache immediately
    const cachedCats = loadCache(CACHE.cats) || {};
    renderCategoriesGrid(cachedCats);
    const cachedShops = loadCache(CACHE.shops) || SHOPS.reduce((acc, s) => ({ ...acc, [s.name]: 0 }), {});
    renderShopsGrid(cachedShops);
    const cachedItems = loadCache(CACHE.allItems) || [];
    renderAllItemsGrid(cachedItems);
    // Update in background
    await Promise.all([
      countByCategory().then(counts => {
        if (JSON.stringify(counts) !== JSON.stringify(cachedCats)) {
          renderCategoriesGrid(counts);
        }
      }),
      fetchShopCounts().then(counts => {
        if (JSON.stringify(counts) !== JSON.stringify(cachedShops)) {
          renderShopsGrid(counts);
        }
      }),
      fetchAllItems().then(items => {
        if (JSON.stringify(items) !== JSON.stringify(cachedItems)) {
          if (allItemsView && allItemsView.classList.contains('show')) {
            renderAllItemsGrid(items);
          }
        }
      })
    ]);
    await router();
  } catch (e) {
    console.error('init failed', e);
    document.body.classList.remove('hide-initial');
    document.body.classList.add('ready');
  }
});

</script>

<!-- ===================== FOOTER ===================== -->
<div class="footer-wrap" role="contentinfo" aria-label="Footer">
  <iframe src="footer.html" style="width:100%;height:60px;border:none;overflow:hidden" scrolling="no" title="Footer"></iframe>
</div>

</body>
</html>

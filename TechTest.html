<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tech & Gadgets - PickMe Services</title>

<!-- ===================== HEADER (Injected) ===================== -->
<script>
/* Robust header loader — runs after DOM is ready so #header-placeholder exists */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load header');
    let html = await res.text();
    const pageTitle = "Tech & Gadgets";
    html = html.replace(
      /<h1[^>]*>.*?<\/h1>/i,
      `<h1 style="margin:0;font-weight:800;color:#c12872;font-size:24px;position:absolute;left:50%;transform:translateX(-50%)">${pageTitle}</h1>`
    );
    const host = document.getElementById('header-placeholder');
    if (host) {
      host.innerHTML = html;

      // Re-run any scripts within the injected header
      host.querySelectorAll('script').forEach(s0 => {
        const s1 = document.createElement('script');
        if (s0.src) s1.src = s0.src;
        else s1.textContent = s0.textContent;
        document.body.appendChild(s1);
      });
      host.removeAttribute('aria-hidden');
    }
  } catch (e) {
    console.error('[header]', e);
  }
});
</script>

<!-- ===================== STYLES ===================== -->
<style>
:root{
  --theme:#c12872;
  --ink:#222;
  --muted:#666;
  --bg:#f9f9f9;
  --card:#fff;
}

/* base */
*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:focus,:focus-visible,button:focus,input:focus,textarea:focus{ outline:none!important; box-shadow:none!important; }
html,body{ height:100%; }
body{
  margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background:var(--bg); color:var(--ink); padding-top:100px; overflow-x:hidden;
}

/* header + search */
.page-header{ text-align:center; margin:0 16px 8px; }
.page-header p{ margin:6px 0 0; color:#000; font-weight:700; font-size:15px; }
.search-bar{ display:flex; justify-content:center; margin:10px 16px 6px; }
.search-bar input{
  width:100%; max-width:640px; padding:12px 14px; border:1px solid #ddd; border-radius:12px; background:#fff; font-size:16px;
}
.search-bar input::placeholder{ color:#999; }

/* top tabs */
.main-tabs{ display:flex; gap:8px; overflow:auto hidden; padding:8px 16px; border-bottom:2px solid #eee; }
.main-tab{ padding:10px 14px; border:1px solid #eee; border-radius:999px; background:#fff; cursor:pointer; user-select:none; font-weight:800; font-size:14px; white-space:nowrap; }
.main-tab.active{ color:#fff; background:var(--theme); border-color:var(--theme); }

/* containers */
.view{ display:none; }
.view.show{ display:block; }
.container{ padding:16px 16px 120px; }

/* categories list */
.categories-grid{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px;
}
.cat-card{
  display:flex; align-items:center; gap:12px; background:#fff; border:1px solid #eee; border-radius:12px; padding:10px 12px;
  box-shadow:0 2px 6px rgba(0,0,0,.06); cursor:pointer;
}
.cat-thumb{ width:42px; height:42px; border-radius:10px; background:#f2f2f2; overflow:hidden; display:grid; place-items:center; flex-shrink:0; }
.cat-thumb img{ width:100%; height:100%; object-fit:cover; }
.cat-info{ flex:1; min-width:0; }
.cat-title{ font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.cat-sub{ font-size:12px; color:#555; }
.cat-arrow{ font-size:18px; color:#999; margin-left:4px; }

/* items grid */
.items-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:12px; }
.item-card{ background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.08); border:1px solid #eee; display:flex; flex-direction:column; min-height:240px; }
.item-img{ position:relative; width:100%; padding-top:66%; background:#f2f2f2; overflow:hidden; }
.item-img img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
.item-body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
.item-price{ font-weight:900; color:#111; }
.item-desc{ font-size:12px; color:#444; line-height:1.3; max-height:32px; overflow:hidden; }
.item-shop{ font-size:11px; color:#777; }

/* shops grid (hero cards) */
.cards-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:18px; padding-top:6px; }
.shop-card{
  position:relative; height:250px; border-radius:15px; overflow:hidden; background:#ddd center/cover no-repeat;
  box-shadow:0 3px 10px rgba(0,0,0,.08); display:flex; align-items:flex-end; transition:transform .18s ease;
}
.shop-card:hover{ transform:translateY(-4px); }
.shop-card::before{ content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,.75) 100%); }
.shop-card .content{ position:relative; z-index:1; color:#fff; width:100%; padding:15px; display:flex; flex-direction:column; justify-content:space-between; }
.shop-title{ font-weight:900; font-size:20px; margin:0 0 4px; }
.shop-slogan{ font-size:13px; opacity:.95; margin:0 0 4px; }
.shop-lower{ display:flex; align-items:center; justify-content:space-between; }
.shop-meta{ font-size:12px; opacity:.92; }
.btn-enter{ background:var(--theme); color:#fff; border:0; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer; }

/* drawer */
#drawer{
  position:fixed; top:0; right:-100%; width:100%; max-width:1100px; height:100%;
  background:#fff; z-index:9999; overflow-y:auto; transition:right .42s ease; box-shadow:-5px 0 16px rgba(0,0,0,.18);
  padding-bottom:140px;
}
#drawer.show{ right:0; }
#drawerClose{
  position:fixed; top:16px; right:-60px; width:42px; height:42px; border-radius:50%;
  background:#111; color:#fff; border:0; font-size:24px; display:grid; place-items:center; z-index:10000; transition:right .42s ease;
}
#drawer.show #drawerClose{ right:16px; }
.banner{
  position:relative; height:35vh; display:grid; place-items:center; text-align:center; color:#fff;
  background:#333 center/cover no-repeat;
}
.banner::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.7), rgba(0,0,0,.82)); }
.banner-text{ position:relative; z-index:1; padding:0 16px; }
.banner-text h2{ margin:0 0 6px; font-size:15px; font-weight:700; }
.banner-text h1{ margin:0 0 6px; font-size:26px; }
.banner-text p{ margin:0; font-size:13px; opacity:.95; }
.drawer-content{ max-width:1100px; margin:0 auto; padding:18px; }
.section-title{ font-weight:900; margin:6px 0 12px; }

/* slider */
.slider{ position:relative; height:260px; overflow:hidden; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); background:#f2f2f2; }
.slide{ position:absolute; top:0; left:100%; width:100%; height:100%; object-fit:cover; opacity:0; transition:left .45s ease, opacity .45s ease; }
.slide.active{ left:0; opacity:1; }
.slider .nav{ position:absolute; top:50%; transform:translateY(-50%); font-size:24px; color:#fff; background:rgba(0,0,0,.38); padding:6px 10px; border-radius:50%; cursor:pointer; user-select:none; }
.slider .nav.left{ left:10px; }
.slider .nav.right{ right:10px; }
.dots{ display:flex; justify-content:center; gap:6px; margin-top:10px; }
.dot{ width:8px; height:8px; border-radius:50%; background:#ddd; }
.dot.active{ background:var(--theme); }

/* item detail */
.item-detail{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.detail-title{ font-weight:900; font-size:18px; }
.detail-price{ font-weight:900; color:#111; font-size:16px; }
.detail-meta{ font-size:12px; color:#666; }
.detail-desc{ font-size:14px; white-space:pre-wrap; color:#333; }
.actions-row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
.btn-primary{ background:var(--theme); color:#fff; border:0; border-radius:10px; padding:12px 18px; cursor:pointer; font-size:15px; font-weight:800; }
.btn-secondary{ background:#3a3a3a; color:#fff; border:0; border-radius:10px; padding:12px 18px; cursor:pointer; font-size:15px; }

/* inside-drawer top actions */
.shop-top-actions{ position:fixed; top:12px; left:12px; z-index:10002; display:none; gap:8px; }
.action-round{ background:#000; color:#fff; border:0; border-radius:50%; width:40px; height:40px; display:grid; place-items:center; cursor:pointer; font-size:22px; }

/* modal base */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:10001; }
.modal.show{ display:flex; }
.modal-card{ width:95%; max-width:700px; max-height:90vh; background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); overflow:hidden; display:flex; flex-direction:column; }
.modal-header,.modal-footer{ padding:14px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:8px; }
.modal-footer{ border-top:1px solid #eee; border-bottom:none; justify-content:flex-end; }
.modal-body{ padding:16px; overflow:auto; }

/* admin option cards */
.mopt-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; }
.mopt-card{ border:1px solid #eee; border-radius:12px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:6px; cursor:pointer; }
.mopt-card h4{ margin:0; font-size:14px; }
.mopt-card p{ margin:0; font-size:12px; color:#555; }
.close-x{ background:#000; color:#fff; border:none; border-radius:50%; width:32px; height:32px; display:grid; place-items:center; cursor:pointer; }

/* inputs */
.input{ width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
.input:focus{ border-color:var(--theme); box-shadow:0 0 0 3px rgba(193,40,114,.08); }
.lbl{ font-size:12px; color:#555; margin:6px 0 4px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; }

/* thumbs */
.thumb-row{ display:flex; gap:8px; overflow-x:auto; }
.thumb{ position:relative; width:90px; height:90px; border-radius:10px; background:#f2f2f2; overflow:hidden; flex-shrink:0; }
.thumb img{ width:100%; height:100%; object-fit:cover; }
.thumb .trash{ position:absolute; top:4px; right:4px; width:22px; height:22px; border:0; border-radius:50%; background:rgba(0,0,0,.55); color:#fff; cursor:pointer; display:grid; place-items:center; }

/* simple toast/progress */
.toast{ position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:opacity .2s; z-index:10050; }
.toast.show{ opacity:1; }

/* footer */
.footer-wrap{ position:fixed; bottom:0; left:0; right:0; z-index:9999; }
</style>
</head>

<body>
<!-- HEADER HOST (must be in <body>, not <head>) -->
<div id="header-placeholder" aria-hidden="true"></div>

<!-- FOUC control -->
<style>
  body.hide-initial *{ visibility:hidden!important; }
  body.ready *{ visibility:visible!important; }
</style>
<script> document.documentElement.style.background="#fff"; document.body.classList.add("hide-initial"); </script>

<!-- ===================== PAGE HEADER + SEARCH ===================== -->
<header class="page-header">
  <h1 class="sr-only" style="position:absolute;left:-9999px">Tech &amp; Gadgets</h1>
  <p>Find tech & gadget shops around you, browse categories, and contact sellers directly</p>
</header>

<div class="search-bar">
  <input id="globalSearch" type="search" placeholder="Search items, shops, models, keywords…" aria-label="Search">
</div>

<!-- ===================== TOP TABS ===================== -->
<nav class="main-tabs" aria-label="Main sections">
  <button class="main-tab active" data-view="categoriesView" aria-pressed="true">Categories</button>
  <button class="main-tab" data-view="shopsView" aria-pressed="false">Shops</button>
</nav>

<!-- ===================== CATEGORIES VIEW ===================== -->
<section id="categoriesView" class="view show" aria-label="Categories">
  <div class="container">
    <div id="categoriesGrid" class="categories-grid" aria-live="polite"></div>

    <!-- Legacy inline block kept but unused; we now show categories inside drawer -->
    <div id="categoryItemsWrap" style="display:none;margin-top:14px;">
      <div id="categoryItemsTitle" class="section-title"></div>
      <div class="search-bar" style="margin:6px 0 12px;">
        <input id="categorySearch" class="input" type="search" placeholder="Search within this category…" aria-label="Category search">
      </div>
      <div id="categoryItemsGrid" class="items-grid" aria-live="polite"></div>
    </div>
  </div>
</section>

<!-- ===================== SHOPS VIEW ===================== -->
<section id="shopsView" class="view" aria-label="Shops">
  <div class="container">
    <div id="shopsGrid" class="cards-grid" aria-live="polite"></div>
  </div>
</section>

<!-- ===================== DRAWER (ITEM / CATEGORY / SHOP) ===================== -->
<aside id="drawer" aria-hidden="true" aria-label="Details drawer">
  <button id="catBackBtn" aria-label="Back"
  style="position:fixed;top:12px;left:12px;padding:8px 16px;border:none;border-radius:6px;background:#000;color:#fff;font-weight:700;font-size:14px;display:none;z-index:10002;">
  BACK
</button>
  <button id="drawerClose" aria-label="Close details">&times;</button>

  <!-- shop header -->
  <section id="shopBanner" class="banner" style="display:none;">
    <div class="banner-text">
      <h2>Welcome to</h2>
      <h1 id="shopName"></h1>
      <p id="shopSlogan"></p>
    </div>
  </section>

  <!-- inside-drawer actions (restore hamburger left + close at right) -->
  <div id="shopTopActions" class="shop-top-actions">
    <button id="hamburgerBtn" class="action-round" aria-label="Admin">&#9776;</button>
  </div>

  <div class="drawer-content">
    <!-- Item detail -->
    <div id="itemDetail" style="display:none;">
      <div id="itemSlider" class="slider"></div>
      <div id="itemDots" class="dots"></div>
      <div class="item-detail">
        <div id="detailTitle" class="detail-title"></div>
        <div id="detailPrice" class="detail-price"></div>
        <div id="detailPostedBy" class="detail-meta"></div>
        <div id="detailDesc" class="detail-desc"></div>
        <div class="actions-row">
          <button id="callBtn" class="btn-primary">Call</button>
          <button id="waBtn" class="btn-secondary">WhatsApp</button>
          <button id="viewShopBtn" class="btn-primary">View Shop</button>
        </div>
      </div>
    </div>

    <!-- Shop gallery -->
    <div id="shopGallery" style="display:none;">
      <div class="section-title">Items</div>
      <div id="shopTabs" class="main-tabs" style="margin:0 0 10px;"></div>
      <div id="shopItemsGrid" class="items-grid"></div>
    </div>

    <!-- Category page within drawer -->
    <div id="catPage" style="display:none;">
      <div class="section-title" id="catPageTitle"></div>
      <div class="search-bar" style="margin:6px 0 12px;">
        <input id="catPageSearch" class="input" type="search" placeholder="Search within this category…" aria-label="Category search">
      </div>
      <div id="catPageGrid" class="items-grid" aria-live="polite"></div>
    </div>
  </div>
</aside>

<!-- ===================== MODALS ===================== -->
<!-- per-shop access code -->
<div id="codeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="codeTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="codeTitle">Enter Access Code</span>
      <button id="codeClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="codeInput" class="input" placeholder="Access code" aria-label="Access code">
    </div>
    <div class="modal-footer">
      <button id="codeCancel" class="btn-secondary">Back</button>
      <button id="codeOk" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<!-- admin options -->
<div id="adminOptionsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="adminTitle">Admin</span>
      <button id="adminOptClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="mopt-grid">
        <div id="optAdd" class="mopt-card"><h4>Add item</h4></div>
        <div id="optDelete" class="mopt-card"><h4>Delete item</h4></div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="adminOptCancel" class="btn-secondary">Close</button>
    </div>
  </div>
</div>

<!-- choose category -->
<div id="catChooseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="catChooseTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="catChooseTitle">Choose Category</span>
      <button id="catChooseClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="catChooseGrid" class="mopt-grid"></div>
    </div>
    <div class="modal-footer">
      <button id="catChooseCancel" class="btn-secondary">Back</button>
    </div>
  </div>
</div>

<!-- draft editor -->
<div id="draftModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="draftTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="draftTitle">Add items</span>
      <button id="draftClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="draftHint" class="lbl" style="font-weight:700">Upload up to 5 images</div>

      <!-- Hidden real input; we show only an "Add Images" button -->
      <input id="imgInput" type="file" accept="image/*" multiple class="input" aria-label="Upload images" style="display:none">
      <div class="row" style="margin-bottom:6px">
        <button id="addImagesBtn" class="btn-primary" type="button">Add images</button>
      </div>
      <div id="imgThumbs" class="thumb-row"></div>

      <div class="lbl">Name</div>
      <input id="nameInput" class="input" placeholder="e.g., iPhone 13 Pro Max 128GB">
      <div class="lbl">Price (GH₵)</div>
      <input id="priceInput" class="input" type="number" min="0" step="1" placeholder="e.g., 4500">
      <div class="lbl">Description / Specs</div>
      <textarea id="descInput" class="input" rows="4" placeholder="Key specs, condition, warranty…"></textarea>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
      <!-- All drafts stay visible & editable here -->
      <div id="draftList"></div>
    </div>
    <div class="modal-footer">
      <button id="clearFormBtn" class="btn-secondary">Clear form</button>
      <button id="addMoreBtn" class="btn-secondary">Add more</button>
      <button id="submitDraftsBtn" class="btn-primary">Submit</button>
    </div>
  </div>
</div>

<!-- delete picker -->
<div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="deleteTitle">Delete item</span>
      <button id="deleteClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="deleteList"></div>
    </div>
    <div class="modal-footer">
      <button id="deleteCancel" class="btn-secondary">Back</button>
    </div>
  </div>
</div>

<!-- number capture -->
<div id="numberModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="numberTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="numberTitle">Your WhatsApp number</span>
      <button id="numberClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="waNumberInput" class="input" placeholder="+233… or 0…" inputmode="tel" aria-label="WhatsApp number">
      <div id="numberError" style="display:none;color:#b00020;font-size:13px;margin-top:6px"></div>
    </div>
    <div class="modal-footer">
      <button id="numberCancel" class="btn-secondary">Back</button>
      <button id="numberOk" class="btn-primary">Continue</button>
    </div>
  </div>
</div>

<!-- review admin -->
<div id="reviewCodeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
  <div class="modal-card">
    <div class="modal-header">
      <span id="reviewTitle">PickMe Admin Access</span>
      <button id="reviewCodeClose" class="close-x" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <input id="reviewCodeInput" class="input" placeholder="Enter admin code" aria-label="Admin code">
    </div>
    <div class="modal-footer">
      <button id="reviewCodeCancel" class="btn-secondary">Back</button>
      <button id="reviewCodeOk" class="btn-primary">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ===================== LOGIC (Firebase + App) ===================== -->
<script type="module">
/* Firebase (v10) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL, listAll, deleteObject
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB2L649fIs0CS-fGDC0ybFeAO5Im5BEP_c",
  authDomain: "pickmeservicesonline.firebaseapp.com",
  projectId: "pickmeservicesonline",
  storageBucket: "pickmeservicesonline.firebasestorage.app",
  messagingSenderId: "265031616239",
  appId: "1:265031616239:web:e2ef418704af5595aa7d1a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const st  = getStorage(app);

/* ===== Constants ===== */
const PAGE_KEY = "Tek&gaget";
const PICKME_WHATSAPP = "233534742142";
const GLOBAL_ADMIN_CODE = "999888";
const SHOP_ADMIN_DEFAULT_CODE = "123456";
const MAX_IMAGES = 5;

/* ===== Shops (hardcoded) ===== */
const SHOPS = [
  {
    name: "Trick Eye Store",
    slogan: "Phones, laptops & accessories",
    heroImage: "https://via.placeholder.com/1200x700?text=Trick+Eye+Store",
    phone: "233530477395",
    accessCode: "123456",
    expiry: "2026-12-31"
  },
  {
    name: "DigiHub",
    slogan: "All things electronics",
    heroImage: "https://via.placeholder.com/1200x700?text=DigiHub",
    phone: "233540576548",
    accessCode: "123456",
    expiry: "2026-10-31"
  }
];

/* ===== Categories (global) ===== */
const CATEGORIES = [
  { id:"Phones", img:"https://via.placeholder.com/200?text=Phones" },
  { id:"Computers & Laptops", img:"https://via.placeholder.com/200?text=Laptops" },
  { id:"Printers & Scanners", img:"https://via.placeholder.com/200?text=Printers" },
  { id:"Accessories", img:"https://via.placeholder.com/200?text=Accessories" },
  { id:"Security & Surveillance", img:"https://via.placeholder.com/200?text=Security" },
  { id:"Networking", img:"https://via.placeholder.com/200?text=Networking" },
  { id:"Gaming", img:"https://via.placeholder.com/200?text=Gaming" },
  { id:"Software", img:"https://via.placeholder.com/200?text=Software" },
  { id:"Cameras & Photo", img:"https://via.placeholder.com/200?text=Cameras" }
];

/* ===== Firestore paths =====
 Tek&gaget
   - Links/items/{id} -> { payload, createdAt }
   - Shops/{shopName}/items/{adId} -> ad doc
   - Shops/{shopName}/customers/{phoneE164}
   - Numbers/items/{phoneE164}
*/
const linksCol   = collection(db, PAGE_KEY, "Links", "items");
const globalNums = collection(db, PAGE_KEY, "Numbers", "items");

/* ===== DOM ===== */
const tabs = document.querySelectorAll('.main-tab');
const categoriesView = document.getElementById('categoriesView');
const shopsView = document.getElementById('shopsView');
const categoriesGrid = document.getElementById('categoriesGrid');

const shopsGrid = document.getElementById('shopsGrid');
const globalSearch = document.getElementById('globalSearch');

/* drawer */
const drawer = document.getElementById('drawer');
const drawerClose = document.getElementById('drawerClose');
const shopBanner = document.getElementById('shopBanner');
const shopTopActions = document.getElementById('shopTopActions');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const shopNameEl = document.getElementById('shopName');
const shopSloganEl = document.getElementById('shopSlogan');
const shopGallery = document.getElementById('shopGallery');
const shopTabs = document.getElementById('shopTabs');
const shopItemsGrid = document.getElementById('shopItemsGrid');

/* category page in drawer */
const catPage = document.getElementById('catPage');
const catPageTitle = document.getElementById('catPageTitle');
const catPageSearch = document.getElementById('catPageSearch');
const catPageGrid = document.getElementById('catPageGrid');

/* item detail */
const itemDetail = document.getElementById('itemDetail');
const itemSlider = document.getElementById('itemSlider');
const itemDots   = document.getElementById('itemDots');
const detailTitle= document.getElementById('detailTitle');
const detailPrice= document.getElementById('detailPrice');
const detailDesc = document.getElementById('detailDesc');
const detailPostedBy = document.getElementById('detailPostedBy');
const callBtn = document.getElementById('callBtn');
const waBtn   = document.getElementById('waBtn');
const viewShopBtn = document.getElementById('viewShopBtn');

/* modals */
const codeModal = document.getElementById('codeModal');
const codeInput = document.getElementById('codeInput');
const codeOk = document.getElementById('codeOk');
const codeCancel = document.getElementById('codeCancel');
const codeClose = document.getElementById('codeClose');

const adminOptionsModal = document.getElementById('adminOptionsModal');
const optAdd = document.getElementById('optAdd');
const optDelete = document.getElementById('optDelete');
const adminOptClose = document.getElementById('adminOptClose');
const adminOptCancel = document.getElementById('adminOptCancel');

const catChooseModal = document.getElementById('catChooseModal');
const catChooseGrid = document.getElementById('catChooseGrid');
const catChooseClose = document.getElementById('catChooseClose');
const catChooseCancel = document.getElementById('catChooseCancel');

const draftModal = document.getElementById('draftModal');
const draftClose = document.getElementById('draftClose');
const draftTitle = document.getElementById('draftTitle');
const imgInput = document.getElementById('imgInput');
const imgThumbs = document.getElementById('imgThumbs');
const addImagesBtn = document.getElementById('addImagesBtn');
const nameInput = document.getElementById('nameInput');
const priceInput = document.getElementById('priceInput');
const descInput = document.getElementById('descInput');
const addMoreBtn = document.getElementById('addMoreBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const submitDraftsBtn = document.getElementById('submitDraftsBtn');
const draftList = document.getElementById('draftList');

const deleteModal = document.getElementById('deleteModal');
const deleteClose = document.getElementById('deleteClose');
const deleteCancel = document.getElementById('deleteCancel');
const deleteList = document.getElementById('deleteList');

const numberModal = document.getElementById('numberModal');
const waNumberInput = document.getElementById('waNumberInput');
const numberOk = document.getElementById('numberOk');
const numberCancel = document.getElementById('numberCancel');
const numberClose = document.getElementById('numberClose');
const numberError = document.getElementById('numberError');

const reviewCodeModal = document.getElementById('reviewCodeModal');
const reviewCodeInput = document.getElementById('reviewCodeInput');
const reviewCodeOk = document.getElementById('reviewCodeOk');
const reviewCodeClose = document.getElementById('reviewCodeClose');
const reviewCodeCancel = document.getElementById('reviewCodeCancel');

const toastEl = document.getElementById('toast');

/* ===== State ===== */
let currentShop = null;
let currentShopName = null;
let jumpToAdId = null;
let currentCategory = null;
let pendingAction = null;
let pendingContactFor = null;
let drafts = [];      // {id, cat, name, price, desc, files[]}
let filesBuffer = []; // File[] (current add form)
let userPhoneCache = null;
let reviewPayloadPending = null;

/* ===== Helpers ===== */
const show = el => el.style.display = '';
const hide = el => el.style.display = 'none';
const escapeHtml = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
const money = n => Number(n||0);
const fmtPrice = n => `GH₵ ${Number(n||0).toFixed(2).replace(/\.00$/,'')}`;
const isExpired = iso => iso ? (new Date() > new Date(iso+"T23:59:59")) : false;
const makeId = () => (Date.now().toString(36)+Math.random().toString(36).slice(2,8)).toLowerCase();

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> toastEl.classList.remove('show'), 1600);
}

/* Ghana phone normalize */
function normalizeGhanaNumber(input){
  let s = String(input||'').trim().replace(/[\s\-]/g,'');
  if (s.startsWith('+233')) return { e164:s, wa:s.slice(1) };
  if (s.startsWith('233'))  return { e164:'+'+s, wa:s };
  if (/^0\d{9}$/.test(s))   return { e164:'+233'+s.slice(1), wa:'233'+s.slice(1) };
  if (/^\d{9}$/.test(s))    return { e164:'+233'+s, wa:'233'+s };
  const d = s.replace(/\D/g,'');
  if (d.startsWith('233')) return { e164:'+'+d, wa:d };
  if (d.length===10 && d.startsWith('0')) return { e164:'+233'+d.slice(1), wa:'233'+d.slice(1) };
  return null;
}

/* ===== Cache keys ===== */
const CACHE = {
  cats: "tk_cats_counts",
  shops: "tk_shops_counts",
  shopItems: shop => `tk_shop_${shop}_items`,
  catItems: cat => `tk_cat_${cat}_items`
};
const saveCache = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
const loadCache = (k)=>{ try{ return JSON.parse(localStorage.getItem(k)); }catch{ return null; } };
const clearShopCaches = (shop)=>{ localStorage.removeItem(CACHE.shopItems(shop)); localStorage.removeItem(CACHE.cats); localStorage.removeItem(CACHE.shops); };

/* ===== Categories & Items ===== */
async function countByCategory(){
  const cached = loadCache(CACHE.cats);
  if (cached) return cached;

  const out = {};
  await Promise.all(SHOPS.map(async sh=>{
    if (isExpired(sh.expiry)) return;
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d=>{
      const it = d.data(); const cat = it.category||"Other";
      out[cat] = (out[cat]||0)+1;
    });
  }));
  saveCache(CACHE.cats, out);
  return out;
}
function renderCategoriesGrid(counts){
  categoriesGrid.innerHTML = "";
  CATEGORIES.forEach(c=>{
    const card = document.createElement('article');
    card.className = "cat-card";
    card.innerHTML = `
      <div class="cat-thumb">${c.img?`<img src="${c.img}" alt="${escapeHtml(c.id)}">`:''}</div>
      <div class="cat-info">
        <div class="cat-title">${escapeHtml(c.id)}</div>
        <div class="cat-sub">${counts[c.id]||0} adverts</div>
      </div>
      <div class="cat-arrow">&gt;</div>
    `;
    card.addEventListener('click', ()=> openCategory(c.id));
    categoriesGrid.appendChild(card);
  });
}
async function fetchAllItemsInCategory(cat){
  const cached = loadCache(CACHE.catItems(cat));
  if (cached) return cached;

  const items = [];
  await Promise.all(SHOPS.map(async sh=>{
    if (isExpired(sh.expiry)) return;
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    snap.forEach(d=>{ const it = d.data(); it.id = d.id; if ((it.category||'')===cat) items.push(it); });
  }));
  items.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  saveCache(CACHE.catItems(cat), items);
  return items;
}
function renderItemCard(container, ad){
  const card = document.createElement('div');
  card.className = "item-card";
  const firstImg = (ad.images && ad.images[0]) || "https://via.placeholder.com/600x400?text=Image";
  card.innerHTML = `
    <div class="item-img"><img src="${firstImg}" alt="${escapeHtml(ad.name||'Item')}"></div>
    <div class="item-body">
      <div class="item-price">${fmtPrice(ad.price)}</div>
      <div class="item-desc">${escapeHtml(ad.desc||'')}</div>
      <div class="item-shop">Posted by ${escapeHtml(ad.shop||'')}</div>
    </div>
  `;
  card.addEventListener('click', ()=> openItemDetail(ad));
  container.appendChild(card);
}

/* ===== Category page opens inside drawer ===== */
async function openCategory(cat){
  currentCategory = cat;

  hide(shopBanner);
  hide(shopGallery);
  hide(itemDetail);
  show(catPage);

  // Set title and search placeholder
  catPageTitle.textContent = cat;
  catPageTitle.style.fontSize = "20px";
  catPageTitle.style.fontWeight = "800";
  catPageTitle.style.textAlign = "center";
  catPageSearch.placeholder = `Search in ${cat}…`;

  // Clear previous items
  catPageGrid.innerHTML = '';

  // Open drawer
  openDrawer();

  // ✅ Show back button only in category mode
  catBackBtn.style.display = "block";

  // ✅ Hide hamburger & close icon only for category view
  hamburgerBtn.style.display = "none";
  drawerClose.style.display = "none";

  // Load items for the selected category
  const items = await fetchAllItemsInCategory(cat);

  // Render items
  const draw = (list) => {
    catPageGrid.innerHTML = "";
    list.forEach(ad => renderItemCard(catPageGrid, ad));
    if (!list.length) {
      catPageGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">Oops! No items here today.</p>`;
    }
  };

  draw(items);

  // Search filtering
  catPageSearch.value = '';
  catPageSearch.oninput = () => {
    const q = (catPageSearch.value || '').toLowerCase();
    const list = items.filter(ad =>
      (ad.name || '').toLowerCase().includes(q) ||
      (ad.desc || '').toLowerCase().includes(q) ||
      (ad.shop || '').toLowerCase().includes(q)
    );
    draw(list);
  };
}

/* ===== Shops ===== */
async function fetchShopCounts(){
  const cached = loadCache(CACHE.shops);
  if (cached) return cached;
  const map = {};
  await Promise.all(SHOPS.map(async sh=>{
    if (isExpired(sh.expiry)) { map[sh.name]=0; return; }
    const col = collection(db, PAGE_KEY, "Shops", sh.name, "items");
    const snap = await getDocs(col);
    map[sh.name] = snap.size || 0;
  }));
  saveCache(CACHE.shops, map);
  return map;
}
function renderShopsGrid(countMap){
  shopsGrid.innerHTML = "";
  const list = SHOPS.filter(s=>!isExpired(s.expiry))
    .sort((a,b)=> (countMap[b.name]||0)-(countMap[a.name]||0) || a.name.localeCompare(b.name));
  list.forEach(shop=>{
    const card = document.createElement('article');
    card.className = "shop-card";
    card.style.backgroundImage = `url('${shop.heroImage}')`;
    const content = document.createElement('div');
    content.className = "content";
    content.innerHTML = `
      <div>
        <div class="shop-title">${escapeHtml(shop.name)}</div>
        <div class="shop-slogan">${escapeHtml(shop.slogan||'')}</div>
      </div>
      <div class="shop-lower">
        <p class="shop-meta">Items: ${countMap[shop.name]||0}</p>
        <button class="btn-enter" type="button">Enter Shop</button>
      </div>
    `;
    content.querySelector('.btn-enter').addEventListener('click', ()=> openShop(shop));
    card.appendChild(content);
    shopsGrid.appendChild(card);
  });
  if (!shopsGrid.children.length){
    shopsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No shops available.</p>`;
  }
}

/* ===== Drawer ===== */
const openDrawer = ()=>{
  drawer.classList.add('show');
  drawer.setAttribute('aria-hidden','false');
  document.getElementById('shopTopActions').style.display='flex';
};
const closeDrawer = ()=>{
  drawer.classList.remove('show');
  drawer.setAttribute('aria-hidden','true');
  document.getElementById('shopTopActions').style.display='none';
  hide(shopBanner); hide(shopGallery); hide(itemDetail); hide(catPage);

  // ✅ Hide BACK button when leaving category view
  catBackBtn.style.display = "none";
};
drawerClose.addEventListener('click', closeDrawer);
catBackBtn.addEventListener('click', () => closeDrawer());
/* slider */
function buildSlider(images, sliderEl, dotsEl){
  sliderEl.innerHTML=''; dotsEl.innerHTML='';
  if (!images || !images.length) images = ["https://via.placeholder.com/1000x600?text=Image"];
  images.forEach((src,i)=>{
    const img = document.createElement('img');
    img.src = src; img.alt = `image-${i+1}`; img.className = 'slide'+(i===0?' active':'');
    sliderEl.appendChild(img);
    const dot = document.createElement('div'); dot.className = 'dot'+(i===0?' active':'');
    dot.addEventListener('click', ()=> goTo(i)); dotsEl.appendChild(dot);
  });
  const left = document.createElement('div'); left.className='nav left'; left.innerHTML='&#10094;';
  const right= document.createElement('div'); right.className='nav right'; right.innerHTML='&#10095;';
  sliderEl.append(left,right);

  let current = 0;
  const slides = sliderEl.querySelectorAll('.slide');
  const dots = dotsEl.querySelectorAll('.dot');

  function setPos(prev,next,dir){
    const a=slides[prev], b=slides[next];
    b.style.transition='none'; b.style.left=(dir===1?'100%':'-100%'); b.style.opacity='1'; void b.offsetWidth;
    a.style.transition='left .45s ease, opacity .45s ease';
    b.style.transition='left .45s ease, opacity .45s ease';
    a.style.left=(dir===1?'-100%':'100%'); a.style.opacity='1'; b.style.left='0';
  }
  function goTo(n){
    if (n===current) return;
    const dir = n>current ? 1 : -1;
    setPos(current,n,dir);
    slides[current].classList.remove('active'); slides[n].classList.add('active');
    dots[current].classList.remove('active'); dots[n].classList.add('active');
    current=n;
  }
  left.addEventListener('click', ()=> goTo((current-1+slides.length)%slides.length));
  right.addEventListener('click',()=> goTo((current+1)%slides.length));
  let startX=0;
  sliderEl.addEventListener('touchstart', e=> startX=e.touches[0].clientX, {passive:true});
  sliderEl.addEventListener('touchend', e=>{
    const endX=e.changedTouches[0].clientX;
    if (startX-endX>40) right.click();
    if (endX-startX>40) left.click();
  }, {passive:true});
}

/* item detail */
function openItemDetail(ad){
  hide(shopBanner); hide(shopGallery); hide(catPage); show(itemDetail);
  buildSlider(ad.images||[], itemSlider, itemDots);
  detailTitle.textContent = ad.name||'Item';
  detailPrice.textContent = fmtPrice(ad.price);
  detailPostedBy.textContent = "Posted by " + (ad.shop||'');
  detailDesc.textContent = ad.desc||'';
  openDrawer();

  callBtn.onclick = ()=> captureNumberThenProceed('call', ad);
  waBtn.onclick   = ()=> captureNumberThenProceed('wa', ad);
  viewShopBtn.onclick = ()=>{
    jumpToAdId = ad.id || null;
    const shopObj = SHOPS.find(s=>s.name===ad.shop);
    if (shopObj) openShop(shopObj);
  };
}

/* shop gallery */
async function openShop(shop){
  currentShop = shop;
  currentShopName = shop.name;
  jumpToAdId = jumpToAdId || null;

  // hero banner
  shopBanner.style.backgroundImage = `url('${shop.heroImage}')`;
  shopNameEl.textContent = shop.name;
  shopSloganEl.textContent = shop.slogan || '';

  show(shopBanner); show(shopGallery); hide(itemDetail); hide(catPage);
openDrawer();

// ✅ Ensure hamburger and close icon are visible again for shop view
hamburgerBtn.style.display = "grid";
drawerClose.style.display = "grid";

hamburgerBtn.onclick = ()=> promptShopCode();

  await renderShopTabsAndItems(shop, jumpToAdId);
  jumpToAdId = null;
}
async function renderShopTabsAndItems(shop, focusAdId=null){
  const items = await fetchShopItems(shop.name);
  const byCat = {};
  items.forEach(it=>{
    const c = it.category||'Other'; (byCat[c]||(byCat[c]=[])).push(it);
  });

  shopTabs.innerHTML = "";
  const cats = Object.keys(byCat).sort((a,b)=> a.localeCompare(b));
  cats.forEach((c,i)=>{
    const btn = document.createElement('button');
    btn.className = 'main-tab'+(i===0?' active':''); btn.dataset.cat = c; btn.textContent = `${c} (${byCat[c].length})`;
    btn.addEventListener('click', ()=>{
      shopTabs.querySelectorAll('.main-tab').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      renderShopItems(byCat[c]);
    });
    shopTabs.appendChild(btn);
  });

  if (!cats.length){
    shopItemsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No items yet.</p>`;
    return;
  }
  const firstCat = focusAdId ? Object.keys(byCat).find(cat => (byCat[cat]||[]).some(it=> it.id===focusAdId)) : cats[0];
  shopTabs.querySelectorAll('.main-tab').forEach(b=> b.dataset.cat===firstCat && b.classList.add('active'));
  renderShopItems(byCat[firstCat], focusAdId);
}
function renderShopItems(list, focusAdId=null){
  shopItemsGrid.innerHTML='';
  list.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(ad=> renderItemCard(shopItemsGrid, ad));
  if (!list.length) shopItemsGrid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;">No items in this category.</p>`;
  if (focusAdId){
    const ad = list.find(x=> x.id===focusAdId);
    if (ad) openItemDetail(ad);
  }
}
async function fetchShopItems(shopName){
  const ck = CACHE.shopItems(shopName);
  const cached = loadCache(ck);
  if (cached) return cached;

  const col = collection(db, PAGE_KEY, "Shops", shopName, "items");
  const snap = await getDocs(col);
  const arr = [];
  snap.forEach(d=>{ const it = d.data(); it.id = d.id; arr.push(it); });
  arr.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  saveCache(ck, arr);
  return arr;
}

/* search (global quick filter) */
globalSearch.addEventListener('input', ()=>{
  const q = (globalSearch.value||'').trim().toLowerCase();

  // categories view
  if (categoriesView.classList.contains('show')){
    [...categoriesGrid.children].forEach(c=> c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  }
  // shops view
  if (shopsView.classList.contains('show')){
    [...shopsGrid.children].forEach(c=> c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  }
});

/* switch tabs */
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('active'); btn.setAttribute('aria-pressed','true');
    const target = btn.dataset.view;
    [categoriesView, shopsView].forEach(v=> v.classList.remove('show'));
    document.getElementById(target).classList.add('show');
    closeDrawer(); // leave drawer when switching
  });
});

/* ===== Modal helpers (single source of truth) ===== */
function openModal(m){ m.classList.add('show'); }
function closeModal(m){ m.classList.remove('show'); }

/* ===== Number capture + proceed ===== */
function openNumberModal(){ openModal(numberModal); }
function closeNumberModal(){ closeModal(numberModal); }
[numberClose, numberCancel].forEach(b=> b.addEventListener('click', closeNumberModal));

async function captureNumberThenProceed(kind, ad){
  pendingAction = kind;
  pendingContactFor = {
    shopName: ad.shop,
    phone: (SHOPS.find(s=>s.name===ad.shop)?.phone) || "",
    itemTitle: ad.name
  };
  waNumberInput.value = userPhoneCache || "";
  numberError.style.display = 'none';
  openNumberModal();
}
numberOk.addEventListener('click', async ()=>{
  const norm = normalizeGhanaNumber(waNumberInput.value);
  if (!norm){ numberError.textContent="Enter a valid WhatsApp number."; numberError.style.display='block'; return; }
  numberError.style.display='none';
  userPhoneCache = norm.e164;

  // Global numbers collection (dedup)
  await setDoc(doc(globalNums, norm.e164.replace(/[^\d+]/g,'')), { whatsapp:norm.e164, timestamp: serverTimestamp() }, { merge:true });

  // Per shop customers
  const shopName = pendingContactFor?.shopName;
  if (shopName){
    const custCol = collection(db, PAGE_KEY, "Shops", shopName, "customers");
    await setDoc(doc(custCol, norm.e164.replace(/[^\d+]/g,'')), { whatsapp:norm.e164, timestamp: serverTimestamp() }, { merge:true });
  }

  const shopPhone = pendingContactFor?.phone || "";
  if (pendingAction === 'call'){
    if (shopPhone) window.location.href = `tel:${shopPhone}`;
  }else{
    const waNum = shopPhone.replace(/^\+/,'');
    const msg = `Hello, I saw your item *${pendingContactFor?.itemTitle||''}* on PickMe (Tek&gaget).`;
    if (waNum) window.location.href = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
  }
  closeNumberModal();
});

/* ===== Admin: per-shop access ===== */
function promptShopCode(){
  codeInput.value = "";
  openModal(codeModal);
}
[codeClose, codeCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(codeModal)));
codeOk.addEventListener('click', ()=>{
  const input = codeInput.value.trim();
  const expected = (currentShop?.accessCode) || SHOP_ADMIN_DEFAULT_CODE;
  if (input && input === expected){
    closeModal(codeModal);
    openModal(adminOptionsModal);
  }else{
    alert("Incorrect code.");
  }
});
[adminOptClose, adminOptCancel].forEach(b=> b.addEventListener('click', ()=> closeModal(adminOptionsModal)));

/* ===== Admin: add items (UI simplified as requested) ===== */
optAdd.addEventListener('click', ()=>{
  closeModal(adminOptionsModal);
  catChooseGrid.innerHTML = "";
  CATEGORIES.forEach(({id})=>{
    const div = document.createElement('div');
    div.className = 'mopt-card';
    div.innerHTML = `<h4>${escapeHtml(id)}</h4>`;
    div.addEventListener('click', ()=> startAddFlow(id));
    catChooseGrid.appendChild(div);
  });
  openModal(catChooseModal);
});
[catChooseClose, catChooseCancel].forEach(b => b.addEventListener('click', () => {
  closeModal(catChooseModal);
  openModal(adminOptionsModal); // ✅ Return to Add/Delete modal
}));

let currentAddCategory = null;
function startAddFlow(category){
  currentAddCategory = category;
  closeModal(catChooseModal);
  openDraftEditor();
}
function openDraftEditor(){
  draftTitle.textContent = `Add items · ${currentAddCategory}`;
  resetForm();
  renderDraftList(); // show existing drafts (editable)
  openModal(draftModal);
}
draftClose.addEventListener('click', () => {
  closeModal(draftModal);
  openModal(catChooseModal); // ✅ Return to Choose Category after exiting Draft
});
addImagesBtn.addEventListener('click', ()=> imgInput.click());

function refreshThumbs(){
  imgThumbs.innerHTML = "";
  filesBuffer.forEach((file, idx)=>{
    const url = URL.createObjectURL(file);
    const t = document.createElement('div');
    t.className='thumb';
    t.innerHTML = `<img src="${url}" alt="img ${idx+1}"><button class="trash" title="Remove" aria-label="Remove">&times;</button>`;
    t.querySelector('.trash').addEventListener('click', ()=>{
      filesBuffer.splice(idx,1);
      refreshThumbs();
    });
    imgThumbs.appendChild(t);
  });
}
function resetForm(){
  imgInput.value=''; filesBuffer=[]; refreshThumbs();
  nameInput.value=''; priceInput.value=''; descInput.value='';
}
imgInput.addEventListener('change', ()=>{
  const list = Array.from(imgInput.files||[]);
  const wanted = Math.min(MAX_IMAGES - filesBuffer.length, list.length);
  filesBuffer.push(...list.slice(0, wanted));
  refreshThumbs();
});
clearFormBtn.addEventListener('click', resetForm);

function pushDraftFromForm(){
  const nm = nameInput.value.trim();
  const pr = money(priceInput.value);
  const ds = descInput.value.trim();
  if (!nm){ alert("Enter name"); return false; }
  if (!filesBuffer.length){ alert("Add at least 1 image"); return false; }
  const id = makeId();
  drafts.push({ id, cat: currentAddCategory, name:nm, price:pr, desc:ds, files:[...filesBuffer] });
  renderDraftList(); resetForm(); return true;
}

/* Editable drafts list (each previous item stays visible & editable) */
function renderDraftList(){
  draftList.innerHTML = "";
  drafts.forEach((d, i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'mopt-card';
    wrap.style.borderStyle = 'dashed';
    wrap.innerHTML = `
      <h4 style="margin:0 0 6px">#${i+1} · ${escapeHtml(d.cat)}</h4>
      <div class="row">
        <input class="input d-name" placeholder="Name" value="${escapeHtml(d.name)}" />
        <input class="input d-price" placeholder="Price" value="${escapeHtml(d.price)}" />
      </div>
      <textarea class="input d-desc" rows="2" placeholder="Description">${escapeHtml(d.desc||'')}</textarea>
      <div class="thumb-row d-thumbs"></div>
      <div class="row">
        <button class="btn-primary d-addimg" type="button">Add images</button>
        <button class="btn-secondary d-clearimg" type="button">Clear images</button>
        <button class="btn-secondary d-remove" type="button">Remove item</button>
      </div>
    `;
    const nameEl = wrap.querySelector('.d-name');
    const priceEl= wrap.querySelector('.d-price');
    const descEl = wrap.querySelector('.d-desc');
    const thumbs = wrap.querySelector('.d-thumbs');

    function drawThumbs(){
      thumbs.innerHTML='';
      d.files.forEach((f,idx)=>{
        const u = URL.createObjectURL(f);
        const t = document.createElement('div'); t.className='thumb';
        t.innerHTML = `<img src="${u}" alt=""><button class="trash" title="Remove">&times;</button>`;
        t.querySelector('.trash').onclick = ()=>{ d.files.splice(idx,1); drawThumbs(); };
        thumbs.appendChild(t);
      });
    }
    drawThumbs();

    nameEl.oninput = e=> d.name = e.target.value;
    priceEl.oninput= e=> d.price = e.target.value.replace(/[^\d.]/g,'');
    descEl.oninput = e=> d.desc  = e.target.value;

    // hidden file input per draft
    const hid = document.createElement('input');
    hid.type='file'; hid.accept='image/*'; hid.multiple=true; hid.style.display='none';
    wrap.appendChild(hid);
    wrap.querySelector('.d-addimg').onclick = ()=> hid.click();
    hid.onchange = ()=>{
      const list = Array.from(hid.files||[]);
      const space = MAX_IMAGES - d.files.length;
      d.files.push(...list.slice(0, space));
      drawThumbs();
    };
    wrap.querySelector('.d-clearimg').onclick = ()=>{ d.files=[]; drawThumbs(); };
    wrap.querySelector('.d-remove').onclick = ()=>{ drafts.splice(i,1); renderDraftList(); };

    draftList.appendChild(wrap);
  });
}

addMoreBtn.addEventListener('click', ()=>{ pushDraftFromForm(); });

/* Submitting drafts */
submitDraftsBtn.addEventListener('click', async ()=>{
  if (!drafts.length){
    const nm = nameInput.value.trim();
    if (nm) {
      const ok = pushDraftFromForm();
      if (!ok) return;
    }
  }

  const valid = drafts.filter(d => d.name && d.files && d.files.length>0);
  if (!valid.length){ alert("Nothing to submit."); return; }

  submitDraftsBtn.disabled = true;
  submitDraftsBtn.textContent = "Submitting…";
  toast("Submitting…");

  const payload = { type:"review", page:PAGE_KEY, shop: currentShopName, items: [] };

  for (const d of valid){
    const adId = d.id;
    const uploads = d.files.slice(0, MAX_IMAGES).map((f, idx)=>{
      const key = `${PAGE_KEY}/${currentShopName}/${adId}/img_${idx+1}.jpg`;
      const rf = sRef(st, key);
      return uploadBytes(rf, f).then(snap => getDownloadURL(sRef(st, snap.metadata.fullPath)));
    });
    const urls = await Promise.all(uploads);
    payload.items.push({ id: adId, category:d.cat, name:d.name, price:money(d.price), desc:d.desc, images:urls });
  }

  const linkId = await putShort(payload);

  // reset form & drafts
  closeModal(draftModal);
  drafts=[]; resetForm(); draftList.innerHTML="";
  submitDraftsBtn.disabled = false; submitDraftsBtn.textContent = "Submit";

  const link = `${location.origin}${location.pathname}?review=${linkId}`;
  const msg = `New Tek&gaget adverts from *${currentShopName}*.\nOpen: ${link}`;
  window.location.href = `https://wa.me/${PICKME_WHATSAPP}?text=${encodeURIComponent(msg)}`;

// ✅ After WhatsApp, show Choose Category modal again
setTimeout(() => {
  openModal(catChooseModal);
}, 500);
});

/* ===== Admin: delete items ===== */
optDelete.addEventListener('click', async ()=>{
  closeModal(adminOptionsModal);
  deleteList.innerHTML = "<p>Loading items…</p>";
  openModal(deleteModal);
  const items = await fetchShopItems(currentShopName);
  deleteList.innerHTML = "";
  if (!items.length){ deleteList.innerHTML = "<p>No items to delete.</p>"; return; }
  items.forEach(ad=>{
    const blk = document.createElement('div'); blk.className='mopt-card';
    blk.innerHTML = `
      <h4>${escapeHtml(ad.name||'Item')}</h4>
      <p>${escapeHtml(ad.category||'')}</p>
      <button class="btn-secondary">Delete</button>
    `;
    blk.querySelector('button').addEventListener('click', ()=> deleteAd(ad));
    deleteList.appendChild(blk);
  });
});
[deleteClose, deleteCancel].forEach(b => b.addEventListener('click', () => {
  closeModal(deleteModal);
  openModal(adminOptionsModal); // ✅ Return to Add/Delete
}));

async function deleteAd(ad){
  if (!confirm("Delete this item permanently?")) return;
  try{ await deleteDoc(doc(db, PAGE_KEY, "Shops", currentShopName, "items", ad.id)); }catch(e){ console.warn('delete doc',e); }
  try{
    const folder = sRef(st, `${PAGE_KEY}/${currentShopName}/${ad.id}/`);
    const listing = await listAll(folder);
    await Promise.all(listing.items.map(obj => deleteObject(obj)));
  }catch(e){ console.warn('delete images',e); }
  alert("Deleted.");
  closeModal(deleteModal);
  clearShopCaches(currentShopName);
  renderShops();
  if (currentShop) openShop(currentShop);
}

/* ===== Short links for review flow ===== */
async function getShort(id){
  const snap = await getDoc(doc(linksCol, id));
  return snap.exists() ? (snap.data()?.payload || null) : null;
}
async function putShort(payload){
  const id = makeId();
  await setDoc(doc(linksCol, id), { payload, createdAt: serverTimestamp() });
  return id;
}

/* ===== Review flow (PickMe admin) ===== */
function promptReviewCode(){
  openModal(reviewCodeModal);
}
[reviewCodeClose, reviewCodeCancel].forEach(b=> b.addEventListener('click', ()=>{
  reviewPayloadPending = null;
  closeModal(reviewCodeModal);
  closeDrawer();
  categoriesView.classList.add('show'); shopsView.classList.remove('show');
  document.body.classList.add('ready');
}));

reviewCodeOk.addEventListener('click', ()=>{
  if (reviewCodeInput.value.trim() !== GLOBAL_ADMIN_CODE){ alert('Incorrect admin code.'); return; }
  closeModal(reviewCodeModal);
  if (reviewPayloadPending) openReview(reviewPayloadPending);
});

async function openReview(payload){
  hide(shopBanner); show(itemDetail); hide(shopGallery); hide(catPage);
  buildSlider([], itemSlider, itemDots);
  detailTitle.textContent = "Review panel";
  detailPrice.textContent = "";
  detailPostedBy.textContent = payload.shop||"";
  detailDesc.textContent = "";

  const container = document.createElement('div');
  container.style.marginTop='8px';

  // Track states for each submitted item
  const states = []; // {id, approve:boolean, reason:string|null, data}

  // -------- LIST UI WITH TOGGLE (Default = Approved) --------
  payload.items.forEach((it, idx) => {
    const card = document.createElement('div');
    card.className = 'mopt-card';

    // images slider
    const holder = document.createElement('div');
    holder.style.marginBottom = '8px';
    const slider = document.createElement('div');
    slider.className = 'slider';
    const dots = document.createElement('div');
    dots.className = 'dots';
    holder.append(slider, dots);
    card.appendChild(holder);
    buildSlider(it.images || [], slider, dots);

    // meta
    const meta = document.createElement('div');
    meta.innerHTML = `
      <h4 style="margin:8px 0 4px">#${idx + 1} ${escapeHtml(it.name)}</h4>
      <div>${escapeHtml(it.category || '')}</div>
      <div>${fmtPrice(it.price)}</div>
    `;
    card.appendChild(meta);

    // Default approved
    const st = { id: it.id, approve: true, reason: null, data: it };
    states.push(st);

    // Single Toggle Button (default shows "Reject" meaning currently Approved)
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'btn-secondary';
    toggleBtn.textContent = 'Reject';
    toggleBtn.style.marginTop = '8px';

    // Reason box (only visible when rejected)
    const rejectBox = document.createElement('div');
    rejectBox.style.display = 'none';
    rejectBox.style.marginTop = '8px';
    rejectBox.innerHTML = `
      <div class="row">
        <select class="input reasonSel">
          <option value="">Select reason</option>
          <option>Inappropriate content</option>
          <option>Wrong price</option>
          <option>Poor image quality</option>
          <option>Duplicate listing</option>
          <option>Other</option>
        </select>
        <input class="input otherTxt" placeholder="Write custom reason (if Other)">
      </div>
    `;

    toggleBtn.onclick = () => {
      st.approve = !st.approve;
      if (st.approve) {
        toggleBtn.textContent = 'Reject';
        toggleBtn.className = 'btn-secondary';
        rejectBox.style.display = 'none';
        st.reason = null;
      } else {
        toggleBtn.textContent = 'Approve';
        toggleBtn.className = 'btn-primary';
        rejectBox.style.display = 'block';
      }
    };

    rejectBox.querySelector('.reasonSel').addEventListener('change', e => {
      const val = e.target.value;
      const otherTxt = rejectBox.querySelector('.otherTxt');
      if (val === 'Other') {
        otherTxt.style.display = 'block';
        st.reason = otherTxt.value.trim() || 'Rejected';
      } else {
        otherTxt.style.display = val ? 'none' : 'none';
        st.reason = val || 'Rejected';
      }
    });

    rejectBox.querySelector('.otherTxt').addEventListener('input', e => {
      if (!st.approve) {
        st.reason = e.target.value.trim() || 'Rejected';
      }
    });

    card.appendChild(toggleBtn);
    card.appendChild(rejectBox);
    container.appendChild(card);
  });

  // -------- SUBMIT BUTTON --------
  const done = document.createElement('button');
  done.className = 'btn-primary';
  done.style.marginTop = '10px';
  done.textContent = 'Submit Review';

  // Utility: turn a remote image URL into a data: URL so results can show after deletion
  async function urlToDataURL(url){
    try{
      const res = await fetch(url, { cache: 'no-store' });
      const blob = await res.blob();
      return await new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }catch(e){
      console.warn('urlToDataURL failed for', url, e);
      return null;
    }
  }

  done.onclick = async ()=>{
    // Collect decisions
    const approved = states.filter(s=>s.approve === true).map(s=>s.data);
    const rejectedStates = states.filter(s=>s.approve === false);

    if (!approved.length && !rejectedStates.length){
      alert("Please approve or reject at least one item before submitting.");
      return;
    }

    // Disable button to prevent double-click
    done.disabled = true;
    done.textContent = "Submitting…";

    // ---------- SAVE APPROVED ITEMS (Firestore) ----------
    let saveErrors = [];
    for (const it of approved){
      try{
        const rec = {
          id: it.id,
          shop: payload.shop,
          category: it.category || 'Other',
          name: it.name || '',
          price: Number(it.price || 0),
          desc: it.desc || '',
          images: Array.isArray(it.images) ? it.images : [],
          createdAt: serverTimestamp()
        };
        const ref = doc(db, PAGE_KEY, "Shops", payload.shop, "items", it.id);
        await setDoc(ref, rec, { merge: true });
      }catch(e){
        console.error('Save approved failed for', it.id, e);
        saveErrors.push(it.id);
      }
    }

    // ---------- PREP REJECTED: CAPTURE IMAGES AS DATA URLS, THEN DELETE FROM STORAGE ----------
    const rejected = [];
    for (const stRec of rejectedStates){
      const it = stRec.data;
      const imgs = Array.isArray(it.images) ? it.images : [];
      const localImages = [];
      for (const u of imgs){
        const d = await urlToDataURL(u);
        if (d) localImages.push(d);
      }

      try{
        const folder = sRef(st, `${PAGE_KEY}/${payload.shop}/${it.id}/`);
        const listing = await listAll(folder);
        await Promise.all(listing.items.map(obj => deleteObject(obj)));
      }catch(e){
        console.warn('Delete rejected images failed for', it.id, e);
      }

      rejected.push({
        ...it,
        reason: stRec.reason || 'Rejected',
        localImages
      });
    }

    // ---------- MAKE RESULT SHORTLINK ----------
    const result = { type:'result', page:PAGE_KEY, shop:payload.shop, approved, rejected };
    const id2 = await putShort(result);

    // ---------- CLEAR CACHES THEN REFRESH SHOPS & CATEGORIES SILENTLY ----------
    clearShopCaches(payload.shop);
    await renderShops();
    await renderCategories();

    // ---------- WhatsApp notify shop owner ----------
    const shopPhone = (SHOPS.find(s=>s.name === payload.shop)?.phone) || "";
    const link = `${location.origin}${location.pathname}?result=${id2}`;
    const msg = `Your Tek&gaget adverts were reviewed.\nOpen results: ${link}`;
    if (shopPhone) {
      window.location.href = `https://wa.me/${shopPhone.replace(/^\+/,'')}?text=${encodeURIComponent(msg)}`;
    } else {
      alert("Result link:\n" + link);
    }

    // If any approved item failed to save, let admin know (but we still proceed)
    if (saveErrors.length){
      alert("Some approved items failed to save: " + saveErrors.join(', '));
    }

    // ---------- AUTO-OPEN SHOP WITH CATEGORY SELECTED ----------
    const firstApproved = approved[0] || null;
    closeDrawer();
    toast("Review submitted.");

    if(firstApproved){
      const shopObj = SHOPS.find(s=>s.name===payload.shop);
      if (shopObj){
        jumpToAdId = firstApproved.id;
        currentCategory = firstApproved.category;
        openShop(shopObj);
      }
    }
  };

  const containerHost = itemDetail.querySelector('.item-detail');
  containerHost.innerHTML = '';
  const title = document.createElement('div');
  title.className = 'section-title';
  title.textContent = `Review · ${payload.shop}`;
  containerHost.append(title, container, done);

  openDrawer();
}

/* ===== Result view (shop owner) ===== */
async function openResult(payload){
  hide(shopBanner); show(itemDetail); hide(shopGallery); hide(catPage);
  itemSlider.innerHTML=''; itemDots.innerHTML='';
  detailTitle.textContent = "Submission results";
  detailPrice.textContent = "";
  detailPostedBy.textContent = payload.shop || "";
  detailDesc.textContent = "";

  const host = itemDetail.querySelector('.item-detail');
  host.innerHTML = '';

  // ---- Approved ----
  const secA = document.createElement('div');
  secA.innerHTML = `<div class="section-title">Approved</div>`;
  const listA = document.createElement('div');
  listA.className = 'items-grid';
  (payload.approved || []).forEach(ad=> renderItemCard(listA, ad));
  if (!(payload.approved || []).length) listA.innerHTML = "<p>No approved items.</p>";
  secA.appendChild(listA);

  // ---- Rejected (show embedded images if present) ----
  const secR = document.createElement('div');
  secR.style.marginTop = '10px';
  secR.innerHTML = `<div class="section-title">Rejected</div>`;
  const listR = document.createElement('div');
  listR.className = 'items-grid';
  (payload.rejected || []).forEach(ad=>{
    const imgs = (ad.localImages && ad.localImages.length) ? ad.localImages : (ad.images || []);
    const first = imgs[0] || 'https://via.placeholder.com/600x400?text=Image';
    const card = document.createElement('div');
    card.className='item-card';
    card.innerHTML = `
      <div class="item-img"><img src="${first}" alt=""></div>
      <div class="item-body">
        <div class="item-price">${fmtPrice(ad.price)}</div>
        <div class="item-desc">${escapeHtml(ad.desc || '')}</div>
        <div class="item-shop">Reason: ${escapeHtml(ad.reason || '')}</div>
      </div>
    `;
    listR.appendChild(card);
  });
  if (!(payload.rejected || []).length) listR.innerHTML = "<p>No rejected items.</p>";
  secR.appendChild(listR);

  const done = document.createElement('button');
  done.className = 'btn-primary';
  done.style.marginTop = '10px';
  done.textContent = 'Done';
  done.onclick = ()=> closeDrawer();

  host.append(secA, secR, done);
  openDrawer();
}

/* ===== Router ===== */
async function router(){
  const url = new URL(location.href);
  const reviewId = url.searchParams.get('review');
  const resultId = url.searchParams.get('result');

  document.body.classList.remove('ready');
  document.body.classList.add('hide-initial');

  try{
    if (reviewId){
      const payload = await getShort(reviewId);
      if (!payload || payload.type!=='review'){ alert("Invalid review link."); }
      else{
        reviewPayloadPending = payload;
        promptReviewCode();
        document.body.classList.remove('hide-initial');
        document.body.classList.add('ready');
        return;
      }
    }
    if (resultId){
      const payload = await getShort(resultId);
      if (!payload || payload.type!=='result'){ alert("Invalid result link."); }
      else{
        await openResult(payload);
        document.body.classList.remove('hide-initial');
        document.body.classList.add('ready');
        return;
      }
    }

    // Default home
    categoriesView.classList.add('show');
    shopsView.classList.remove('show');
    document.querySelector('.main-tab[data-view="categoriesView"]').classList.add('active');
    document.querySelector('.main-tab[data-view="categoriesView"]').setAttribute('aria-pressed','true');
    document.querySelector('.main-tab[data-view="shopsView"]').classList.remove('active');
    document.querySelector('.main-tab[data-view="shopsView"]').setAttribute('aria-pressed','false');
    document.body.classList.remove('hide-initial');
    document.body.classList.add('ready');
  } catch(e){
    console.error('[router]', e);
    document.body.classList.remove('hide-initial');
    document.body.classList.add('ready');
  }
}

/* ===== Init ===== */
async function renderCategories(){ const counts = await countByCategory().catch(()=>({})); renderCategoriesGrid(counts); }
async function renderShops(){ const counts = await fetchShopCounts().catch(()=>{ const m={}; SHOPS.forEach(s=>m[s.name]=0); return m; }); renderShopsGrid(counts); }

document.addEventListener('DOMContentLoaded', async ()=>{
  await renderCategories();
  await renderShops();
  router();
});

/* Immediate fallback draw for shops (avoid empty screen on slow network) */
const fb = {}; SHOPS.forEach(s=> fb[s.name]=0); renderShopsGrid(fb);

</script>

<!-- ===================== FOOTER ===================== -->
<div class="footer-wrap" role="contentinfo" aria-label="Footer">
  <iframe src="footer.html" style="width:100%;height:60px;border:none;overflow:hidden" scrolling="no" title="Footer"></iframe>
</div>

</body>
</html>
